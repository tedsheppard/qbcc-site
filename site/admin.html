<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Sopal â€“ Admin Hub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="assets/favicon.ico" type="image/x-icon">
  <style>
    body { font-family: Inter, sans-serif; margin: 0; background: #f8f9fa; color: #333; font-size: 14px; }
    .header { background: #fdfdfd; padding: 20px 25px; border-bottom: 1px solid #ddd; }
    .header-content { display: flex; align-items: center; max-width: 1400px; margin: 0 auto; }
    .logo { height: 31px; }
    main { max-width: 1400px; margin: 40px auto; padding: 0 25px; }
    h1 { font-size: 28px; margin-bottom: 30px; }
    .admin-container { display: flex; gap: 30px; }
    .admin-nav { flex: 0 0 200px; }
    .admin-nav .nav-btn { display: block; width: 100%; text-align: left; padding: 12px 15px; border: none; background: none; border-radius: 6px; cursor: pointer; font-size: 15px; margin-bottom: 5px; }
    .admin-nav .nav-btn.active { background-color: #e8f8f1; color: #008a5c; font-weight: 600; }
    .admin-content { flex: 1; }
    .admin-section { display: none; }
    .admin-section.active { display: block; }
    .card { background: #fdfdfd; border: 1px solid #ddd; border-radius: 8px; padding: 30px; }
    h2 { font-size: 22px; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 25px; }
    table { width: 100%; border-collapse: collapse; font-size: 12px; }
    th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; vertical-align: top; }
    th { background-color: #f8f9fa; font-weight: 600; }
    .error-message { color: #dc3545; font-weight: bold; }
    .loading-message { color: #666; }
    .status-badge { padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: 600; color: white; }
    .status-true { background-color: #dc3545; }
    .status-false { background-color: #28a745; }
    .form-inline { display: flex; gap: 10px; margin-bottom: 20px; }
    .form-inline input { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
    .form-inline button { background: #00c97c; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; font-weight: 600; }
  </style>
</head>
<body>

<div class="header">
  <div class="header-content">
    <a href="/"><img src="assets/sopal_logo_v1.png" alt="SOPAL" class="logo"></a>
  </div>
</div>

<main>
  <h1>Admin Hub</h1>
  <div class="admin-container">
    <aside class="admin-nav">
      <button class="nav-btn" data-hash="users">User Accounts</button>
      <button class="nav-btn" data-hash="searches">Search Activity</button>
      <button class="nav-btn" data-hash="adjudicators">Adjudicator Activity</button>
      <button class="nav-btn" data-hash="fullaccess">Full Access Privileges</button> </aside>
    <div class="admin-content">
      <section id="users-section" class="admin-section">
        <div class="card">
          <h2>Account Creation Activity</h2>
          <div id="users-table-container" style="overflow-x: auto;"></div>
        </div>
      </section>

      <section id="searches-section" class="admin-section">
        <div class="card">
          <h2>Latest 1000 Searches</h2>
          <div id="searches-table-container" style="overflow-x: auto;"></div>
        </div>
      </section>

      <section id="adjudicators-section" class="admin-section">
        <div class="card">
          <h2>Latest 1000 Adjudicator Page Views</h2>
          <div id="adjudicators-table-container" style="overflow-x: auto;"></div>
        </div>
      </section>

      <section id="fullaccess-section" class="admin-section">
        <div class="card">
          <h2>Manage Full Access Users</h2>
          <p style="color: #666; margin-top: -15px; margin-bottom: 20px;">Users added here will have free access to all adjudicator insights.</p>
          <div id="fullaccess-container"></div>
        </div>
      </section>

    </div>
  </div>
</main>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const token = localStorage.getItem('purchase_token');

    function formatAEST(isoString) {
        if (!isoString) return 'N/A';
        try {
            const utcDateString = isoString.replace(' ', 'T') + 'Z';
            const date = new Date(utcDateString);
            return date.toLocaleString('en-AU', {
                timeZone: 'Australia/Sydney',
                year: 'numeric', month: 'short', day: 'numeric',
                hour: '2-digit', minute: '2-digit',
                hour12: true
            });
        } catch (e) { return isoString; }
    }

    const navButtons = document.querySelectorAll('.admin-nav .nav-btn');
    const sections = document.querySelectorAll('.admin-section');
    const dataLoaded = new Set();

    function showTab(hash) {
        const targetHash = hash.substring(1);
        navButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.hash === targetHash));
        sections.forEach(section => section.classList.toggle('active', section.id.replace('-section', '') === targetHash));

        if (!dataLoaded.has(targetHash)) {
            switch (targetHash) {
                case 'users': fetchUsers(); break;
                case 'searches': fetchSearches(); break;
                case 'adjudicators': fetchAdjudicatorActivity(); break;
                case 'fullaccess': fetchFullAccessUsers(); break; // ADDED
            }
            dataLoaded.add(targetHash);
        }
    }

    navButtons.forEach(button => button.addEventListener('click', () => window.location.hash = button.dataset.hash));
    window.addEventListener('hashchange', () => showTab(window.location.hash || '#users'));
    
    if (!token) {
        document.querySelector('main').innerHTML = '<p class="error-message">Access Denied. Please log in as an admin.</p>';
        return;
    }

    async function fetchData(url, containerId, renderer) {
        const container = document.getElementById(containerId);
        container.innerHTML = '<p class="loading-message">Loading data...</p>';
        try {
            const response = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
            if (!response.ok) throw new Error(`Failed to fetch data (status: ${response.status})`);
            const data = await response.json();
            renderer(data);
        } catch (error) {
            container.innerHTML = `<p class="error-message">${error.message}</p>`;
        }
    }

    const fetchUsers = () => fetchData('/admin/all-users', 'users-table-container', renderUsersTable);
    const fetchSearches = () => fetchData('/admin/search-activity', 'searches-table-container', renderSearchesTable);
    const fetchAdjudicatorActivity = () => fetchData('/admin/adjudicator-activity', 'adjudicators-table-container', renderAdjudicatorActivityTable);
    const fetchFullAccessUsers = () => fetchData('/admin/full-access-users', 'fullaccess-container', renderFullAccessUsers); // ADDED

    function renderUsersTable(users) {
        const container = document.getElementById('users-table-container');
        if (!users || users.length === 0) { container.innerHTML = '<p>No user accounts created yet.</p>'; return; }
        let tableHTML = `<table><thead><tr><th>ID</th><th>Email</th><th>Name</th><th>Firm</th><th>Created (AEST)</th><th>Last Login (AEST)</th></tr></thead><tbody>`;
        users.forEach(user => {
            tableHTML += `<tr><td>${user.id}</td><td>${user.email||''}</td><td>${user.first_name||''} ${user.last_name||''}</td><td>${user.firm_name||''}</td><td>${formatAEST(user.created_at)}</td><td>${user.last_login ? formatAEST(user.last_login) : 'Never'}</td></tr>`;
        });
        container.innerHTML = tableHTML + '</tbody></table>';
    }

    function renderSearchesTable(searches) {
        const container = document.getElementById('searches-table-container');
        if (!searches || searches.length === 0) { container.innerHTML = '<p>No search activity logged yet.</p>'; return; }
        let tableHTML = `<table><thead><tr><th>Timestamp (AEST)</th><th>User Email</th><th>Search Query</th><th>Blocked</th></tr></thead><tbody>`;
        searches.forEach(search => {
            const blockedStatus = search.was_blocked ? '<span class="status-badge status-true">Yes</span>' : '<span class="status-badge status-false">No</span>';
            tableHTML += `<tr><td>${formatAEST(search.timestamp)}</td><td>${search.user_email || 'Anonymous'}</td><td>${search.search_query}</td><td>${blockedStatus}</td></tr>`;
        });
        container.innerHTML = tableHTML + '</tbody></table>';
    }
    
    function renderAdjudicatorActivityTable(views) {
        const container = document.getElementById('adjudicators-table-container');
        if (!views || views.length === 0) { container.innerHTML = '<p>No adjudicator page views logged yet.</p>'; return; }
        let tableHTML = `<table><thead><tr><th>Timestamp (AEST)</th><th>User Email</th><th>Adjudicator Viewed</th></tr></thead><tbody>`;
        views.forEach(view => {
            tableHTML += `<tr><td>${formatAEST(view.timestamp)}</td><td>${view.user_email || 'Anonymous'}</td><td>${view.adjudicator_name}</td></tr>`;
        });
        container.innerHTML = tableHTML + '</tbody></table>';
    }

    // --- NEW RENDERING & EVENT HANDLER FUNCTIONS ---
    function renderFullAccessUsers(users) {
        const container = document.getElementById('fullaccess-container');
        let contentHTML = `
            <div id="fullaccess-feedback" style="margin-bottom: 15px;"></div>
            <div class="form-inline">
                <input type="email" id="add-email-input" placeholder="Enter user's email address">
                <button id="add-email-btn">Add User</button>
            </div>
            <table>
                <thead><tr><th>Email Address</th><th>Date Added (AEST)</th><th>Action</th></tr></thead>
                <tbody>
        `;
        if (users && users.length > 0) {
            users.forEach(user => {
                contentHTML += `
                    <tr>
                        <td>${user.email}</td>
                        <td>${formatAEST(user.added_at)}</td>
                        <td><button class="remove-btn" data-email="${user.email}" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">Remove</button></td>
                    </tr>
                `;
            });
        } else {
            contentHTML += `<tr><td colspan="3" style="text-align:center; padding: 20px; color: #666;">No users currently have full access.</td></tr>`;
        }
        container.innerHTML = contentHTML + '</tbody></table>';

        document.getElementById('add-email-btn').addEventListener('click', handleAddFullAccess);
        document.querySelectorAll('.remove-btn').forEach(btn => btn.addEventListener('click', handleRemoveFullAccess));
    }
    
    async function handleAddFullAccess() {
        const emailInput = document.getElementById('add-email-input');
        const email = emailInput.value.trim();
        if (!email) return;

        const formData = new FormData();
        formData.append('email', email);

        const response = await fetch('/admin/add-full-access', { method: 'POST', headers: { 'Authorization': `Bearer ${token}` }, body: formData });
        const data = await response.json();
        const feedbackDiv = document.getElementById('fullaccess-feedback');

        if (response.ok) {
            feedbackDiv.style.color = '#155724';
            emailInput.value = '';
            fetchFullAccessUsers();
        } else {
            feedbackDiv.style.color = '#721c24';
        }
        feedbackDiv.textContent = data.detail || data.message;
    }

    async function handleRemoveFullAccess(event) {
        const email = event.target.dataset.email;
        if (!confirm(`Are you sure you want to revoke full access for ${email}?`)) return;

        const formData = new FormData();
        formData.append('email', email);
        
        await fetch('/admin/remove-full-access', { method: 'POST', headers: { 'Authorization': `Bearer ${token}` }, body: formData });
        fetchFullAccessUsers();
    }

    showTab(window.location.hash || '#users');
});
</script>

</body>
</html>