<!doctype html>
<html lang="en">
<head>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-QEN3X3DQLR"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-QEN3X3DQLR');
  </script>
  <link rel="icon" href="assets/favicon.ico" type="image/x-icon">
  <link rel="shortcut icon" href="assets/favicon.ico" type="image/x-icon">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
  <meta charset="utf-8">
  <title>Sopal – Payment Setup</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body {
    font-family: "Manrope", sans-serif;
    margin: 0;
    background: #f8f9fa;
    color: #333;
    font-size: 14px;
    line-height: 1.6;
  }
  h1, h2, h3, h4, h5, h6 {
    font-family: "Space Grotesk", sans-serif;
    letter-spacing: -0.02em;
  }
  .header {
    background: #fdfdfd;
    padding: 20px 25px;
    border-bottom: 1px solid #ddd;
    position: sticky;
    top: 0;
    z-index: 100;
  }
  .header-content {
    display: flex;
    align-items: center;
    max-width: 1200px;
    margin: 0 auto;
  }
  .logo { height: 31px; margin-right: 20px; }
  .nav-links {
    margin-left: auto;
    display: flex;
    gap: 20px;
  }
  .nav-links a {
    color: black;
    text-decoration: none;
    font-size: 14px;
    transition: color 0.2s;
  }
  .nav-links a:hover { color: #00c97c; }
  .nav-links a.active { color: #008a5c; font-weight: 600; }

  #user-profile-nav { margin-left: 20px; position: relative; }

  main {
    max-width: 700px;
    margin: 40px auto;
    padding: 0 25px;
  }

  .back-link {
    display: inline-block;
    margin-bottom: 20px;
    color: #008a5c;
    font-weight: 600;
    text-decoration: none;
    font-size: 14px;
  }
  .back-link:hover { text-decoration: underline; }

  .page-title {
    font-size: 26px;
    margin-bottom: 6px;
  }
  .page-subtitle {
    color: #666;
    font-size: 15px;
    margin-bottom: 30px;
  }

  /* Plan summary */
  .plan-summary {
    background: #e8f8f1;
    border: 1px solid #00c97c;
    border-radius: 8px;
    padding: 20px 25px;
    margin-bottom: 30px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .plan-summary-left strong { font-size: 16px; }
  .plan-summary-left p { margin: 4px 0 0; color: #555; font-size: 13px; }
  .plan-summary-right {
    font-size: 22px;
    font-weight: 700;
    color: #008a5c;
  }

  /* Payment method toggle */
  .method-toggle {
    display: flex;
    gap: 15px;
    margin-bottom: 30px;
  }
  .method-option {
    flex: 1;
    background: #fdfdfd;
    border: 2px solid #ddd;
    border-radius: 10px;
    padding: 20px;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
  }
  .method-option:hover { border-color: #00c97c; }
  .method-option.selected {
    border-color: #00c97c;
    background: #f0fdf7;
    box-shadow: 0 2px 10px rgba(0,201,124,0.12);
  }
  .method-option h4 {
    margin: 0 0 6px;
    font-size: 16px;
  }
  .method-option p {
    margin: 0;
    color: #666;
    font-size: 13px;
  }

  /* Stripe section */
  .payment-section {
    display: none;
  }
  .payment-section.active {
    display: block;
  }

  .stripe-section {
    background: #fdfdfd;
    border: 1px solid #ddd;
    border-radius: 10px;
    padding: 30px;
  }
  .stripe-section p.intro {
    color: #555;
    margin: 0 0 20px;
    font-size: 14px;
  }
  .stripe-logos {
    display: flex;
    justify-content: center;
    gap: 12px;
    margin-bottom: 20px;
    font-size: 13px;
    color: #888;
  }
  .card-badge {
    background: #f0f0f0;
    padding: 4px 10px;
    border-radius: 4px;
    font-weight: 500;
    color: #555;
  }
  #card-element {
    padding: 15px;
    border: 1px solid #ccc;
    border-radius: 6px;
    margin-bottom: 12px;
    background: white;
  }
  #card-errors {
    color: #dc3545;
    font-size: 13px;
    margin-bottom: 15px;
    min-height: 20px;
  }
  .secure-note {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    font-size: 12px;
    color: #999;
    margin-top: 15px;
  }

  /* Invoice form */
  .invoice-section {
    background: #fdfdfd;
    border: 1px solid #ddd;
    border-radius: 10px;
    padding: 30px;
  }
  .invoice-section p.intro {
    color: #555;
    margin: 0 0 20px;
    font-size: 14px;
  }
  .form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
  }
  .form-group {
    margin-bottom: 15px;
  }
  .form-group.full-width {
    grid-column: 1 / -1;
  }
  .form-group label {
    display: block;
    margin-bottom: 6px;
    font-weight: 500;
    color: #555;
    font-size: 13px;
  }
  .form-group input,
  .form-group textarea,
  .form-group select {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-size: 14px;
    box-sizing: border-box;
    font-family: inherit;
  }
  .form-group textarea { resize: vertical; min-height: 60px; }
  .form-group input:focus,
  .form-group textarea:focus,
  .form-group select:focus {
    outline: none;
    border-color: #00c97c;
  }
  .form-group input:disabled,
  .form-group select:disabled {
    background: #f0f0f0;
    color: #999;
    cursor: not-allowed;
  }
  .checkbox-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 6px;
  }
  .checkbox-row input[type="checkbox"] {
    width: auto;
    margin: 0;
    accent-color: #00c97c;
  }
  .checkbox-row label {
    margin: 0;
    font-size: 13px;
    color: #666;
    font-weight: 400;
  }

  .btn {
    display: block;
    width: 100%;
    background: #00c97c;
    color: white;
    border: none;
    padding: 14px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 600;
    transition: background-color 0.2s;
    text-align: center;
    box-sizing: border-box;
  }
  .btn:hover { background: #00a568; }
  .btn:disabled { background: #ccc; cursor: not-allowed; }

  .feedback-msg {
    padding: 12px 16px;
    border-radius: 6px;
    margin-bottom: 15px;
    display: none;
    font-size: 14px;
  }
  .feedback-msg.error {
    display: block;
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
  }
  .feedback-msg.success {
    display: block;
    background: #e8f8f1;
    color: #006644;
    border: 1px solid #00c97c;
  }

  .footer {
    background: #fcfcfc;
    color: #333;
    padding: 30px 25px 15px;
    margin-top: 60px;
    border-top: 1px solid #ddd;
  }
  .footer-content {
    display: flex;
    justify-content: space-between;
    max-width: 700px;
    margin: auto;
  }
  .footer-left { max-width: 300px; }
  .footer-logo { height: 24px; margin-bottom: 10px; }
  .footer-links {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px 30px;
  }
  .footer-links a { font-size: 13px; color: #333; text-decoration: none; }
  .footer-links a:hover { color: #00c97c; }
  .footer-bottom {
    text-align: center;
    border-top: 1px solid #eee;
    margin-top: 20px;
    padding-top: 15px;
    font-size: 0.85em;
    color: #666;
    max-width: 700px;
    margin-left: auto;
    margin-right: auto;
  }

  @media (max-width: 768px) {
    .header-content { flex-direction: column; gap: 16px; }
    .nav-links { margin: 0; flex-wrap: wrap; justify-content: center; }
    .method-toggle { flex-direction: column; }
    .form-grid { grid-template-columns: 1fr; }
    .plan-summary { flex-direction: column; gap: 10px; text-align: center; }
    .footer-content { flex-direction: column; align-items: center; text-align: center; gap: 20px; }
  }
</style>
</head>
<body>

<div class="header">
  <div class="header-content">
    <a href="/">
      <img src="assets/sopal_logo_v1.png" alt="SOPAL" class="logo">
    </a>
    <div class="nav-links">
      <a href="decision-search">Search</a>
      <a href="adjudicators">Adjudicators</a>
      <a href="interest-calculator">Interest Calculator</a>
      <a href="due-date-calculator">Due Date Calculator</a>
      <a href="pricing">Pricing</a>
      <a href="feedback">Feedback</a>
    </div>
    <div id="user-profile-nav"></div>
  </div>
</div>

<main>
  <a href="/pricing" class="back-link">&larr; Back to Pricing</a>

  <h1 class="page-title">Set Up Payment</h1>
  <p class="page-subtitle">Choose how you'd like to pay for your subscription.</p>

  <!-- Plan summary bar -->
  <div class="plan-summary" id="plan-summary">
    <div class="plan-summary-left">
      <strong id="summary-plan-name">—</strong>
      <p id="summary-plan-detail"></p>
    </div>
    <div class="plan-summary-right" id="summary-price">—</div>
  </div>

  <!-- Payment method choice -->
  <div class="method-toggle">
    <div class="method-option selected" id="opt-stripe" onclick="selectMethod('stripe')">
      <h4>Credit / Debit Card</h4>
      <p>Pay instantly via Stripe</p>
    </div>
    <div class="method-option" id="opt-invoice" onclick="selectMethod('invoice')">
      <h4>Pay by Invoice</h4>
      <p>Request an invoice for your firm</p>
    </div>
  </div>

  <!-- Stripe payment -->
  <div class="payment-section active" id="section-stripe">
    <div class="stripe-section">
      <p class="intro">Enter your card details below to start your subscription.</p>
      <div class="stripe-logos">
        <span class="card-badge">Visa</span>
        <span class="card-badge">Mastercard</span>
        <span class="card-badge">Amex</span>
      </div>
      <form id="stripe-form">
        <div id="card-element"></div>
        <div id="card-errors" role="alert"></div>
        <div id="stripe-feedback" class="feedback-msg"></div>
        <button type="submit" class="btn" id="stripe-btn">Process Payment</button>
      </form>
      <div class="secure-note">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#999" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
        Payments processed securely by Stripe
      </div>
    </div>
  </div>

  <!-- Invoice payment -->
  <div class="payment-section" id="section-invoice">
    <div class="invoice-section">
      <p class="intro">Fill in your firm's billing details below. We'll review your request and activate your access within 1-2 business days.</p>

      <form id="invoice-form">
        <div class="form-grid">
          <!-- Firm details -->
          <div class="form-group">
            <label for="inv-firm">Firm / Company Name *</label>
            <input type="text" id="inv-firm" required>
          </div>
          <div class="form-group">
            <label for="inv-firm-type">Firm Type *</label>
            <select id="inv-firm-type" required>
              <option value="">Select</option>
              <option value="Sole Practitioner">Sole Practitioner</option>
              <option value="Partnership">Partnership</option>
              <option value="Proprietary Limited">Proprietary Limited</option>
              <option value="Limited">Limited</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label for="inv-abn">ABN *</label>
            <input type="text" id="inv-abn" required placeholder="e.g. 12 345 678 901">
          </div>
          <div class="form-group">
            <label for="inv-acn">ACN <span id="acn-required-star">*</span></label>
            <input type="text" id="inv-acn" placeholder="e.g. 123 456 789" disabled>
          </div>

          <!-- Key contacts -->
          <div class="form-group full-width">
            <label for="inv-partner">Partner / Director's Name *</label>
            <input type="text" id="inv-partner" required>
          </div>
          <div class="form-group full-width">
            <label for="inv-accounts-contact">Accounts Contact Name *</label>
            <input type="text" id="inv-accounts-contact" required>
            <div class="checkbox-row">
              <input type="checkbox" id="inv-same-as-partner">
              <label for="inv-same-as-partner">Same as Partner / Director</label>
            </div>
          </div>
          <div class="form-group">
            <label for="inv-accounts-email">Accounts / Billing Email *</label>
            <input type="email" id="inv-accounts-email" required placeholder="accounts@yourfirm.com.au">
          </div>
          <div class="form-group">
            <label for="inv-phone">Accounts Phone Number *</label>
            <input type="tel" id="inv-phone" required placeholder="e.g. 07 3000 0000">
          </div>

          <!-- Billing address -->
          <div class="form-group full-width">
            <label for="inv-address">Billing Street Address *</label>
            <input type="text" id="inv-address" required>
          </div>
          <div class="form-group">
            <label for="inv-city">City *</label>
            <input type="text" id="inv-city" required>
          </div>
          <div class="form-group">
            <label for="inv-state">State *</label>
            <select id="inv-state" required>
              <option value="">Select</option>
              <option value="QLD">QLD</option>
              <option value="NSW">NSW</option>
              <option value="VIC">VIC</option>
              <option value="SA">SA</option>
              <option value="WA">WA</option>
              <option value="TAS">TAS</option>
              <option value="NT">NT</option>
              <option value="ACT">ACT</option>
            </select>
          </div>
          <div class="form-group">
            <label for="inv-postcode">Postcode *</label>
            <input type="text" id="inv-postcode" required placeholder="e.g. 4000">
          </div>

          <!-- Notes -->
          <div class="form-group full-width">
            <label for="inv-notes">Notes (optional)</label>
            <textarea id="inv-notes" placeholder="Purchase order number, special billing instructions, etc."></textarea>
          </div>
        </div>

        <div id="invoice-feedback" class="feedback-msg"></div>
        <button type="submit" class="btn" id="invoice-btn">Submit Invoice Request</button>
      </form>
    </div>
  </div>
</main>

<footer class="footer">
  <div class="footer-content">
    <div class="footer-left">
      <img src="assets/sopal_logo_v1.png" alt="SOPAL" class="footer-logo">
      <p>An intelligent search tool for adjudication decisions under the BIF Act 2017 (Qld)</p>
    </div>
    <div class="footer-links">
      <a href="adjudicators">Adjudicators</a>
      <a href="decision-search">Search</a>
      <a href="feedback">Feedback</a>
      <a href="privacy">Privacy</a>
      <a href="terms">Terms of Use</a>
    </div>
  </div>
  <div class="footer-bottom">
    <p>&copy; 2026 Sopal Australia. All rights reserved.</p>
  </div>
</footer>

<script src="https://js.stripe.com/v3/"></script>
<script>
const token = localStorage.getItem('purchase_token');
const params = new URLSearchParams(window.location.search);
const planParam = params.get('plan'); // 'weekly' or 'annual'

// Redirect if not logged in
if (!token) {
  window.location.href = '/login?redirect=' + encodeURIComponent('/checkout?plan=' + (planParam || 'weekly'));
}

// Redirect if no valid plan
if (planParam !== 'weekly' && planParam !== 'annual') {
  window.location.href = '/pricing';
}

// Map display plan to backend plan
const backendPlan = planParam === 'weekly' ? 'monthly' : 'annual';

// Populate plan summary
const planConfig = {
  weekly: { name: 'Weekly Plan', detail: '$12.95/week — billed weekly or monthly', price: '$12.95/wk' },
  annual: { name: 'Annual Plan', detail: '$520/year — just $9.95/week, save 23%', price: '$520/yr' }
};

const cfg = planConfig[planParam];
document.getElementById('summary-plan-name').textContent = cfg.name;
document.getElementById('summary-plan-detail').textContent = cfg.detail;
document.getElementById('summary-price').textContent = cfg.price;

// ACN field: required + enabled only for Pty Ltd or Ltd
const firmTypeSelect = document.getElementById('inv-firm-type');
const acnInput = document.getElementById('inv-acn');
const acnStar = document.getElementById('acn-required-star');

function updateAcnState() {
  const val = firmTypeSelect.value;
  const needsAcn = (val === 'Proprietary Limited' || val === 'Limited');
  acnInput.disabled = !needsAcn;
  acnInput.required = needsAcn;
  acnStar.style.display = needsAcn ? 'inline' : 'none';
  if (!needsAcn) acnInput.value = '';
}
firmTypeSelect.addEventListener('change', updateAcnState);
updateAcnState();

// "Same as Partner/Director" checkbox
const sameAsCheckbox = document.getElementById('inv-same-as-partner');
const partnerInput = document.getElementById('inv-partner');
const accountsContactInput = document.getElementById('inv-accounts-contact');

sameAsCheckbox.addEventListener('change', () => {
  if (sameAsCheckbox.checked) {
    accountsContactInput.value = partnerInput.value;
    accountsContactInput.disabled = true;
  } else {
    accountsContactInput.disabled = false;
  }
});

partnerInput.addEventListener('input', () => {
  if (sameAsCheckbox.checked) {
    accountsContactInput.value = partnerInput.value;
  }
});

// Pre-fill invoice form from user profile
async function prefillForm() {
  if (!token) return;
  try {
    const res = await fetch('/purchase-me', {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    if (!res.ok) return;
    const user = await res.json();

    const fullName = ((user.first_name || '') + ' ' + (user.last_name || '')).trim();
    document.getElementById('inv-firm').value = user.firm_name || '';
    document.getElementById('inv-abn').value = user.abn || '';
    document.getElementById('inv-address').value = user.billing_address || '';
    document.getElementById('inv-city').value = user.billing_city || '';
    document.getElementById('inv-state').value = user.billing_state || '';
    document.getElementById('inv-postcode').value = user.billing_postcode || '';
    document.getElementById('inv-partner').value = fullName;
  } catch (e) {
    console.warn('Could not prefill form:', e);
  }
}
prefillForm();

// Payment method toggle
let selectedMethod = 'stripe';

function selectMethod(method) {
  selectedMethod = method;
  document.getElementById('opt-stripe').classList.toggle('selected', method === 'stripe');
  document.getElementById('opt-invoice').classList.toggle('selected', method === 'invoice');
  document.getElementById('section-stripe').classList.toggle('active', method === 'stripe');
  document.getElementById('section-invoice').classList.toggle('active', method === 'invoice');
}

// Initialize Stripe Elements (same key as adjudicators page)
const stripe = Stripe('pk_live_51SGxeHAIOAykxV504w220IB6SNF8PWmMovA3Vcj7BU34qr4lxSftuuc6vhGtb0CURpjiR2e2OMMNdyMuzVXbH286002Y11rMPE');
const elements = stripe.elements();
const cardElement = elements.create('card', {
  style: {
    base: {
      fontSize: '16px',
      color: '#333',
      '::placeholder': { color: '#aaa' },
    },
  },
});
cardElement.mount('#card-element');

// Show card validation errors in real time
cardElement.on('change', (event) => {
  const errEl = document.getElementById('card-errors');
  errEl.textContent = event.error ? event.error.message : '';
});

// Stripe form submission
document.getElementById('stripe-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const btn = document.getElementById('stripe-btn');
  const feedback = document.getElementById('stripe-feedback');
  const cardErrors = document.getElementById('card-errors');
  feedback.className = 'feedback-msg';
  feedback.textContent = '';
  feedback.removeAttribute('style');
  cardErrors.textContent = '';
  btn.disabled = true;
  btn.textContent = 'Processing...';

  try {
    // Step 1: Create subscription with incomplete payment
    const formData = new FormData();
    formData.append('plan', backendPlan);

    console.log('[Checkout] Creating subscription intent for plan:', backendPlan);
    const res = await fetch('/create-subscription-intent', {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}` },
      body: formData
    });

    if (!res.ok) {
      let errMsg = 'Failed to create subscription';
      try {
        const err = await res.json();
        errMsg = err.detail || errMsg;
      } catch (parseErr) {
        errMsg = `Server error (${res.status})`;
      }
      throw new Error(errMsg);
    }

    const data = await res.json();
    console.log('[Checkout] Got client_secret, confirming payment...');

    // Step 2: Confirm the payment with the card element
    const { error, paymentIntent } = await stripe.confirmCardPayment(data.client_secret, {
      payment_method: { card: cardElement }
    });

    if (error) {
      throw new Error(error.message);
    }

    if (paymentIntent.status === 'succeeded') {
      feedback.textContent = 'Payment successful! Your subscription is now active. Redirecting to your account...';
      feedback.className = 'feedback-msg success';
      btn.style.display = 'none';

      setTimeout(() => {
        window.location.href = '/account?tab=subscription';
      }, 2500);
    }
  } catch (err) {
    console.error('[Checkout] Payment error:', err);
    feedback.textContent = err.message;
    feedback.className = 'feedback-msg error';
    btn.disabled = false;
    btn.textContent = 'Process Payment';
  }
});

// Invoice form submission
document.getElementById('invoice-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const btn = document.getElementById('invoice-btn');
  const feedback = document.getElementById('invoice-feedback');
  feedback.className = 'feedback-msg';
  feedback.style.display = 'none';
  btn.disabled = true;
  btn.textContent = 'Submitting...';

  try {
    const acnVal = document.getElementById('inv-acn').value.trim();
    const formData = new FormData();
    formData.append('plan', backendPlan);
    formData.append('accounts_email', document.getElementById('inv-accounts-email').value);
    formData.append('notes', [
      'Firm: ' + document.getElementById('inv-firm').value,
      'Firm Type: ' + document.getElementById('inv-firm-type').value,
      'ABN: ' + document.getElementById('inv-abn').value,
      acnVal ? 'ACN: ' + acnVal : '',
      'Partner/Director: ' + document.getElementById('inv-partner').value,
      'Accounts Contact: ' + document.getElementById('inv-accounts-contact').value,
      'Accounts Email: ' + document.getElementById('inv-accounts-email').value,
      'Accounts Phone: ' + document.getElementById('inv-phone').value,
      'Address: ' + document.getElementById('inv-address').value + ', ' +
        document.getElementById('inv-city').value + ' ' +
        document.getElementById('inv-state').value + ' ' +
        document.getElementById('inv-postcode').value,
      document.getElementById('inv-notes').value ? 'Notes: ' + document.getElementById('inv-notes').value : ''
    ].filter(Boolean).join('\n'));

    const res = await fetch('/request-invoice-subscription', {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}` },
      body: formData
    });

    const data = await res.json();

    if (!res.ok) {
      throw new Error(data.detail || 'Request failed');
    }

    feedback.textContent = data.message;
    feedback.className = 'feedback-msg success';
    btn.style.display = 'none';

    // Redirect to pricing page after short delay
    setTimeout(() => {
      window.location.href = '/pricing';
    }, 3000);

  } catch (err) {
    feedback.textContent = err.message;
    feedback.className = 'feedback-msg error';
  } finally {
    btn.disabled = false;
    btn.textContent = 'Submit Invoice Request';
  }
});
</script>

<script src="/assets/js/main.js"></script>
</body>
</html>
