<!DOCTYPE html>
<html lang="en">
<head>
  <script>if(sessionStorage.getItem("nt-transitioning")){var s=document.createElement("style");s.id="nt-precover";s.textContent="html{background:#0a0a0a!important}body{visibility:hidden!important}";document.head.appendChild(s)}</script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Payment Setup | Sopal</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;450;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    :root { --bg-dark: #0a0a0a; --bg-darker: #050505; --green: #00d47e; --green-dark: #00b368; --text-primary: #1a1a1a; --text-secondary: #6b6b6b; --text-muted: #888; --border-light: #e5e5e5; }
    body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; color: var(--text-primary); background: #fafafa; line-height: 1.5; -webkit-font-smoothing: antialiased; }
    a { text-decoration: none; color: inherit; }
    button { border: none; cursor: pointer; font-family: inherit; }
    .container { max-width: 1200px; margin: 0 auto; padding: 0 32px; }

    .nav { background: var(--bg-dark); border-bottom: 1px solid rgba(255,255,255,0.06); position: sticky; top: 0; z-index: 100; }
    .nav-inner { display: flex; align-items: center; justify-content: space-between; height: 56px; max-width: 1200px; margin: 0 auto; padding: 0 32px; }
    .nav-left { display: flex; align-items: center; gap: 32px; }
    .nav-logo { display: flex; align-items: center; gap: 8px; color: white; font-weight: 700; font-size: 17px; letter-spacing: -0.02em; }
    .nav-logo-icon { width: 28px; height: 28px; background: var(--green); border-radius: 7px; display: flex; align-items: center; justify-content: center; }
    .nav-logo-icon svg { width: 16px; height: 16px; }
    .nav-links { display: flex; align-items: center; gap: 24px; }
    .nav-links a { color: #999; font-size: 14px; font-weight: 450; transition: color 0.2s; }
    .nav-links a:hover { color: white; }
    .nav-right { display: flex; align-items: center; gap: 12px; }

    main { max-width: 700px; margin: 40px auto; padding: 0 32px; }
    .back-link { display: inline-block; margin-bottom: 20px; color: var(--green-dark); font-weight: 600; font-size: 14px; }
    .back-link:hover { text-decoration: underline; }
    .page-title { font-size: 26px; font-weight: 700; letter-spacing: -0.03em; margin-bottom: 6px; }
    .page-subtitle { color: var(--text-secondary); font-size: 14px; margin-bottom: 28px; }

    .plan-summary { background: #f0fdf4; border: 1px solid var(--green); border-radius: 12px; padding: 20px 24px; margin-bottom: 28px; display: flex; justify-content: space-between; align-items: center; }
    .plan-summary-left strong { font-size: 16px; font-weight: 700; }
    .plan-summary-left p { margin: 4px 0 0; color: var(--text-secondary); font-size: 13px; }
    .plan-summary-right { font-size: 22px; font-weight: 800; color: var(--green-dark); }

    .method-toggle { display: flex; gap: 14px; margin-bottom: 28px; }
    .method-option { flex: 1; background: white; border: 2px solid var(--border-light); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.2s; text-align: center; }
    .method-option:hover { border-color: #ccc; }
    .method-option.selected { border-color: var(--green); background: #f0fdf7; }
    .method-option h4 { font-size: 15px; font-weight: 600; margin: 0 0 4px; }
    .method-option p { margin: 0; color: var(--text-muted); font-size: 13px; }

    .payment-section { display: none; }
    .payment-section.active { display: block; }

    .stripe-section, .invoice-section { background: white; border: 1px solid var(--border-light); border-radius: 14px; padding: 28px; }
    .stripe-section p.intro, .invoice-section p.intro { color: var(--text-secondary); margin: 0 0 20px; font-size: 14px; }
    .stripe-logos { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; font-size: 13px; color: var(--text-muted); }
    .card-badge { background: #f5f5f5; padding: 4px 10px; border-radius: 6px; font-weight: 500; color: var(--text-secondary); font-size: 12px; }
    #card-element { padding: 14px; border: 1px solid var(--border-light); border-radius: 8px; margin-bottom: 12px; background: white; }
    #card-errors { color: #dc2626; font-size: 13px; margin-bottom: 14px; min-height: 20px; }
    .secure-note { display: flex; align-items: center; justify-content: center; gap: 6px; font-size: 12px; color: var(--text-muted); margin-top: 14px; }

    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    .form-group { margin-bottom: 14px; }
    .form-group.full-width { grid-column: 1 / -1; }
    .form-group label { display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-secondary); font-size: 12px; text-transform: uppercase; letter-spacing: 0.03em; }
    .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px 14px; border: 1px solid var(--border-light); border-radius: 8px; font-size: 14px; box-sizing: border-box; font-family: inherit; outline: none; transition: border-color 0.2s; }
    .form-group textarea { resize: vertical; min-height: 60px; }
    .form-group input:focus, .form-group textarea:focus, .form-group select:focus { border-color: var(--green); }
    .form-group input:disabled, .form-group select:disabled { background: #f5f5f5; color: #999; cursor: not-allowed; }
    .checkbox-row { display: flex; align-items: center; gap: 8px; margin-top: 6px; }
    .checkbox-row input[type="checkbox"] { width: auto; margin: 0; accent-color: var(--green); }
    .checkbox-row label { margin: 0; font-size: 13px; color: var(--text-muted); font-weight: 400; text-transform: none; letter-spacing: 0; }

    .submit-btn { display: block; width: 100%; padding: 12px; font-size: 14px; font-weight: 600; border-radius: 8px; background: var(--green); color: #000; transition: background 0.2s; text-align: center; }
    .submit-btn:hover { background: var(--green-dark); }
    .submit-btn:disabled { background: #ccc; cursor: not-allowed; }

    .feedback-msg { padding: 12px 16px; border-radius: 8px; margin-bottom: 14px; display: none; font-size: 13px; }
    .feedback-msg.error { display: block; background: #fef2f2; color: #991b1b; border: 1px solid #fecaca; }
    .feedback-msg.success { display: block; background: #f0fdf4; color: #166534; border: 1px solid #bbf7d0; }

    .footer { background: var(--bg-darker); border-top: 1px solid rgba(255,255,255,0.06); padding: 44px 0 28px; color: #777; }
    .footer-inner { display: grid; grid-template-columns: 1.8fr repeat(3, 1fr); gap: 24px; }
    .footer-brand { padding-right: 16px; }
    .footer-brand .footer-logo { display: flex; align-items: center; gap: 7px; color: white; font-weight: 700; font-size: 15px; margin-bottom: 10px; }
    .footer-logo-icon { width: 20px; height: 20px; background: var(--green); border-radius: 5px; display: flex; align-items: center; justify-content: center; }
    .footer-logo-icon svg { width: 12px; height: 12px; }
    .footer-brand p { font-size: 12px; color: #555; line-height: 1.5; }
    .footer-col h4 { font-size: 11px; font-weight: 600; color: #888; text-transform: uppercase; letter-spacing: 0.04em; margin-bottom: 14px; }
    .footer-col a { display: block; font-size: 13px; color: #666; margin-bottom: 7px; transition: color 0.2s; }
    .footer-col a:hover { color: white; }
    .footer-bottom { display: flex; align-items: center; justify-content: center; margin-top: 36px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.06); font-size: 12px; color: #555; }

    @media (max-width: 768px) {
      .nav-links { display: none; }
      .method-toggle { flex-direction: column; }
      .form-grid { grid-template-columns: 1fr; }
      .plan-summary { flex-direction: column; gap: 10px; text-align: center; }
      .footer-inner { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

  <nav class="nav"><div class="nav-inner"><div class="nav-left"><a href="/" class="nav-logo">
  <img src="/assets/sopal_logo_white_v1.png" alt="Sopal" style="height: 22px; width: auto;">
</a><div class="nav-links"><a href="/search">Search</a><a href="/adjudicators">Adjudicators</a><a href="/interest-calculator">Interest Calculator</a><a href="/due-date-calculator">Due Date Calculator</a><a href="/how-to">How-To Guide</a><a href="/feedback">Feedback</a></div></div><div class="nav-right"></div></div></nav>

  <main>
    <a href="/pricing" class="back-link">&larr; Back to Pricing</a>
    <h1 class="page-title">Set Up Payment</h1>
    <p class="page-subtitle">Choose how you'd like to pay for your subscription.</p>

    <div class="plan-summary" id="plan-summary">
      <div class="plan-summary-left">
        <strong id="summary-plan-name">&mdash;</strong>
        <p id="summary-plan-detail"></p>
      </div>
      <div class="plan-summary-right" id="summary-price">&mdash;</div>
    </div>

    <div class="method-toggle">
      <div class="method-option selected" id="opt-stripe" onclick="selectMethod('stripe')">
        <h4>Credit / Debit Card</h4>
        <p>Pay instantly via Stripe</p>
      </div>
      <div class="method-option" id="opt-invoice" onclick="selectMethod('invoice')">
        <h4>Pay by Invoice</h4>
        <p>Request an invoice for your firm</p>
      </div>
    </div>

    <div class="payment-section active" id="section-stripe">
      <div class="stripe-section">
        <p class="intro">Enter your card details below to start your subscription.</p>
        <div class="stripe-logos">
          <span class="card-badge">Visa</span>
          <span class="card-badge">Mastercard</span>
          <span class="card-badge">Amex</span>
        </div>
        <form id="stripe-form">
          <div id="card-element"></div>
          <div id="card-errors" role="alert"></div>
          <div id="stripe-feedback" class="feedback-msg"></div>
          <button type="submit" class="submit-btn" id="stripe-btn">Process Payment</button>
        </form>
        <div class="secure-note">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#999" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
          Payments processed securely by Stripe
        </div>
      </div>
    </div>

    <div class="payment-section" id="section-invoice">
      <div class="invoice-section">
        <p class="intro">Fill in your firm's billing details below. We'll review your request and activate your access within 1-2 business days.</p>
        <form id="invoice-form">
          <div class="form-grid">
            <div class="form-group">
              <label for="inv-firm">Firm / Company Name *</label>
              <input type="text" id="inv-firm" required>
            </div>
            <div class="form-group">
              <label for="inv-firm-type">Firm Type *</label>
              <select id="inv-firm-type" required>
                <option value="">Select</option>
                <option value="Sole Practitioner">Sole Practitioner</option>
                <option value="Partnership">Partnership</option>
                <option value="Proprietary Limited">Proprietary Limited</option>
                <option value="Limited">Limited</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div class="form-group">
              <label for="inv-abn">ABN *</label>
              <input type="text" id="inv-abn" required placeholder="e.g. 12 345 678 901">
            </div>
            <div class="form-group">
              <label for="inv-acn">ACN <span id="acn-required-star">*</span></label>
              <input type="text" id="inv-acn" placeholder="e.g. 123 456 789" disabled>
            </div>
            <div class="form-group full-width">
              <label for="inv-partner">Partner / Director's Name *</label>
              <input type="text" id="inv-partner" required>
            </div>
            <div class="form-group full-width">
              <label for="inv-accounts-contact">Accounts Contact Name *</label>
              <input type="text" id="inv-accounts-contact" required>
              <div class="checkbox-row">
                <input type="checkbox" id="inv-same-as-partner">
                <label for="inv-same-as-partner">Same as Partner / Director</label>
              </div>
            </div>
            <div class="form-group">
              <label for="inv-accounts-email">Accounts / Billing Email *</label>
              <input type="email" id="inv-accounts-email" required placeholder="accounts@yourfirm.com.au">
            </div>
            <div class="form-group">
              <label for="inv-phone">Accounts Phone Number *</label>
              <input type="tel" id="inv-phone" required placeholder="e.g. 07 3000 0000">
            </div>
            <div class="form-group full-width">
              <label for="inv-address">Billing Street Address *</label>
              <input type="text" id="inv-address" required>
            </div>
            <div class="form-group">
              <label for="inv-city">City *</label>
              <input type="text" id="inv-city" required>
            </div>
            <div class="form-group">
              <label for="inv-state">State *</label>
              <select id="inv-state" required>
                <option value="">Select</option>
                <option value="QLD">QLD</option>
                <option value="NSW">NSW</option>
                <option value="VIC">VIC</option>
                <option value="SA">SA</option>
                <option value="WA">WA</option>
                <option value="TAS">TAS</option>
                <option value="NT">NT</option>
                <option value="ACT">ACT</option>
              </select>
            </div>
            <div class="form-group">
              <label for="inv-postcode">Postcode *</label>
              <input type="text" id="inv-postcode" required placeholder="e.g. 4000">
            </div>
            <div class="form-group full-width">
              <label for="inv-notes">Notes (optional)</label>
              <textarea id="inv-notes" placeholder="Purchase order number, special billing instructions, etc."></textarea>
            </div>
          </div>
          <div id="invoice-feedback" class="feedback-msg"></div>
          <button type="submit" class="submit-btn" id="invoice-btn">Submit Invoice Request</button>
        </form>
      </div>
    </div>
  </main>

  <footer class="footer"><div class="container"><div class="footer-inner"><div class="footer-brand"><div class="footer-logo"><img src="/assets/sopal_logo_white_v1.png" alt="Sopal" style="height: 18px; width: auto;"></div><p>An intelligent search tool for adjudication decisions under the Building Industry Fairness (Security of Payment) Act 2017 (Qld)</p></div><div class="footer-col"><h4>Tools</h4><a href="/search">Decision Search</a><a href="/adjudicators">Adjudicators</a><a href="/interest-calculator">Interest Calculator</a><a href="/due-date-calculator">Due Date Calculator</a></div><div class="footer-col"><h4>Resources</h4><a href="/how-to">How-To Guide</a><a href="/feedback">Feedback</a></div><div class="footer-col"><h4>Legal</h4><a href="/privacy">Privacy</a><a href="/terms">Terms of Use</a><a href="/account-terms">Account Terms</a><a href="/subscription-terms">Subscription Terms</a></div></div><div class="footer-bottom"><span>&copy; 2026 Sopal Australia. All rights reserved.</span> <a href="/admin" style="color:#444;margin-left:16px;font-size:11px;">Developer Login</a></div></div></footer>

<script src="https://js.stripe.com/v3/"></script>
<script>
const token = localStorage.getItem('purchase_token');
const params = new URLSearchParams(window.location.search);
const planParam = params.get('plan');

// Redirect if not logged in
if (!token) {
    window.location.href = '/login?redirect=' + encodeURIComponent('/checkout?plan=' + (planParam || 'weekly'));
}

// Redirect if no valid plan
if (planParam !== 'weekly' && planParam !== 'annual') {
    window.location.href = '/pricing';
}

// Map display plan to backend plan
const backendPlan = planParam === 'weekly' ? 'monthly' : 'annual';

// Populate plan summary
const planConfig = {
    weekly: { name: 'Weekly Plan', detail: '$12.95/week — billed weekly or monthly', price: '$12.95/wk' },
    annual: { name: 'Annual Plan', detail: '$520/year — just $9.95/week, save 23%', price: '$520/yr' }
};
const cfg = planConfig[planParam];
document.getElementById('summary-plan-name').textContent = cfg.name;
document.getElementById('summary-plan-detail').textContent = cfg.detail;
document.getElementById('summary-price').textContent = cfg.price;

// ACN field: required + enabled only for Pty Ltd or Ltd
const firmTypeSelect = document.getElementById('inv-firm-type');
const acnInput = document.getElementById('inv-acn');
const acnStar = document.getElementById('acn-required-star');

function updateAcnState() {
    const val = firmTypeSelect.value;
    const needsAcn = (val === 'Proprietary Limited' || val === 'Limited');
    acnInput.disabled = !needsAcn;
    acnInput.required = needsAcn;
    acnStar.style.display = needsAcn ? 'inline' : 'none';
    if (!needsAcn) acnInput.value = '';
}
firmTypeSelect.addEventListener('change', updateAcnState);
updateAcnState();

// "Same as Partner/Director" checkbox
const sameAsCheckbox = document.getElementById('inv-same-as-partner');
const partnerInput = document.getElementById('inv-partner');
const accountsContactInput = document.getElementById('inv-accounts-contact');

sameAsCheckbox.addEventListener('change', () => {
    if (sameAsCheckbox.checked) {
        accountsContactInput.value = partnerInput.value;
        accountsContactInput.disabled = true;
    } else {
        accountsContactInput.disabled = false;
    }
});
partnerInput.addEventListener('input', () => {
    if (sameAsCheckbox.checked) {
        accountsContactInput.value = partnerInput.value;
    }
});

// Pre-fill invoice form from user profile
async function prefillForm() {
    if (!token) return;
    try {
        const res = await fetch('/purchase-me', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!res.ok) return;
        const user = await res.json();
        const fullName = ((user.first_name || '') + ' ' + (user.last_name || '')).trim();
        document.getElementById('inv-firm').value = user.firm_name || '';
        document.getElementById('inv-abn').value = user.abn || '';
        document.getElementById('inv-address').value = user.billing_address || '';
        document.getElementById('inv-city').value = user.billing_city || '';
        document.getElementById('inv-state').value = user.billing_state || '';
        document.getElementById('inv-postcode').value = user.billing_postcode || '';
        document.getElementById('inv-partner').value = fullName;
    } catch (e) {
        console.warn('Could not prefill form:', e);
    }
}
prefillForm();

// Payment method toggle
let selectedMethod = 'stripe';
function selectMethod(method) {
    selectedMethod = method;
    document.getElementById('opt-stripe').classList.toggle('selected', method === 'stripe');
    document.getElementById('opt-invoice').classList.toggle('selected', method === 'invoice');
    document.getElementById('section-stripe').classList.toggle('active', method === 'stripe');
    document.getElementById('section-invoice').classList.toggle('active', method === 'invoice');
}

// Initialize Stripe Elements
const stripe = Stripe('pk_live_51SGxeHAIOAykxV504w220IB6SNF8PWmMovA3Vcj7BU34qr4lxSftuuc6vhGtb0CURpjiR2e2OMMNdyMuzVXbH286002Y11rMPE');
const elements = stripe.elements();
const cardElement = elements.create('card', {
    style: {
        base: { fontSize: '16px', color: '#333', '::placeholder': { color: '#aaa' } }
    }
});
cardElement.mount('#card-element');

cardElement.on('change', (event) => {
    document.getElementById('card-errors').textContent = event.error ? event.error.message : '';
});

// Stripe form submission
document.getElementById('stripe-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = document.getElementById('stripe-btn');
    const feedback = document.getElementById('stripe-feedback');
    const cardErrors = document.getElementById('card-errors');
    feedback.className = 'feedback-msg';
    feedback.textContent = '';
    feedback.removeAttribute('style');
    cardErrors.textContent = '';
    btn.disabled = true;
    btn.textContent = 'Processing...';

    try {
        const formData = new FormData();
        formData.append('plan', backendPlan);

        const res = await fetch('/create-subscription-intent', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` },
            body: formData
        });

        if (!res.ok) {
            let errMsg = 'Failed to create subscription';
            try { const err = await res.json(); errMsg = err.detail || errMsg; } catch (parseErr) { errMsg = `Server error (${res.status})`; }
            throw new Error(errMsg);
        }

        const data = await res.json();
        const { error, paymentIntent } = await stripe.confirmCardPayment(data.client_secret, {
            payment_method: { card: cardElement }
        });

        if (error) throw new Error(error.message);

        if (paymentIntent.status === 'succeeded') {
            feedback.textContent = 'Payment successful! Your subscription is now active. Redirecting to your account...';
            feedback.className = 'feedback-msg success';
            btn.style.display = 'none';
            setTimeout(() => { window.location.href = '/account?tab=subscription'; }, 2500);
        }
    } catch (err) {
        feedback.textContent = err.message;
        feedback.className = 'feedback-msg error';
        btn.disabled = false;
        btn.textContent = 'Process Payment';
    }
});

// Invoice form submission
document.getElementById('invoice-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = document.getElementById('invoice-btn');
    const feedback = document.getElementById('invoice-feedback');
    feedback.className = 'feedback-msg';
    feedback.style.display = 'none';
    btn.disabled = true;
    btn.textContent = 'Submitting...';

    try {
        const acnVal = document.getElementById('inv-acn').value.trim();
        const formData = new FormData();
        formData.append('plan', backendPlan);
        formData.append('accounts_email', document.getElementById('inv-accounts-email').value);
        formData.append('notes', [
            'Firm: ' + document.getElementById('inv-firm').value,
            'Firm Type: ' + document.getElementById('inv-firm-type').value,
            'ABN: ' + document.getElementById('inv-abn').value,
            acnVal ? 'ACN: ' + acnVal : '',
            'Partner/Director: ' + document.getElementById('inv-partner').value,
            'Accounts Contact: ' + document.getElementById('inv-accounts-contact').value,
            'Accounts Email: ' + document.getElementById('inv-accounts-email').value,
            'Accounts Phone: ' + document.getElementById('inv-phone').value,
            'Address: ' + document.getElementById('inv-address').value + ', ' +
                document.getElementById('inv-city').value + ' ' +
                document.getElementById('inv-state').value + ' ' +
                document.getElementById('inv-postcode').value,
            document.getElementById('inv-notes').value ? 'Notes: ' + document.getElementById('inv-notes').value : ''
        ].filter(Boolean).join('\n'));

        const res = await fetch('/request-invoice-subscription', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` },
            body: formData
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || 'Request failed');

        feedback.textContent = data.message;
        feedback.className = 'feedback-msg success';
        btn.style.display = 'none';
        setTimeout(() => { window.location.href = '/pricing'; }, 3000);
    } catch (err) {
        feedback.textContent = err.message;
        feedback.className = 'feedback-msg error';
    } finally {
        btn.disabled = false;
        btn.textContent = 'Submit Invoice Request';
    }
});
</script>
<script src="/assets/js/main.js"></script>
</body>
</html>
