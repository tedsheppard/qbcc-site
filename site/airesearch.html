<!doctype html>
<html lang="en">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-QEN3X3DQLR"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-QEN3X3DQLR');
    </script>
    <link rel="icon" href="assets/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="assets/favicon.ico" type="image/x-icon">
    <meta charset="utf-8">
    <title>Sopal – AI Research Assistant</title>
    <meta name="description" content="Sopal AI Research Assistant for Queensland construction law, focusing on BCIPA and BIF Act cases.">
    <meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  /* Basic styles copied from index.html for consistency */
  body { font-family: Inter, sans-serif; margin: 0; background: #fff; color: #222; font-size: 14px; }
  main { max-width: 900px; margin: 35px auto 0; padding: 0 25px; }
  h1 { font-size: 28px; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 20px; }
  a { color: black; text-decoration: none; transition: color 0.2s; }
  a:hover { color: #00c97c; text-decoration: none; }
  .header { background: #fdfdfd; padding: 20px 25px; border-bottom: 1px solid #ddd; position: sticky; top: 0; z-index: 100; }
  .header-content { display: flex; align-items: center; max-width: 1200px; margin: 0 auto; }
  .logo { height: 31px; margin-right: 20px; }
  .nav-links { margin-left: auto; display: flex; gap: 20px; }
  .nav-links a { color: black; text-decoration: none; font-size: 14px; }
  .nav-links a.active { color: #008a5c; font-weight: 600; }
  .footer { background: #fcfcfc; color: #333; padding: 40px 25px 20px; margin-top: 60px; border-top: 1px solid #ddd; }
  .footer-content { display: flex; justify-content: space-between; max-width: 1200px; margin: auto; }
  .footer-bottom { text-align: center; border-top: 1px solid #eee; margin-top: 30px; padding-top: 20px; width: 100%; font-size: 0.85em; color: #666; }

  /* Dark mode */
  .dark body { background: #0d0d0d !important; color: #e0e0e0 !important; }
  .dark .header, .dark .footer { background: #141414 !important; color: #f0f0f0 !important; border-color: #333 !important; }
  .dark .nav-links a, .dark a { color: #f0f0f0; }
  .dark .nav-links a.active { color: #00c97c; }
  .dark .footer-bottom { border-top: 1px solid #333 !important; color: #aaa !important; }
  .dark h1 { border-bottom-color: #333; }

  /* ---- AI CHAT INTERFACE STYLES ---- */
  .ai-container {
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    margin-top: 15px;
    display: flex;
    flex-direction: column;
    height: calc(100vh - 250px);
    max-height: 800px;
  }
  .dark .ai-container { border-color: #444; }

  .chat-messages {
    flex-grow: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 18px;
  }

  .message { display: flex; align-items: flex-start; gap: 12px; max-width: 95%; }
  .message-avatar { width: 34px; height: 34px; border-radius: 50%; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: 500;}
  .ai-message .message-avatar { background: #10a37f; color: white; }
  .user-message .message-avatar { background: #f0f0f0; color: #333; }
  .dark .user-message .message-avatar { background: #555; color: #eee; }

  .message-content { padding: 1px 16px; border-radius: 12px; font-size: 14px; line-height: 1.6; }
  
  .ai-message { align-self: flex-start; }
  .ai-message .message-content { background: #f7f7f7; color: #222; }
  .dark .ai-message .message-content { background: #2a2a2a; color: #eee; }

  .user-message { align-self: flex-end; flex-direction: row-reverse; }
  .user-message .message-content { background: #0084ff; color: white; }
  .dark .user-message .message-content { background: #005cbe; color: #e0e0e0; }
  
  .chat-input-area { display: flex; align-items: center; padding: 12px; border-top: 1px solid #e0e0e0; }
  .dark .chat-input-area { border-top-color: #444; }

  #chat-input {
    flex-grow: 1;
    border: 1px solid #ccc;
    background: #fff;
    border-radius: 20px;
    padding: 10px 18px;
    font-size: 14px;
    outline: none;
    color: #222;
    margin-right: 10px;
    transition: border-color 0.2s;
  }
  #chat-input:focus { border-color: #0084ff; }
  .dark #chat-input { color: #eee; background: #333; border-color: #555; }

  #send-button {
    background: #0084ff; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background 0.2s; flex-shrink: 0;
  }
  #send-button:hover { background: #006acc; }
  #send-button:disabled { background: #ccc; cursor: not-allowed; }
  .dark #send-button:disabled { background: #555; }

  /* AI Content Formatting */
  .ai-output-content p { margin: 8px 0; }
  .ai-output-content strong { font-weight: 600; }
  .ai-output-content ul, .ai-output-content ol { margin: 8px 0 8px 20px; padding: 0; }
  .ai-output-content li { margin-bottom: 4px; }
  
  /* Sources */
  .sources-container {
    margin-top: 15px;
    border-top: 1px solid #eee;
    padding-top: 10px;
  }
  .dark .sources-container { border-top-color: #3a3a3a; }
  .sources-container h4 { margin: 0 0 10px; font-size: 13px; color: #555; }
  .dark .sources-container h4 { color: #aaa; }
  .sources-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }
  .source-item {
    background: #f0f0f0;
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    padding: 5px 10px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .dark .source-item { background: #333; border-color: #444; }
  .source-item:hover { background: #e0e0e0; border-color: #ccc; transform: translateY(-1px); }
  .dark .source-item:hover { background: #444; border-color: #555; }

  /* Citation styling */
  .citation {
    display: inline-block;
    width: 18px;
    height: 18px;
    line-height: 18px;
    text-align: center;
    background-color: #0084ff;
    color: white;
    font-size: 11px;
    font-weight: bold;
    border-radius: 50%;
    margin: 0 2px;
    cursor: pointer;
    vertical-align: super;
  }
</style>
</head>
<body class="light">

<div class="header">
  <div class="header-content">
    <a href="/"><img id="logo" src="assets/sopal_logo_v1.png" alt="SOPAL" class="logo"></a>
    <div class="nav-links">
      <a href="/index.html">Search</a>
      <a href="/adjudicators">Adjudicators</a>
      <a href="/airesearch.html" class="active">AI Research</a>
      <a href="/interest-calculator">Interest Calculator</a>
      <a href="/due-date-calculator">Due Date Calculator</a>
      <a href="/how-to">How-To Guide</a>
      <a href="/feedback">Feedback</a>
    </div>
  </div>
</div>

<main>
  <h1>AI Research Assistant</h1>

  <div class="ai-container">
    <div class="chat-messages" id="chat-messages">
      <div class="message ai-message">
        <div class="message-avatar">AI</div>
        <div class="message-content">
          <p>Hello! I am Sopal's AI Research Assistant. I have access to 339 judgments and the full text of the BCIPA and BIF Act.</p>
          <p>How can I help you with your Queensland construction law query?</p>
        </div>
      </div>
    </div>
    <div class="chat-input-area">
      <input type="text" id="chat-input" placeholder="e.g., What are the requirements for a valid payment claim under the BIF Act?">
      <button id="send-button" aria-label="Send message">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
      </button>
    </div>
  </div>
</main>

<footer class="footer">
  <div class="footer-content"></div>
  <div class="footer-bottom"><p>© 2025 Sopal Australia. All rights reserved.</p></div>
</footer>

<script>
    const chatMessages = document.getElementById('chat-messages');
    const chatInput = document.getElementById('chat-input');
    const sendButton = document.getElementById('send-button');

    let conversationHistory = [];
    let eventSource = null;

    const sendQuery = async () => {
        const query = chatInput.value.trim();
        if (!query) return;

        displayUserMessage(query);
        chatInput.value = '';
        sendButton.disabled = true;

        const currentAIMessage = displayAIMessage("");

        try {
            const res = await fetch('/api/airesearch', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    query: query,
                    history: conversationHistory
                })
            });

            if (!res.ok) {
                throw new Error(`Server error: ${res.statusText}`);
            }

            const reader = res.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
            let sources = [];
            let fullResponse = '';

            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                
                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop(); // Keep the last, possibly incomplete line

                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const data = JSON.parse(line.substring(6));
                        if (data.type === 'content') {
                            fullResponse += data.data;
                            currentAIMessage.content.innerHTML = formatAIContent(fullResponse);
                        } else if (data.type === 'source') {
                            sources.push(data.data);
                        }
                    }
                }
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            // Final update and add sources container
            currentAIMessage.content.innerHTML = formatAIContent(fullResponse);
            if (sources.length > 0) {
                displaySources(currentAIMessage.container, sources);
            }
            
            conversationHistory.push({ role: 'assistant', content: fullResponse });

        } catch (error) {
            currentAIMessage.content.textContent = `⚠️ An error occurred: ${error.message}`;
            console.error("Fetch error:", error);
        } finally {
            sendButton.disabled = false;
            chatInput.focus();
        }
    };

    const displayUserMessage = (query) => {
        const messageHTML = `
            <div class="message-avatar">U</div>
            <div class="message-content"><p>${sanitize(query)}</p></div>
        `;
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message user-message';
        messageDiv.innerHTML = messageHTML;
        chatMessages.appendChild(messageDiv);
        conversationHistory.push({ role: 'user', content: query });
        chatMessages.scrollTop = chatMessages.scrollHeight;
    };

    const displayAIMessage = (content) => {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message ai-message';
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content ai-output-content';
        contentDiv.innerHTML = content || '<span class="typing-indicator">...</span>';

        messageDiv.innerHTML = `<div class="message-avatar">AI</div>`;
        messageDiv.appendChild(contentDiv);
        
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
        return { container: messageDiv, content: contentDiv };
    };

    const displaySources = (messageContainer, sources) => {
        const sourcesContainer = document.createElement('div');
        sourcesContainer.className = 'sources-container';
        let sourcesHTML = '<h4>Sources:</h4><div class="sources-list">';
        sources.forEach((source, index) => {
            const title = source.case_citation ? `${source.case_citation}, [${source.para_number}]` : `${source.section_number} ${source.section_heading}`;
            sourcesHTML += `<div class="source-item" title="${sanitize(source.text)}"><strong>${index + 1}.</strong> ${sanitize(title)}</div>`;
        });
        sourcesHTML += '</div>';
        sourcesContainer.innerHTML = sourcesHTML;
        messageContainer.appendChild(sourcesContainer);
    };
    
    // Convert markdown-like syntax to HTML and add citations
    const formatAIContent = (text) => {
        let html = text
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\n/g, '<br>');
        
        // Find all citation markers like [1], [2], etc.
        html = html.replace(/\[(\d+)\]/g, (match, number) => {
            return `<span class="citation" title="Source ${number}">${number}</span>`;
        });
        return html;
    };

    const sanitize = (s) => (s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

    sendButton.addEventListener('click', sendQuery);
    chatInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendQuery();
        }
    });

</script>
</body>
</html>
