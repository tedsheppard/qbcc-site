<!DOCTYPE html>
<html lang="en">
<head>
  <script>if(sessionStorage.getItem("nt-transitioning")){var s=document.createElement("style");s.id="nt-precover";s.textContent="html{background:#0a0a0a!important}body{visibility:hidden!important}";document.head.appendChild(s)}</script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-QEN3X3DQLR"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-QEN3X3DQLR');
  </script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sopal â€“ AI Research Assistant</title>
  <meta name="description" content="Sopal AI Research Assistant for Queensland construction law, focusing on BCIPA and BIF Act cases.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;450;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg-dark: #0a0a0a;
      --bg-darker: #050505;
      --green: #00d47e;
      --green-dark: #00b368;
      --text-primary: #1a1a1a;
      --text-secondary: #6b6b6b;
      --text-muted: #888;
      --border-light: #e5e5e5;
      --border-dark: #222;
    }
    body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; color: var(--text-primary); background: #fafafa; line-height: 1.5; -webkit-font-smoothing: antialiased; }
    a { text-decoration: none; color: inherit; }
    button { border: none; cursor: pointer; font-family: inherit; }
    .container { max-width: 1200px; margin: 0 auto; padding: 0 32px; }

    /* Nav */
    .nav { background: var(--bg-dark); border-bottom: 1px solid rgba(255,255,255,0.06); position: sticky; top: 0; z-index: 100; }
    .nav-inner { display: flex; align-items: center; justify-content: space-between; height: 56px; max-width: 1200px; margin: 0 auto; padding: 0 32px; }
    .nav-left { display: flex; align-items: center; gap: 32px; }
    .nav-logo { display: flex; align-items: center; gap: 8px; color: white; font-weight: 700; font-size: 17px; letter-spacing: -0.02em; }
    .nav-logo-icon { width: 28px; height: 28px; background: var(--green); border-radius: 7px; display: flex; align-items: center; justify-content: center; }
    .nav-logo-icon svg { width: 16px; height: 16px; }
    .nav-links { display: flex; align-items: center; gap: 24px; }
    .nav-links a { color: #999; font-size: 14px; font-weight: 450; transition: color 0.2s; }
    .nav-links a:hover { color: white; }
    .nav-links a.active { color: white; font-weight: 500; }
    .nav-right { display: flex; align-items: center; gap: 12px; }

    /* Page header */
    .page-header { background: white; border-bottom: 1px solid var(--border-light); padding: 32px 0; }
    .page-header h1 { font-size: 28px; font-weight: 700; letter-spacing: -0.03em; margin-bottom: 6px; }
    .page-header p { font-size: 14px; color: var(--text-secondary); }

    /* Chat layout */
    .chat-wrapper { padding: 28px 0 72px; }

    /* AI Chat Interface */
    .ai-container {
      background: white;
      border: 1px solid var(--border-light);
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      height: calc(100vh - 220px);
      max-height: 800px;
    }

    .chat-messages {
      flex-grow: 1;
      overflow-y: auto;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .message { display: flex; align-items: flex-start; gap: 12px; max-width: 95%; }
    .message-avatar {
      width: 34px; height: 34px; border-radius: 50%; flex-shrink: 0;
      display: flex; align-items: center; justify-content: center;
      font-size: 13px; font-weight: 600;
    }
    .ai-message .message-avatar { background: var(--green); color: #000; }
    .user-message .message-avatar { background: #f0f0f0; color: var(--text-primary); }

    .message-content { padding: 1px 16px; border-radius: 12px; font-size: 14px; line-height: 1.7; }

    .ai-message { align-self: flex-start; }
    .ai-message .message-content { background: #f7f7f8; color: var(--text-primary); }

    .user-message { align-self: flex-end; flex-direction: row-reverse; }
    .user-message .message-content { background: var(--bg-dark); color: white; }

    .chat-input-area {
      display: flex; align-items: center; padding: 14px 16px;
      border-top: 1px solid var(--border-light); background: white;
      border-radius: 0 0 12px 12px;
    }

    #chat-input {
      flex-grow: 1;
      border: 1px solid var(--border-light);
      background: #fafafa;
      border-radius: 20px;
      padding: 10px 18px;
      font-size: 14px;
      font-family: inherit;
      outline: none;
      color: var(--text-primary);
      margin-right: 10px;
      transition: border-color 0.2s;
    }
    #chat-input:focus { border-color: var(--green); }
    #chat-input::placeholder { color: var(--text-muted); }

    #send-button {
      background: var(--green); color: #000; border: none; border-radius: 50%;
      width: 40px; height: 40px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: background 0.2s; flex-shrink: 0;
      font-weight: 600;
    }
    #send-button:hover { background: var(--green-dark); }
    #send-button:disabled { background: var(--border-light); color: var(--text-muted); cursor: not-allowed; }

    /* AI Content Formatting */
    .ai-output-content p { margin: 8px 0; }
    .ai-output-content strong { font-weight: 600; }
    .ai-output-content ul, .ai-output-content ol { margin: 8px 0 8px 20px; padding: 0; }
    .ai-output-content li { margin-bottom: 4px; }

    /* Sources */
    .sources-container {
      margin-top: 15px;
      border-top: 1px solid var(--border-light);
      padding-top: 10px;
    }
    .sources-container h4 { margin: 0 0 10px; font-size: 13px; color: var(--text-muted); font-weight: 600; }
    .sources-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .source-item {
      background: #f7f7f8;
      border: 1px solid var(--border-light);
      border-radius: 12px;
      padding: 5px 10px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .source-item:hover { background: #efefef; border-color: #ccc; transform: translateY(-1px); }

    /* Citation styling */
    .citation {
      display: inline-block;
      width: 18px; height: 18px; line-height: 18px;
      text-align: center;
      background-color: var(--green);
      color: #000;
      font-size: 11px;
      font-weight: bold;
      border-radius: 50%;
      margin: 0 2px;
      cursor: pointer;
      vertical-align: super;
    }

    .typing-indicator { color: var(--text-muted); }

    /* Footer */
    .footer { background: var(--bg-darker); border-top: 1px solid rgba(255,255,255,0.06); padding: 44px 0 28px; color: #777; }
    .footer-inner { display: grid; grid-template-columns: 1.8fr repeat(3, 1fr); gap: 24px; }
    .footer-brand { padding-right: 16px; }
    .footer-brand .footer-logo { display: flex; align-items: center; gap: 7px; color: white; font-weight: 700; font-size: 15px; margin-bottom: 10px; }
    .footer-logo-icon { width: 20px; height: 20px; background: var(--green); border-radius: 5px; display: flex; align-items: center; justify-content: center; }
    .footer-logo-icon svg { width: 12px; height: 12px; }
    .footer-brand p { font-size: 12px; color: #555; line-height: 1.5; }
    .footer-col h4 { font-size: 11px; font-weight: 600; color: #888; text-transform: uppercase; letter-spacing: 0.04em; margin-bottom: 14px; }
    .footer-col a { display: block; font-size: 13px; color: #666; margin-bottom: 7px; transition: color 0.2s; }
    .footer-col a:hover { color: white; }
    .footer-bottom { display: flex; align-items: center; justify-content: center; margin-top: 36px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.06); font-size: 12px; color: #555; }

    @media (max-width: 768px) {
      .nav-links { display: none; }
      .footer-inner { grid-template-columns: 1fr; }
      .ai-container { height: calc(100vh - 200px); }
    }
  </style>
</head>
<body>

  <nav class="nav">
    <div class="nav-inner">
      <div class="nav-left">
        <a href="/" class="nav-logo">
  <img src="/assets/sopal_logo_white_v1.png" alt="Sopal" style="height: 22px; width: auto;">
</a>
        <div class="nav-links">
          <a href="/search">Search</a>
          <a href="/adjudicators">Adjudicators</a>
          <a href="/interest-calculator">Interest Calculator</a>
          <a href="/due-date-calculator">Due Date Calculator</a>
          <a href="/how-to">How-To Guide</a>
          <a href="/feedback">Feedback</a>
        </div>
      </div>
      <div class="nav-right"></div>
    </div>
  </nav>

  <div class="page-header">
    <div class="container">
      <h1>AI Research Assistant</h1>
      <p>Ask questions about Queensland construction law, BCIPA, and BIF Act cases</p>
    </div>
  </div>

  <div class="container">
    <div class="chat-wrapper">
      <div class="ai-container">
        <div class="chat-messages" id="chat-messages">
          <div class="message ai-message">
            <div class="message-avatar">AI</div>
            <div class="message-content">
              <p>Hello! I am Sopal's AI Research Assistant. I have access to 339 judgments and the full text of the BCIPA and BIF Act.</p>
              <p>How can I help you with your Queensland construction law query?</p>
            </div>
          </div>
        </div>
        <div class="chat-input-area">
          <input type="text" id="chat-input" placeholder="e.g., What are the requirements for a valid payment claim under the BIF Act?">
          <button id="send-button" aria-label="Send message">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
      <div class="footer-inner">
        <div class="footer-brand">
          <div class="footer-logo"><img src="/assets/sopal_logo_white_v1.png" alt="Sopal" style="height: 18px; width: auto;"></div>
          <p>An intelligent search tool for adjudication decisions under the Building Industry Fairness (Security of Payment) Act 2017 (Qld)</p>
        </div>
        <div class="footer-col"><h4>Tools</h4><a href="/search">Decision Search</a><a href="/adjudicators">Adjudicators</a><a href="/interest-calculator">Interest Calculator</a><a href="/due-date-calculator">Due Date Calculator</a></div>
        <div class="footer-col"><h4>Resources</h4><a href="/how-to">How-To Guide</a><a href="/feedback">Feedback</a></div>
        <div class="footer-col"><h4>Legal</h4><a href="/privacy">Privacy</a><a href="/terms">Terms of Use</a><a href="/account-terms">Account Terms</a><a href="/subscription-terms">Subscription Terms</a></div>
      </div>
      <div class="footer-bottom"><span>&copy; 2026 Sopal Australia. All rights reserved.</span> <a href="/admin" style="color:#444;margin-left:16px;font-size:11px;">Developer Login</a></div>
    </div>
  </footer>

<script>
    const chatMessages = document.getElementById('chat-messages');
    const chatInput = document.getElementById('chat-input');
    const sendButton = document.getElementById('send-button');

    let conversationHistory = [];
    let eventSource = null;

    const sendQuery = async () => {
        const query = chatInput.value.trim();
        if (!query) return;

        displayUserMessage(query);
        chatInput.value = '';
        sendButton.disabled = true;

        const currentAIMessage = displayAIMessage("");

        try {
            const res = await fetch('/api/airesearch', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    query: query,
                    history: conversationHistory
                })
            });

            if (!res.ok) {
                throw new Error(`Server error: ${res.statusText}`);
            }

            const reader = res.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
            let sources = [];
            let fullResponse = '';

            while (true) {
                const { value, done } = await reader.read();
                if (done) break;

                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop(); // Keep the last, possibly incomplete line

                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const data = JSON.parse(line.substring(6));
                        if (data.type === 'content') {
                            fullResponse += data.data;
                            currentAIMessage.content.innerHTML = formatAIContent(fullResponse);
                        } else if (data.type === 'source') {
                            sources.push(data.data);
                        }
                    }
                }
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            // Final update and add sources container
            currentAIMessage.content.innerHTML = formatAIContent(fullResponse);
            if (sources.length > 0) {
                displaySources(currentAIMessage.container, sources);
            }

            conversationHistory.push({ role: 'assistant', content: fullResponse });

        } catch (error) {
            currentAIMessage.content.textContent = `An error occurred: ${error.message}`;
            console.error("Fetch error:", error);
        } finally {
            sendButton.disabled = false;
            chatInput.focus();
        }
    };

    const displayUserMessage = (query) => {
        const messageHTML = `
            <div class="message-avatar">U</div>
            <div class="message-content"><p>${sanitize(query)}</p></div>
        `;
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message user-message';
        messageDiv.innerHTML = messageHTML;
        chatMessages.appendChild(messageDiv);
        conversationHistory.push({ role: 'user', content: query });
        chatMessages.scrollTop = chatMessages.scrollHeight;
    };

    const displayAIMessage = (content) => {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message ai-message';

        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content ai-output-content';
        contentDiv.innerHTML = content || '<span class="typing-indicator">...</span>';

        messageDiv.innerHTML = `<div class="message-avatar">AI</div>`;
        messageDiv.appendChild(contentDiv);

        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        return { container: messageDiv, content: contentDiv };
    };

    const displaySources = (messageContainer, sources) => {
        const sourcesContainer = document.createElement('div');
        sourcesContainer.className = 'sources-container';
        let sourcesHTML = '<h4>Sources:</h4><div class="sources-list">';
        sources.forEach((source, index) => {
            const title = source.case_citation ? `${source.case_citation}, [${source.para_number}]` : `${source.section_number} ${source.section_heading}`;
            sourcesHTML += `<div class="source-item" title="${sanitize(source.text)}"><strong>${index + 1}.</strong> ${sanitize(title)}</div>`;
        });
        sourcesHTML += '</div>';
        sourcesContainer.innerHTML = sourcesHTML;
        messageContainer.appendChild(sourcesContainer);
    };

    // Convert markdown-like syntax to HTML and add citations
    const formatAIContent = (text) => {
        let html = text
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\n/g, '<br>');

        // Find all citation markers like [1], [2], etc.
        html = html.replace(/\[(\d+)\]/g, (match, number) => {
            return `<span class="citation" title="Source ${number}">${number}</span>`;
        });
        return html;
    };

    const sanitize = (s) => (s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

    sendButton.addEventListener('click', sendQuery);
    chatInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendQuery();
        }
    });

</script>
<script src="/assets/js/main.js"></script>
</body>
</html>
