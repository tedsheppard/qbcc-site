<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal - LexiFile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .file-item.selected {
            background-color: #eef2ff;
            border-left-color: #4f46e5;
        }
        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #4f46e5;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* For sidebar tooltip */
        .group:hover .group-hover\:scale-100 { transform: scale(1); }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 overflow-hidden">
    <div class="h-screen flex">
        <!-- Sidebar Navigation -->
        <nav class="w-20 bg-white border-r border-gray-200 flex flex-col items-center py-4">
            <a href="/lexifile_index" class="mb-8">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-500"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><path d="m11.5 14-3 3 3 3"></path><path d="m8.5 17h8"></path></svg>
            </a>
            <ul class="space-y-2">
                <li class="group relative">
                    <a href="/lexifile_portal" class="flex justify-center items-center h-12 w-12 bg-indigo-100 text-indigo-600 rounded-lg">
                        <i data-lucide="layout-grid"></i>
                    </a>
                    <span class="absolute left-full ml-4 w-auto p-2 min-w-max rounded-md shadow-md text-white bg-gray-900 text-xs font-bold transition-all duration-100 scale-0 origin-left group-hover:scale-100">
                      Dashboard
                    </span>
                </li>
                <li class="group relative">
                    <a href="#" class="flex justify-center items-center h-12 w-12 hover:bg-gray-100 text-gray-500 hover:text-gray-800 rounded-lg transition-colors">
                        <i data-lucide="history"></i>
                    </a>
                     <span class="absolute left-full ml-4 w-auto p-2 min-w-max rounded-md shadow-md text-white bg-gray-900 text-xs font-bold transition-all duration-100 scale-0 origin-left group-hover:scale-100">
                      Batch History
                    </span>
                </li>
                <li class="group relative">
                    <a href="#" class="flex justify-center items-center h-12 w-12 hover:bg-gray-100 text-gray-500 hover:text-gray-800 rounded-lg transition-colors">
                        <i data-lucide="file-cog"></i>
                    </a>
                     <span class="absolute left-full ml-4 w-auto p-2 min-w-max rounded-md shadow-md text-white bg-gray-900 text-xs font-bold transition-all duration-100 scale-0 origin-left group-hover:scale-100">
                      Custom Rules
                    </span>
                </li>
                 <li class="group relative">
                    <a href="#" class="flex justify-center items-center h-12 w-12 hover:bg-gray-100 text-gray-500 hover:text-gray-800 rounded-lg transition-colors">
                        <i data-lucide="share-2"></i>
                    </a>
                     <span class="absolute left-full ml-4 w-auto p-2 min-w-max rounded-md shadow-md text-white bg-gray-900 text-xs font-bold transition-all duration-100 scale-0 origin-left group-hover:scale-100">
                      Integrations
                    </span>
                </li>
            </ul>
             <ul class="mt-auto space-y-2">
                 <li class="group relative">
                    <a href="#" class="flex justify-center items-center h-12 w-12 hover:bg-gray-100 text-gray-500 hover:text-gray-800 rounded-lg transition-colors">
                        <i data-lucide="help-circle"></i>
                    </a>
                     <span class="absolute left-full ml-4 w-auto p-2 min-w-max rounded-md shadow-md text-white bg-gray-900 text-xs font-bold transition-all duration-100 scale-0 origin-left group-hover:scale-100">
                      Help & Support
                    </span>
                </li>
             </ul>
        </nav>

        <div id="appPage" class="flex-1 flex flex-col">
            <!-- App Header -->
            <header class="flex-shrink-0 bg-white border-b border-gray-200 p-3 flex justify-between items-center">
                <div>
                     <h1 class="font-bold text-lg text-gray-800">Document Renaming</h1>
                </div>
                <div class="flex items-center space-x-4 relative">
                    <button id="downloadBtn" disabled class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition shadow-sm disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center space-x-2">
                        <i data-lucide="download"></i>
                        <span>Download (.zip)</span>
                    </button>
                    <img id="profileButton" src="https://placehold.co/32x32/E0E7FF/4F46E5?text=JA" class="rounded-full cursor-pointer" alt="User Avatar">
                    <!-- Profile Pop-up -->
                    <div id="profilePopup" class="hidden absolute top-full right-0 mt-2 w-48 bg-white rounded-md shadow-lg border border-gray-200 z-10">
                        <div class="py-1">
                            <a href="/lexifile_profile" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                <i data-lucide="user" class="mr-2 h-4 w-4"></i> View Profile
                            </a>
                            <a href="#" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                <i data-lucide="settings" class="mr-2 h-4 w-4"></i> Settings
                            </a>
                            <a href="/lexifile_login" class="flex items-center px-4 py-2 text-sm text-red-600 hover:bg-gray-100">
                                <i data-lucide="log-out" class="mr-2 h-4 w-4"></i> Log Out
                            </a>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Main Content Grid -->
            <main class="flex-grow flex min-h-0">
                <!-- Panel 1: File Queue -->
                <div class="w-1/3 border-r border-gray-200 flex flex-col bg-white">
                    <div class="p-4 border-b border-gray-200 flex-shrink-0">
                        <label for="fileUpload" class="w-full cursor-pointer bg-blue-50 text-blue-700 border-2 border-dashed border-blue-200 rounded-lg flex flex-col items-center justify-center p-4 hover:bg-blue-100 transition">
                            <i data-lucide="upload" class="mb-2"></i>
                            <span class="font-semibold text-sm">Upload Documents</span>
                            <span class="text-xs">or drag and drop</span>
                        </label>
                        <input type="file" id="fileUpload" class="hidden" multiple>
                    </div>
                    <div id="fileQueue" class="flex-grow overflow-y-auto p-2 space-y-1">
                        <div id="fileQueuePlaceholder" class="text-center p-10 text-gray-500">
                            <i data-lucide="folder-open" class="mx-auto h-12 w-12 text-gray-400"></i>
                            <p class="mt-4 font-medium">Your document queue is empty.</p>
                            <p class="text-sm">Upload files to get started.</p>
                        </div>
                    </div>
                </div>

                <!-- Panel 2: Document Preview -->
                <div class="w-1/2 flex flex-col bg-gray-100">
                     <div class="flex-shrink-0 p-4 border-b border-gray-200 bg-white flex items-center justify-between">
                        <h2 class="font-semibold text-lg">Document Preview</h2>
                    </div>
                    <div class="flex-grow flex items-center justify-center p-4">
                        <div id="documentPreview" class="w-full h-full bg-white rounded-lg shadow-inner border border-gray-200 p-8 overflow-y-auto">
                            <div id="previewPlaceholder" class="h-full flex flex-col items-center justify-center text-gray-400">
                                <i data-lucide="file-text" class="h-16 w-16"></i>
                                <p class="mt-4 font-medium text-lg">Select a file to preview</p>
                            </div>
                            <div id="previewContent" class="hidden prose max-w-none"></div>
                        </div>
                    </div>
                </div>

                <!-- Panel 3: Smart Editor -->
                <div class="w-1/3 border-l border-gray-200 flex flex-col bg-white">
                    <div class="flex-shrink-0 p-4 border-b border-gray-200 bg-white">
                        <h2 class="font-semibold text-lg">Smart Editor</h2>
                    </div>
                    <div id="editorPanel" class="flex-grow p-6 space-y-6 overflow-y-auto">
                        <div id="editorPlaceholder" class="h-full flex flex-col items-center justify-center text-gray-400">
                            <i data-lucide="edit-3" class="h-16 w-16"></i>
                            <p class="mt-4 font-medium text-lg text-center">Select a file to edit</p>
                        </div>
                        <div id="editorForm" class="hidden space-y-6">
                            <div>
                                <label for="editorDate" class="block text-sm font-bold text-gray-800 mb-1">Date</label>
                                <input type="text" id="editorDate" placeholder="YYYYMMDD" class="w-full px-3 py-2 border border-gray-300 rounded-lg font-mono">
                            </div>
                            <div>
                                <label for="editorDocType" class="block text-sm font-bold text-gray-800 mb-1">Document Type</label>
                                <input type="text" id="editorDocType" list="docTypes" placeholder="e.g., Letter from X to Y" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                <datalist id="docTypes">
                                    <option value="Affidavit of Service"></option>
                                    <option value="Contract for Services"></option>
                                    <option value="Letter from X to Y"></option>
                                </datalist>
                            </div>
                            <div>
                                <label for="editorDescription" class="block text-sm font-bold text-gray-800 mb-1">Description</label>
                                <textarea id="editorDescription" placeholder="e.g., Security for Costs" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg"></textarea>
                            </div>
                            <div class="pt-4 border-t border-gray-200">
                                 <h4 class="text-sm font-bold text-gray-800 mb-2">Live Filename Preview</h4>
                                 <div class="p-3 bg-gray-100 rounded-lg text-gray-700 text-sm break-all font-mono">
                                    <span id="previewDate"></span> - 
                                    <span id="previewDocType"></span> - 
                                    <span id="previewDescription"></span>.
                                    <span id="previewExtension"></span>
                                 </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <div id="toast" class="fixed top-5 right-5 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg opacity-0 transform translate-y-2 transition-all duration-300">
        <span id="toastMessage"></span>
    </div>

    <script>
        // --- CONFIGURATION ---
        // **IMPORTANT**: This URL must point to where your lexifile_server.py is running.
        // If you run it on a different port, change it here.
        const API_BASE_URL = 'http://127.0.0.1:8000'; 
        // --- END CONFIGURATION ---

        const state = {
            files: [],
            selectedFileId: null,
        };

        const fileUpload = document.getElementById('fileUpload');
        const fileQueue = document.getElementById('fileQueue');
        const fileQueuePlaceholder = document.getElementById('fileQueuePlaceholder');
        const previewPlaceholder = document.getElementById('previewPlaceholder');
        const previewContent = document.getElementById('previewContent');
        const editorPlaceholder = document.getElementById('editorPlaceholder');
        const editorForm = document.getElementById('editorForm');
        const editorDate = document.getElementById('editorDate');
        const editorDocType = document.getElementById('editorDocType');
        const editorDescription = document.getElementById('editorDescription');
        const previewDate = document.getElementById('previewDate');
        const previewDocType = document.getElementById('previewDocType');
        const previewDescription = document.getElementById('previewDescription');
        const previewExtension = document.getElementById('previewExtension');
        const downloadBtn = document.getElementById('downloadBtn');
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toastMessage');
        const profileButton = document.getElementById('profileButton');
        const profilePopup = document.getElementById('profilePopup');

        function getMockDocumentContent(fileData) {
            return `
                <h2 class="font-bold text-xl mb-4">${fileData.docType}</h2>
                <p class="text-sm text-gray-500 mb-6"><strong>Date:</strong> ${fileData.date.slice(0,4)}-${fileData.date.slice(4,6)}-${fileData.date.slice(6,8)}</p>
                <p>This is a simulated preview for <em>${fileData.originalName}</em>. The AI identified the content as relating to <strong>${fileData.description}</strong>.</p>
                <div class="p-4 bg-gray-100 border rounded-lg my-4">
                    <p>In a real production app, a high-fidelity, scrollable preview of the actual PDF or DOCX would be rendered here.</p>
                </div>
            `;
        }

        function renderFileQueue() {
            if (state.files.length === 0) {
                fileQueuePlaceholder.classList.remove('hidden');
                downloadBtn.disabled = true;
                return;
            }
            fileQueuePlaceholder.classList.add('hidden');
            const allApproved = state.files.length > 0 && state.files.every(f => f.status === 'approved');
            downloadBtn.disabled = !allApproved;


            fileQueue.innerHTML = state.files.map(file => {
                const isSelected = file.id === state.selectedFileId;
                const newName = `${file.date} - ${file.docType} - ${file.description}.${file.extension}`;
                let statusIcon;
                switch(file.status) {
                    case 'processing': statusIcon = `<div class="loader"></div>`; break;
                    case 'review': statusIcon = `<i data-lucide="alert-circle" class="text-yellow-500"></i>`; break;
                    case 'approved': statusIcon = `<i data-lucide="check-circle-2" class="text-green-500"></i>`; break;
                    case 'error': statusIcon = `<i data-lucide="x-circle" class="text-red-500"></i>`; break;
                }

                return `
                    <div class="file-item p-3 border-l-4 ${isSelected ? 'selected' : 'border-transparent'} rounded-md cursor-pointer hover:bg-gray-100 transition" data-id="${file.id}">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center space-x-2 min-w-0">
                                ${statusIcon}
                                <span class="text-sm font-medium text-gray-800 truncate" title="${file.originalName}">${file.originalName}</span>
                            </div>
                            <button class="approve-btn text-gray-400 hover:text-green-600 ${file.status === 'approved' || file.status === 'processing' ? 'hidden' : ''}" data-id="${file.id}" title="Approve">
                                <i data-lucide="check" class="h-5 w-5"></i>
                            </button>
                        </div>
                        <p class="text-xs text-blue-600 font-mono truncate" title="${newName}">${file.status === 'error' ? file.description : newName}</p>
                    </div>
                `;
            }).join('');
            lucide.createIcons();
        }

        function renderEditor() {
            if (!state.selectedFileId) {
                editorPlaceholder.classList.remove('hidden');
                editorForm.classList.add('hidden');
                previewPlaceholder.classList.remove('hidden');
                previewContent.classList.add('hidden');
                return;
            }
            
            const file = state.files.find(f => f.id === state.selectedFileId);
            if (!file || file.status === 'error') {
                 editorPlaceholder.classList.remove('hidden');
                 editorForm.classList.add('hidden');
                 previewContent.innerHTML = `<p class="text-red-500">Could not process this file.</p>`;
                 previewContent.classList.remove('hidden');
                 previewPlaceholder.classList.add('hidden');
                 return;
            };

            editorPlaceholder.classList.add('hidden');
            editorForm.classList.remove('hidden');
            previewPlaceholder.classList.add('hidden');
            previewContent.classList.remove('hidden');

            editorDate.value = file.date;
            editorDocType.value = file.docType;
            editorDescription.value = file.description;
            
            updateFilenamePreview();
            
            previewContent.innerHTML = getMockDocumentContent(file);
        }

        function updateFilenamePreview() {
            const file = state.files.find(f => f.id === state.selectedFileId);
            if (!file) return;
            
            previewDate.textContent = editorDate.value;
            previewDocType.textContent = editorDocType.value;
            previewDescription.textContent = editorDescription.value;
            previewExtension.textContent = file.extension;
        }

        async function handleFileUpload(e) {
            const uploadedFiles = e.target.files;
            if (uploadedFiles.length === 0) return;

            const newFiles = Array.from(uploadedFiles).map(file => ({
                id: crypto.randomUUID(),
                originalName: file.name,
                fileObject: file,
                extension: file.name.split('.').pop(),
                status: 'processing',
                date: '...',
                docType: 'Analyzing...',
                description: '...'
            }));
            
            state.files.push(...newFiles);
            renderFileQueue();

            for (const file of newFiles) {
                const formData = new FormData();
                formData.append('file', file.fileObject);

                try {
                    // **FIX**: Use the full, absolute URL to the backend API
                    const response = await fetch(`${API_BASE_URL}/rename-document`, {
                        method: 'POST',
                        body: formData,
                    });

                    if (!response.ok) {
                         const err = await response.json().catch(() => ({ detail: `Server error: ${response.statusText}` }));
                         throw new Error(err.detail);
                    }

                    const result = await response.json();
                    
                    const fileIndex = state.files.findIndex(f => f.id === file.id);
                    if (fileIndex > -1) {
                        state.files[fileIndex] = { ...state.files[fileIndex], ...result, status: 'review' };
                    }
                } catch (error) {
                    console.error('Error processing file:', error);
                    const fileIndex = state.files.findIndex(f => f.id === file.id);
                    if (fileIndex > -1) {
                        state.files[fileIndex].status = 'error';
                        state.files[fileIndex].description = error.message || 'Failed to analyze.';
                    }
                } finally {
                    renderFileQueue();
                }
            }
        }
        
        function handleFileSelect(e) {
            const target = e.target.closest('.file-item');
            if (!target) return;
            
            const fileId = target.dataset.id;
            const file = state.files.find(f => f.id === fileId);
            if (file && file.status !== 'processing') {
                state.selectedFileId = fileId;
                renderFileQueue();
                renderEditor();
            }
        }

        function handleEditorChange() {
            if (!state.selectedFileId) return;
            const fileIndex = state.files.findIndex(f => f.id === state.selectedFileId);
            if (fileIndex > -1) {
                state.files[fileIndex].date = editorDate.value;
                state.files[fileIndex].docType = editorDocType.value;
                state.files[fileIndex].description = editorDescription.value;
                state.files[fileIndex].status = 'review';
                renderFileQueue();
                updateFilenamePreview();
            }
        }
        
        function handleApprove(e) {
            const button = e.target.closest('.approve-btn');
            if (!button) return;
            e.stopPropagation();
            
            const fileId = button.dataset.id;
            const fileIndex = state.files.findIndex(f => f.id === fileId);
            if (fileIndex > -1) {
                state.files[fileIndex].status = 'approved';
                renderFileQueue();
            }
        }
        
        function handleDownload() {
            showToast('Download functionality is not yet implemented.');
        }

        function showToast(message, isError = false) {
            toastMessage.textContent = message;
            toast.className = `fixed top-5 right-5 text-white px-6 py-3 rounded-lg shadow-lg transition-all duration-300 ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            toast.classList.remove('opacity-0', 'translate-y-2');
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-2');
            }, 3000);
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            fileUpload.addEventListener('change', handleFileUpload);
            fileQueue.addEventListener('click', handleFileSelect);
            fileQueue.addEventListener('click', handleApprove);
            editorDate.addEventListener('input', handleEditorChange);
            editorDocType.addEventListener('input', handleEditorChange);
            editorDescription.addEventListener('input', handleEditorChange);
            downloadBtn.addEventListener('click', handleDownload);

            profileButton.addEventListener('click', (e) => {
                e.stopPropagation();
                profilePopup.classList.toggle('hidden');
            });

            document.addEventListener('click', (e) => {
                if (!profilePopup.contains(e.target) && e.target !== profileButton) {
                    profilePopup.classList.add('hidden');
                }
            });
        });
    </script>
</body>
</html>

