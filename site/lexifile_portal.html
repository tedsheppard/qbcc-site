<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal - LexiFile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- PDF.js and JSZip libraries for preview and download -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .file-item.selected {
            background-color: #eef2ff;
            border-left-color: #4f46e5;
        }
        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #4f46e5;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .group:hover .group-hover\:scale-100 { transform: scale(1); }
        /* Custom scrollbar for webkit browsers */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        #pdf-viewer canvas {
            margin-bottom: 8px;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 overflow-hidden">
    <div class="h-screen flex flex-col md:flex-row">
        <!-- Sidebar Navigation -->
        <nav class="w-full md:w-20 bg-white border-b md:border-b-0 md:border-r border-gray-200 flex flex-row md:flex-col items-center py-2 md:py-4 flex-shrink-0">
            <a href="/lexifile_index" class="mb-0 md:mb-8 mx-4 md:mx-0">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-500"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><path d="m11.5 14-3 3 3 3"></path><path d="m8.5 17h8"></path></svg>
            </a>
            <ul class="flex flex-row md:flex-col space-x-2 md:space-x-0 md:space-y-2">
                <li class="group relative">
                    <a href="/lexifile_portal" class="flex justify-center items-center h-12 w-12 bg-indigo-100 text-indigo-600 rounded-lg">
                        <i data-lucide="layout-grid"></i>
                    </a>
                    <span class="absolute top-full md:left-full mt-2 md:mt-0 md:ml-4 w-auto p-2 min-w-max rounded-md shadow-md text-white bg-gray-900 text-xs font-bold transition-all duration-100 scale-0 origin-left group-hover:scale-100">
                      Dashboard
                    </span>
                </li>
                <li class="group relative">
                    <a href="#" class="flex justify-center items-center h-12 w-12 hover:bg-gray-100 text-gray-500 hover:text-gray-800 rounded-lg transition-colors">
                        <i data-lucide="history"></i>
                    </a>
                     <span class="absolute top-full md:left-full mt-2 md:mt-0 md:ml-4 w-auto p-2 min-w-max rounded-md shadow-md text-white bg-gray-900 text-xs font-bold transition-all duration-100 scale-0 origin-left group-hover:scale-100">
                      Batch History
                    </span>
                </li>
                <li class="group relative">
                    <a href="#" class="flex justify-center items-center h-12 w-12 hover:bg-gray-100 text-gray-500 hover:text-gray-800 rounded-lg transition-colors">
                        <i data-lucide="file-cog"></i>
                    </a>
                     <span class="absolute top-full md:left-full mt-2 md:mt-0 md:ml-4 w-auto p-2 min-w-max rounded-md shadow-md text-white bg-gray-900 text-xs font-bold transition-all duration-100 scale-0 origin-left group-hover:scale-100">
                      Custom Rules
                    </span>
                </li>
                 <li class="group relative">
                    <a href="#" class="flex justify-center items-center h-12 w-12 hover:bg-gray-100 text-gray-500 hover:text-gray-800 rounded-lg transition-colors">
                        <i data-lucide="share-2"></i>
                    </a>
                     <span class="absolute top-full md:left-full mt-2 md:mt-0 md:ml-4 w-auto p-2 min-w-max rounded-md shadow-md text-white bg-gray-900 text-xs font-bold transition-all duration-100 scale-0 origin-left group-hover:scale-100">
                      Integrations
                    </span>
                </li>
            </ul>
             <ul class="hidden md:flex mt-auto space-y-2">
                 <li class="group relative">
                    <a href="#" class="flex justify-center items-center h-12 w-12 hover:bg-gray-100 text-gray-500 hover:text-gray-800 rounded-lg transition-colors">
                        <i data-lucide="help-circle"></i>
                    </a>
                     <span class="absolute left-full ml-4 w-auto p-2 min-w-max rounded-md shadow-md text-white bg-gray-900 text-xs font-bold transition-all duration-100 scale-0 origin-left group-hover:scale-100">
                      Help & Support
                    </span>
                </li>
             </ul>
        </nav>

        <div id="appPage" class="flex-1 flex flex-col min-h-0">
            <!-- App Header -->
            <header class="flex-shrink-0 bg-white border-b border-gray-200 p-3 flex justify-between items-center">
                <div>
                     <h1 class="font-bold text-lg text-gray-800">Document Renaming</h1>
                </div>
                <div class="flex items-center space-x-4 relative">
                    <button id="downloadBtn" disabled class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition shadow-sm disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center space-x-2">
                        <i data-lucide="download"></i>
                        <span>Download (.zip)</span>
                    </button>
                    <img id="profileButton" src="https://placehold.co/32x32/E0E7FF/4F46E5?text=JA" class="rounded-full cursor-pointer" alt="User Avatar">
                    <!-- Profile Pop-up -->
                    <div id="profilePopup" class="hidden absolute top-full right-0 mt-2 w-48 bg-white rounded-md shadow-lg border border-gray-200 z-10">
                        <div class="py-1">
                            <a href="/lexifile_profile" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                <i data-lucide="user" class="mr-2 h-4 w-4"></i> View Profile
                            </a>
                            <a href="#" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                <i data-lucide="settings" class="mr-2 h-4 w-4"></i> Settings
                            </a>
                            <a href="/lexifile_login" class="flex items-center px-4 py-2 text-sm text-red-600 hover:bg-gray-100">
                                <i data-lucide="log-out" class="mr-2 h-4 w-4"></i> Log Out
                            </a>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Main Content Grid -->
            <main class="flex-grow flex flex-col md:flex-row min-h-0">
                <!-- Panel 1: File Queue -->
                <div class="w-full md:w-1/3 border-b md:border-b-0 md:border-r border-gray-200 flex flex-col bg-white">
                    <div class="p-4 border-b border-gray-200 flex-shrink-0">
                        <label for="fileUpload" class="w-full cursor-pointer bg-blue-50 text-blue-700 border-2 border-dashed border-blue-200 rounded-lg flex flex-col items-center justify-center p-4 hover:bg-blue-100 transition">
                            <i data-lucide="upload" class="mb-2"></i>
                            <span class="font-semibold text-sm">Upload Documents</span>
                            <span class="text-xs">or drag and drop</span>
                        </label>
                        <input type="file" id="fileUpload" class="hidden" multiple>
                    </div>
                    <div id="fileQueue" class="flex-grow overflow-y-auto p-2 space-y-1">
                        <div id="fileQueuePlaceholder" class="text-center p-10 text-gray-500">
                            <i data-lucide="folder-open" class="mx-auto h-12 w-12 text-gray-400"></i>
                            <p class="mt-4 font-medium">Your document queue is empty.</p>
                            <p class="text-sm">Upload files to get started.</p>
                        </div>
                    </div>
                </div>

                <!-- Panel 2: Document Preview -->
                <div class="w-full md:w-1/2 flex flex-col bg-gray-100">
                     <div class="flex-shrink-0 p-4 border-b border-gray-200 bg-white flex items-center justify-between">
                        <h2 class="font-semibold text-lg">Document Preview</h2>
                    </div>
                    <div class="flex-grow flex items-center justify-center p-4 min-h-0">
                        <div class="w-full h-full bg-white rounded-lg shadow-inner border border-gray-200 p-6 overflow-y-auto">
                            <div id="previewPlaceholder" class="h-full flex flex-col items-center justify-center text-gray-400">
                                <i data-lucide="file-text" class="h-16 w-16"></i>
                                <p class="mt-4 font-medium text-lg">Select a file to preview</p>
                            </div>
                            <div id="previewContent" class="hidden">
                                <!-- AI Content and Real Preview will be injected here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Panel 3: Smart Editor -->
                <div class="w-full md:w-1/3 border-t md:border-t-0 md:border-l border-gray-200 flex flex-col bg-white">
                    <div class="flex-shrink-0 p-4 border-b border-gray-200 bg-white">
                        <h2 class="font-semibold text-lg">Smart Editor</h2>
                    </div>
                    <div id="editorPanel" class="flex-grow p-6 overflow-y-auto">
                        <div id="editorPlaceholder" class="h-full flex flex-col items-center justify-center text-gray-400">
                            <i data-lucide="edit-3" class="h-16 w-16"></i>
                            <p class="mt-4 font-medium text-lg text-center">Select a file to edit</p>
                        </div>
                        <div id="editorForm" class="hidden space-y-5">
                            <div>
                                <label for="editorDate" class="block text-sm font-bold text-gray-800 mb-1">Date</label>
                                <input type="text" id="editorDate" placeholder="YYYYMMDD" class="w-full px-3 py-2 border border-gray-300 rounded-lg font-mono">
                            </div>
                            <div>
                                <label for="editorDocType" class="block text-sm font-bold text-gray-800 mb-1">Document Type</label>
                                <input type="text" id="editorDocType" list="docTypes" placeholder="e.g., Letter from X to Y" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                <datalist id="docTypes">
                                    <option value="Affidavit of Service"></option>
                                    <option value="Contract between X and Y"></option>
                                    <option value="Letter from X to Y"></option>
                                    <option value="Email from X to Y"></option>
                                </datalist>
                            </div>
                            <div>
                                <label for="editorDescription" class="block text-sm font-bold text-gray-800 mb-1">Description</label>
                                <textarea id="editorDescription" placeholder="e.g., Security for Costs" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg"></textarea>
                            </div>
                             <div class="pt-4 border-t border-gray-200">
                                 <h4 class="text-sm font-bold text-gray-800 mb-2">Live Filename Preview</h4>
                                 <div class="p-3 bg-gray-100 rounded-lg text-gray-700 text-sm break-all font-mono">
                                    <span id="previewDate"></span> - 
                                    <span id="previewDocType"></span> - 
                                    <span id="previewDescription"></span>.
                                    <span id="previewExtension"></span>
                                 </div>
                            </div>
                             <!-- Editable Properties Section -->
                            <div id="metadataEditor" class="pt-4 border-t border-gray-200">
                                <h4 class="text-sm font-bold text-gray-800 mb-3">Editable Properties</h4>
                                <div class="space-y-3 text-sm">
                                    <div class="grid grid-cols-3 items-center">
                                        <label for="metaPrivileged" class="font-medium text-gray-600 col-span-1">Privileged</label>
                                        <select id="metaPrivileged" class="col-span-2 w-full px-2 py-1 border border-gray-300 rounded-md">
                                            <option value="No">No</option>
                                            <option value="Yes">Yes</option>
                                        </select>
                                    </div>
                                    <div class="grid grid-cols-3 items-center">
                                        <label for="metaAuthor" class="font-medium text-gray-600 col-span-1">Author</label>
                                        <input type="text" id="metaAuthor" class="col-span-2 w-full px-2 py-1 border border-gray-300 rounded-md">
                                    </div>
                                    <div class="grid grid-cols-3 items-center">
                                        <label for="metaCreated" class="font-medium text-gray-600 col-span-1">Created</label>
                                        <input type="text" id="metaCreated" class="col-span-2 w-full px-2 py-1 border border-gray-300 rounded-md">
                                    </div>
                                    <div class="grid grid-cols-3 items-center">
                                        <label for="metaModified" class="font-medium text-gray-600 col-span-1">Modified</label>
                                        <input type="text" id="metaModified" class="col-span-2 w-full px-2 py-1 border border-gray-300 rounded-md">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <div id="toast" class="fixed top-5 right-5 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg opacity-0 transform translate-y-2 transition-all duration-300">
        <span id="toastMessage"></span>
    </div>

    <script>
        // Set workerSrc for PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js`;

        const state = {
            files: [],
            selectedFileId: null,
        };

        // --- DOM Elements ---
        const fileUpload = document.getElementById('fileUpload');
        const fileQueue = document.getElementById('fileQueue');
        const fileQueuePlaceholder = document.getElementById('fileQueuePlaceholder');
        const previewPlaceholder = document.getElementById('previewPlaceholder');
        const previewContent = document.getElementById('previewContent');
        const editorPlaceholder = document.getElementById('editorPlaceholder');
        const editorForm = document.getElementById('editorForm');
        const editorDate = document.getElementById('editorDate');
        const editorDocType = document.getElementById('editorDocType');
        const editorDescription = document.getElementById('editorDescription');
        const previewDate = document.getElementById('previewDate');
        const previewDocType = document.getElementById('previewDocType');
        const previewDescription = document.getElementById('previewDescription');
        const previewExtension = document.getElementById('previewExtension');
        const downloadBtn = document.getElementById('downloadBtn');
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toastMessage');
        const profileButton = document.getElementById('profileButton');
        const profilePopup = document.getElementById('profilePopup');
        const metaPrivileged = document.getElementById('metaPrivileged');
        const metaAuthor = document.getElementById('metaAuthor');
        const metaCreated = document.getElementById('metaCreated');
        const metaModified = document.getElementById('metaModified');

        // --- Render Functions ---
        function renderFileQueue() {
            if (state.files.length === 0) {
                fileQueuePlaceholder.classList.remove('hidden');
                downloadBtn.disabled = true;
                return;
            }
            fileQueuePlaceholder.classList.add('hidden');
            const allApproved = state.files.length > 0 && state.files.every(f => f.status === 'approved');
            downloadBtn.disabled = !allApproved;


            fileQueue.innerHTML = state.files.map(file => {
                const isSelected = file.id === state.selectedFileId;
                const newName = `${file.date} - ${file.docType} - ${file.description}.${file.extension}`;
                let statusIcon;
                switch(file.status) {
                    case 'processing': statusIcon = `<div class="loader"></div>`; break;
                    case 'review': statusIcon = `<i data-lucide="alert-circle" class="text-yellow-500"></i>`; break;
                    case 'approved': statusIcon = `<i data-lucide="check-circle-2" class="text-green-500"></i>`; break;
                    case 'error': statusIcon = `<i data-lucide="x-circle" class="text-red-500"></i>`; break;
                }

                return `
                    <div class="file-item p-3 border-l-4 ${isSelected ? 'selected' : 'border-transparent'} rounded-md cursor-pointer hover:bg-gray-100 transition" data-id="${file.id}">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center space-x-2 min-w-0">
                                ${statusIcon}
                                <span class="text-sm font-medium text-gray-800 truncate" title="${file.originalName}">${file.originalName}</span>
                            </div>
                            <button class="approve-btn text-gray-400 hover:text-green-600 ${file.status === 'approved' || file.status === 'processing' ? 'hidden' : ''}" data-id="${file.id}" title="Approve">
                                <i data-lucide="check" class="h-5 w-5"></i>
                            </button>
                        </div>
                        <p class="text-xs text-blue-600 font-mono truncate" title="${newName}">${file.status === 'error' ? file.description : newName}</p>
                    </div>
                `;
            }).join('');
            lucide.createIcons();
        }

        async function renderEditorAndPreview() {
            if (!state.selectedFileId) {
                editorPlaceholder.classList.remove('hidden');
                editorForm.classList.add('hidden');
                previewPlaceholder.classList.remove('hidden');
                previewContent.classList.add('hidden');
                return;
            }
            
            const file = state.files.find(f => f.id === state.selectedFileId);
            if (!file || file.status === 'error') {
                 editorPlaceholder.classList.remove('hidden');
                 editorForm.classList.add('hidden');
                 previewContent.innerHTML = `<div class="text-red-600 p-4 bg-red-50 rounded-lg">
                    <p class="font-bold mb-2">Could not process this file.</p>
                    <p class="text-sm">${file ? file.description : 'An unknown error occurred.'}</p>
                 </div>`;
                 previewContent.classList.remove('hidden');
                 previewPlaceholder.classList.add('hidden');
                 return;
            };

            // Show form, hide placeholders
            editorPlaceholder.classList.add('hidden');
            editorForm.classList.remove('hidden');
            previewPlaceholder.classList.add('hidden');
            previewContent.classList.remove('hidden');

            // --- Populate Editor Form ---
            editorDate.value = file.date;
            editorDocType.value = file.docType;
            editorDescription.value = file.description;
            
            // --- Populate Metadata ---
            metaPrivileged.value = file.metadata.privileged || 'No';
            metaAuthor.value = file.metadata.author || '';
            metaCreated.value = file.metadata.createdDate || '';
            metaModified.value = file.metadata.lastModified || '';
            
            updateFilenamePreview();
            
            // --- Populate Preview Panel ---
            const keywordsHTML = file.keywords.map(kw => `<span class="inline-block bg-indigo-100 text-indigo-700 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">${kw}</span>`).join('');

            previewContent.innerHTML = `
                <div class="mb-6">
                    <h3 class="text-sm font-bold text-gray-800 mb-2">AI Summary</h3>
                    <p class="text-gray-600 text-sm">${file.summary || 'No summary available.'}</p>
                </div>
                 <div class="mb-8">
                    <h3 class="text-sm font-bold text-gray-800 mb-2">Keywords</h3>
                    <div class="flex flex-wrap">${keywordsHTML}</div>
                </div>
                <div class="border-t border-gray-200 pt-6">
                    <h3 class="text-sm font-bold text-gray-800 mb-2">Document Body Preview</h3>
                    <div id="actual-preview-container" class="bg-gray-50 border rounded-lg text-sm text-gray-500 overflow-auto">
                        <!-- Real preview will be rendered here -->
                    </div>
                </div>
            `;

            const previewContainer = document.getElementById('actual-preview-container');
            previewContainer.innerHTML = '<div class="p-4">Loading preview...</div>';

            try {
                const fileURL = URL.createObjectURL(file.fileObject);
                const fileType = file.fileObject.type;

                if (fileType === 'application/pdf') {
                    const pdfViewer = document.createElement('div');
                    pdfViewer.id = 'pdf-viewer';
                    previewContainer.innerHTML = '';
                    previewContainer.appendChild(pdfViewer);

                    const loadingTask = pdfjsLib.getDocument(fileURL);
                    const pdf = await loadingTask.promise;
                    
                    for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                        const page = await pdf.getPage(pageNum);
                        const viewport = page.getViewport({ scale: 1.5 });
                        const canvas = document.createElement('canvas');
                        const context = canvas.getContext('2d');
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;

                        pdfViewer.appendChild(canvas);

                        await page.render({ canvasContext: context, viewport: viewport }).promise;
                    }

                } else if (fileType.startsWith('image/')) {
                    previewContainer.innerHTML = `<img src="${fileURL}" class="max-w-full h-auto rounded-lg">`;
                } else {
                    previewContainer.innerHTML = '<div class="p-4">Preview is not available for this file type.</div>';
                }

            } catch(e) {
                console.error("Preview failed:", e);
                previewContainer.innerHTML = `<div class="p-4 text-red-600">Failed to render preview. The file may be corrupted.</div>`;
            }
        }

        function updateFilenamePreview() {
            const file = state.files.find(f => f.id === state.selectedFileId);
            if (!file) return;
            
            previewDate.textContent = editorDate.value;
            previewDocType.textContent = editorDocType.value;
            previewDescription.textContent = editorDescription.value;
            previewExtension.textContent = file.extension;
        }
        
        // --- Event Handlers ---
        async function handleFileUpload(e) {
            const uploadedFiles = e.target.files;
            if (uploadedFiles.length === 0) return;

            const newFiles = Array.from(uploadedFiles).map(file => ({
                id: crypto.randomUUID(),
                originalName: file.name,
                fileObject: file,
                extension: file.name.split('.').pop(),
                status: 'processing',
                date: '...',
                docType: 'Analyzing...',
                description: '...',
                summary: '',
                keywords: [],
                metadata: {}
            }));
            
            state.files.push(...newFiles);
            renderFileQueue();

            for (const file of newFiles) {
                const formData = new FormData();
                formData.append('file', file.fileObject);

                try {
                    const response = await fetch(`/rename-document`, {
                        method: 'POST',
                        body: formData,
                    });

                    if (!response.ok) {
                         const err = await response.json().catch(() => ({ detail: `Server error: ${response.statusText}` }));
                         throw new Error(err.detail);
                    }
                    
                    const result = await response.json();
                    
                    const fileIndex = state.files.findIndex(f => f.id === file.id);
                    if (fileIndex > -1) {
                        state.files[fileIndex] = { ...state.files[fileIndex], ...result, status: 'review' };
                    }
                } catch (error) {
                    console.error('Error processing file:', error);
                    const fileIndex = state.files.findIndex(f => f.id === file.id);
                    if (fileIndex > -1) {
                        state.files[fileIndex].status = 'error';
                        state.files[fileIndex].description = error.message || 'Failed to analyze.';
                    }
                } finally {
                    renderFileQueue();
                    if (state.files.length === 1) { // Auto-select the first file
                        state.selectedFileId = file.id;
                        renderEditorAndPreview();
                        renderFileQueue(); // re-render to show selection
                    }
                    if (state.selectedFileId === file.id) {
                        renderEditorAndPreview();
                    }
                }
            }
        }
        
        function handleFileSelect(e) {
            const target = e.target.closest('.file-item');
            if (!target) return;
            
            const fileId = target.dataset.id;
            const file = state.files.find(f => f.id === fileId);
            if (file && file.status !== 'processing') {
                state.selectedFileId = fileId;
                renderFileQueue();
                renderEditorAndPreview();
            }
        }

        function handleEditorChange() {
            if (!state.selectedFileId) return;
            const fileIndex = state.files.findIndex(f => f.id === state.selectedFileId);
            if (fileIndex > -1) {
                // Update filename parts
                state.files[fileIndex].date = editorDate.value;
                state.files[fileIndex].docType = editorDocType.value;
                state.files[fileIndex].description = editorDescription.value;
                
                // Update metadata parts
                state.files[fileIndex].metadata.privileged = metaPrivileged.value;
                state.files[fileIndex].metadata.author = metaAuthor.value;
                state.files[fileIndex].metadata.createdDate = metaCreated.value;
                state.files[fileIndex].metadata.lastModified = metaModified.value;

                state.files[fileIndex].status = 'review';
                renderFileQueue();
                updateFilenamePreview();
            }
        }
        
        function handleApprove(e) {
            const button = e.target.closest('.approve-btn');
            if (!button) return;
            e.stopPropagation();
            
            const fileId = button.dataset.id;
            const fileIndex = state.files.findIndex(f => f.id === fileId);
            if (fileIndex > -1) {
                state.files[fileIndex].status = 'approved';
                renderFileQueue();
            }
        }
        
        async function handleDownload() {
            if (downloadBtn.disabled) return;

            const approvedFiles = state.files.filter(f => f.status === 'approved');
            if (approvedFiles.length === 0) {
                showToast("No approved files to download.", true);
                return;
            }

            showToast("Preparing your download...", false);
            const zip = new JSZip();
            
            for (const file of approvedFiles) {
                const newName = `${file.date} - ${file.docType} - ${file.description}.${file.extension}`;
                zip.file(newName, file.fileObject);
            }

            try {
                const content = await zip.generateAsync({ type: "blob" });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(content);
                link.download = "LexiFile_Export.zip";
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (e) {
                console.error("Failed to create zip file", e);
                showToast("Error creating zip file.", true);
            }
        }

        function showToast(message, isError = false) {
            toastMessage.textContent = message;
            toast.className = `fixed top-5 right-5 text-white px-6 py-3 rounded-lg shadow-lg transition-all duration-300 ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            toast.classList.remove('opacity-0', 'translate-y-2');
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-2');
            }, 3000);
        }
        
        // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            fileUpload.addEventListener('change', handleFileUpload);
            fileQueue.addEventListener('click', handleFileSelect);
            fileQueue.addEventListener('click', handleApprove);
            
            const editorFields = [editorDate, editorDocType, editorDescription, metaPrivileged, metaAuthor, metaCreated, metaModified];
            editorFields.forEach(field => field.addEventListener('input', handleEditorChange));

            downloadBtn.addEventListener('click', handleDownload);

            // Profile popup logic
            profileButton.addEventListener('click', (e) => {
                e.stopPropagation();
                profilePopup.classList.toggle('hidden');
            });
            document.addEventListener('click', (e) => {
                if (!profilePopup.contains(e.target) && e.target !== profileButton) {
                    profilePopup.classList.add('hidden');
                }
            });
        });
    </script>
</body>
</html>

