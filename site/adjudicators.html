<!DOCTYPE html>
<html lang="en">
<head>
  <script>if(sessionStorage.getItem("nt-transitioning")){var s=document.createElement("style");s.id="nt-precover";s.textContent="html{background:#0a0a0a!important}body{visibility:hidden!important}";document.head.appendChild(s)}</script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Adjudicators | Sopal</title>
  <meta name="description" content="Explore adjudicator insights, decision statistics, and AI-powered insights to understand decision-making patterns under Queensland's BIF Act.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;450;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg-dark: #0a0a0a;
      --bg-darker: #050505;
      --bg-card-dark: #141414;
      --bg-light: #ffffff;
      --green: #00d47e;
      --green-dark: #00b368;
      --text-primary: #1a1a1a;
      --text-secondary: #6b6b6b;
      --text-muted: #888;
      --border-light: #e5e5e5;
      --border-dark: #222;
    }
    body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; color: var(--text-primary); background: #fafafa; line-height: 1.5; -webkit-font-smoothing: antialiased; margin: 0; }
    a { text-decoration: none; color: inherit; }
    button { border: none; cursor: pointer; font-family: inherit; }

    /* NAV */
    .nav { background: var(--bg-dark); border-bottom: 1px solid rgba(255,255,255,0.06); position: sticky; top: 0; z-index: 100; }
    .nav-inner { display: flex; align-items: center; justify-content: space-between; height: 56px; max-width: 1200px; margin: 0 auto; padding: 0 32px; }
    .nav-left { display: flex; align-items: center; gap: 32px; }
    .nav-logo { display: flex; align-items: center; gap: 8px; color: white; font-weight: 700; font-size: 17px; letter-spacing: -0.02em; }
    .nav-logo-icon { width: 28px; height: 28px; background: var(--green); border-radius: 7px; display: flex; align-items: center; justify-content: center; }
    .nav-logo-icon svg { width: 16px; height: 16px; }
    .nav-links { display: flex; align-items: center; gap: 24px; }
    .nav-links a { color: #999; font-size: 14px; font-weight: 450; transition: color 0.2s; }
    .nav-links a:hover { color: white; }
    .nav-links a.active { color: white; font-weight: 500; }
    .nav-right { display: flex; align-items: center; gap: 12px; }
    .btn-signin { background: transparent; color: white; font-size: 13.5px; font-weight: 500; padding: 7px 16px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); transition: all 0.2s; }
    .btn-signin:hover { background: rgba(255,255,255,0.08); }

    /* SPLIT LAYOUT */
    .split-layout { display: grid; grid-template-columns: 340px 1fr; height: calc(100vh - 56px); }

    /* SIDEBAR */
    .sidebar { background: white; border-right: 1px solid var(--border-light); display: flex; flex-direction: column; overflow: hidden; }
    .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border-light); }
    .sidebar-header h2 { font-size: 18px; font-weight: 700; letter-spacing: -0.02em; margin-bottom: 12px; }
    .sidebar-search { position: relative; }
    .sidebar-search input {
      width: 100%; padding: 9px 12px 9px 36px; font-size: 13px; font-family: inherit;
      border: 1px solid var(--border-light); border-radius: 8px; outline: none; transition: border-color 0.2s;
    }
    .sidebar-search input:focus { border-color: var(--green); }
    .sidebar-search svg { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); width: 15px; height: 15px; stroke: var(--text-muted); fill: none; stroke-width: 2; }
    .sidebar-controls { display: flex; gap: 8px; margin-top: 10px; }
    .sidebar-controls select {
      flex: 1; padding: 7px 10px; font-size: 12px; font-family: inherit; border: 1px solid var(--border-light);
      border-radius: 6px; background: white; cursor: pointer; appearance: none; -webkit-appearance: none;
      padding-right: 24px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 24 24' fill='none' stroke='%23888' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
      background-repeat: no-repeat; background-position: right 8px center;
    }
    .sidebar-list { flex: 1; overflow-y: auto; }
    .adj-item {
      padding: 14px 20px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: background 0.15s;
    }
    .adj-item:hover { background: #fafafa; }
    .adj-item.active { background: #f0fdf4; border-left: 3px solid var(--green); }
    .adj-item .adj-name { font-size: 14px; font-weight: 600; margin-bottom: 4px; display: flex; align-items: center; gap: 8px; }
    .adj-item .adj-stats { display: flex; gap: 14px; font-size: 11px; color: var(--text-muted); }
    .adj-item .adj-stats span { display: flex; align-items: center; gap: 3px; }

    /* DETAIL PANEL */
    .detail-panel { overflow-y: auto; padding: 32px; background: #fafafa; }
    .detail-panel.empty-state { display: flex; align-items: center; justify-content: center; }
    .detail-header { margin-bottom: 24px; }
    .detail-header h1 { font-size: 26px; font-weight: 700; letter-spacing: -0.02em; margin-bottom: 4px; }
    .detail-header .subtitle { font-size: 14px; color: var(--text-secondary); }

    /* TABS */
    .tabs { display: flex; gap: 0; border-bottom: 1px solid var(--border-light); margin-bottom: 24px; }
    .tab-btn {
      padding: 10px 18px; font-size: 13px; font-weight: 500; color: var(--text-muted);
      background: transparent; border-bottom: 2px solid transparent; transition: all 0.2s;
    }
    .tab-btn:hover { color: var(--text-primary); }
    .tab-btn.active { color: var(--text-primary); border-bottom-color: var(--green); font-weight: 600; }

    /* STAT CARDS */
    .stat-cards { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 24px; }
    .stat-card {
      background: white; border: 1px solid var(--border-light); border-radius: 10px; padding: 16px; position: relative; overflow: visible;
    }
    .stat-card .stat-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.03em; margin-bottom: 4px; }
    .stat-card .stat-value { font-size: 22px; font-weight: 700; letter-spacing: -0.02em; }
    .stat-card .stat-sub { font-size: 11px; color: var(--text-muted); margin-top: 2px; }

    /* INFO ICON & TOOLTIP */
    .info-icon {
      position: absolute; top: 8px; right: 8px; width: 16px; height: 16px;
      background: #e0e0e0; color: #666; border-radius: 50%; font-size: 11px; font-weight: bold;
      line-height: 16px; text-align: center; cursor: pointer; font-family: Arial, sans-serif;
    }
    .info-icon:hover .tooltip { opacity: 1; visibility: visible; }
    .tooltip {
      position: absolute; top: 25px; left: -75px; background: #333; color: white; padding: 12px 15px;
      border-radius: 6px; font-size: 11px; width: 180px; text-align: left; opacity: 0; visibility: hidden;
      transition: opacity 0.15s ease; z-index: 1000; line-height: 1.4; font-weight: normal; white-space: normal;
    }
    .tooltip::after {
      content: ''; position: absolute; top: -5px; left: 85px; width: 0; height: 0;
      border-left: 5px solid transparent; border-right: 5px solid transparent; border-bottom: 5px solid #333;
    }

    /* DECISIONS LIST */
    .decision-list-controls { display: flex; gap: 10px; align-items: center; margin-bottom: 16px; }
    .decision-search-wrap { position: relative; flex: 1; }
    .decision-search-wrap input {
      width: 100%; padding: 9px 12px 9px 36px; font-size: 13px; font-family: inherit;
      border: 1px solid var(--border-light); border-radius: 8px; outline: none; transition: border-color 0.2s;
    }
    .decision-search-wrap input:focus { border-color: var(--green); }
    .decision-search-wrap svg { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); width: 15px; height: 15px; stroke: var(--text-muted); fill: none; stroke-width: 2; }
    .decision-sort-select {
      padding: 9px 28px 9px 12px; font-size: 12px; font-family: inherit; border: 1px solid var(--border-light);
      border-radius: 8px; background: white; cursor: pointer; appearance: none; -webkit-appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 24 24' fill='none' stroke='%23888' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
      background-repeat: no-repeat; background-position: right 8px center;
    }
    .decision-search-btn {
      padding: 9px 16px; font-size: 12px; font-weight: 600; color: white; background: var(--green);
      border-radius: 8px; border: none; cursor: pointer; transition: background 0.2s;
    }
    .decision-search-btn:hover { background: var(--green-dark); }
    .decision-clear-btn {
      padding: 9px 16px; font-size: 12px; font-weight: 600; color: white; background: #6c757d;
      border-radius: 8px; border: none; cursor: pointer; transition: background 0.2s;
    }
    .decision-clear-btn:hover { background: #5a6268; }
    .decision-search-loading {
      position: absolute; top: 0; left: 0; width: 0%; height: 3px;
      background: linear-gradient(to right, var(--green), #00ffa3); transition: width 0.3s ease;
      z-index: 10; border-radius: 3px;
    }
    .decision-search-results { font-size: 13px; color: var(--text-muted); margin-bottom: 10px; display: none; }

    .decision-list-item {
      background: white; border: 1px solid var(--border-light); border-radius: 10px;
      padding: 16px 20px; margin-bottom: 10px; transition: box-shadow 0.2s;
    }
    .decision-list-item:hover { box-shadow: 0 2px 12px rgba(0,0,0,0.04); }
    .decision-list-item .dl-title { font-size: 14px; font-weight: 600; margin-bottom: 6px; }
    .decision-list-item .dl-meta { display: flex; gap: 14px; font-size: 12px; color: var(--text-muted); flex-wrap: wrap; }
    .decision-list-item .dl-actions { margin-top: 10px; font-size: 13px; }
    .decision-list-item .dl-actions a { color: #0066cc; cursor: pointer; }
    .decision-list-item .dl-actions a:hover { text-decoration: underline; }
    .decision-list-item .dl-actions .disabled { color: #999; cursor: not-allowed; }
    .decision-list-item .snippet { margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px; font-size: 12px; color: #333; }
    .decision-list-item .snippet mark { background-color: #d9f3e9; color: #008a5c; border-radius: 2px; padding: 1px 2px; }

    /* BLUR */
    .blur-value { filter: blur(6px); user-select: none; pointer-events: none; }
    .blur-stats .stat-card .stat-value { filter: blur(6px); user-select: none; pointer-events: none; }
    .blur-stats .dl-meta span { filter: blur(6px); user-select: none; pointer-events: none; }

    /* LOCKED OVERLAY */
    .locked-overlay {
      position: absolute; top: 60px; left: 50%; transform: translateX(-50%);
      background: white; border-radius: 14px; box-shadow: 0 10px 40px rgba(0,0,0,0.12);
      z-index: 10; max-width: 380px; width: 90%; display: none;
    }
    .blur-stats .locked-overlay { display: flex; }
    .locked-content { text-align: center; padding: 30px; width: 100%; }
    .locked-content h3 { font-size: 20px; font-weight: 700; margin-bottom: 10px; letter-spacing: -0.02em; }
    .locked-content p { color: var(--text-secondary); margin-bottom: 16px; line-height: 1.6; font-size: 14px; }
    .price-tag { font-size: 28px; font-weight: 800; color: var(--green); margin: 20px 0; letter-spacing: -0.02em; }
    .price-tag sup { font-size: 14px; font-weight: 600; }
    .unlock-btn {
      background: var(--green); color: white; border: none; padding: 13px 30px; border-radius: 10px;
      font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s; width: 100%;
    }
    .unlock-btn:hover { background: var(--green-dark); transform: translateY(-1px); box-shadow: 0 4px 14px rgba(0,212,126,0.3); }

    /* FREE DEMO BADGE */
    .badge-free { background: var(--green); color: white; font-size: 9px; padding: 2px 6px; border-radius: 4px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.03em; }

    /* AUTH MODAL */
    .auth-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; z-index: 1000; }
    .auth-modal.active { display: flex; }
    .auth-modal-content {
      background: white; padding: 36px; border-radius: 14px; max-width: 560px; width: 92%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.2); position: relative; max-height: 90vh; overflow-y: auto;
    }
    .auth-modal-close { position: absolute; top: 14px; right: 14px; background: none; border: none; font-size: 22px; cursor: pointer; color: #999; width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; transition: background 0.2s; }
    .auth-modal-close:hover { background: #f0f0f0; color: #333; }
    .auth-tabs { display: flex; margin-bottom: 24px; border-bottom: 1px solid var(--border-light); }
    .auth-tab { flex: 1; padding: 10px; background: none; border: none; border-bottom: 2px solid transparent; cursor: pointer; font-size: 15px; font-weight: 500; color: var(--text-muted); transition: all 0.2s; }
    .auth-tab.active { color: var(--green); border-bottom-color: var(--green); font-weight: 600; }
    .auth-form { display: none; }
    .auth-form.active { display: block; }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; margin-bottom: 5px; font-size: 13px; font-weight: 500; color: var(--text-primary); }
    .form-group input, .form-group select {
      width: 100%; padding: 10px 12px; border: 1px solid var(--border-light); border-radius: 8px;
      font-size: 14px; font-family: inherit; outline: none; transition: border-color 0.2s; box-sizing: border-box;
    }
    .form-group input:focus, .form-group select:focus { border-color: var(--green); }
    .form-group small { display: block; margin-top: 4px; font-size: 12px; color: var(--text-muted); }
    .auth-submit-btn {
      width: 100%; padding: 12px; background: var(--green); color: white; border: none; border-radius: 10px;
      font-size: 15px; font-weight: 600; cursor: pointer; transition: background 0.2s;
    }
    .auth-submit-btn:hover { background: var(--green-dark); }
    .auth-submit-btn:disabled { background: #ccc; cursor: not-allowed; }
    .auth-error { color: #dc3545; font-size: 13px; margin-top: 10px; }

    /* PAYMENT MODAL */
    .payment-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; z-index: 1000; }
    .payment-modal.active { display: flex; }
    .payment-modal-content {
      background: white; padding: 36px; border-radius: 14px; max-width: 480px; width: 92%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.2); position: relative;
    }
    .payment-modal-close { position: absolute; top: 14px; right: 14px; background: none; border: none; font-size: 22px; cursor: pointer; color: #999; width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; transition: background 0.2s; }
    .payment-modal-close:hover { background: #f0f0f0; color: #333; }
    .payment-modal-header { margin-bottom: 24px; }
    .payment-modal-header h2 { font-size: 22px; font-weight: 700; letter-spacing: -0.02em; margin-bottom: 8px; }
    #card-element { padding: 14px; border: 1px solid var(--border-light); border-radius: 8px; margin-bottom: 16px; background: white; }
    #card-errors { color: #dc3545; margin-top: 8px; font-size: 13px; }
    .pay-button {
      width: 100%; background: var(--green); color: white; border: none; padding: 14px; border-radius: 10px;
      font-size: 15px; font-weight: 600; cursor: pointer; transition: background 0.2s;
    }
    .pay-button:hover { background: var(--green-dark); }
    .pay-button:disabled { background: #ccc; cursor: not-allowed; }
    .terms-wrapper { margin-top: 16px; padding: 14px; background: #f9fafb; border-radius: 8px; border: 1px solid var(--border-light); }
    .terms-wrapper label { display: flex; align-items: flex-start; cursor: pointer; font-size: 13px; line-height: 1.5; gap: 10px; }
    .terms-wrapper input[type="checkbox"] { margin-top: 3px; cursor: pointer; accent-color: var(--green); }
    .terms-wrapper a { color: var(--green); text-decoration: underline; }

    /* SUCCESS MODAL */
    .success-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; z-index: 2000; }
    .success-modal.active { display: flex; }
    .success-modal-content {
      background: white; padding: 40px; border-radius: 14px; max-width: 440px; width: 92%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.2); text-align: center; position: relative;
    }
    .success-modal-content h2 { font-size: 22px; font-weight: 700; margin-bottom: 12px; color: var(--green); }
    .success-modal-content p { color: var(--text-secondary); font-size: 15px; line-height: 1.6; margin-bottom: 24px; }

    /* AI CHAT */
    .ai-container { border: 1px solid var(--border-light); border-radius: 10px; margin-top: 14px; overflow: hidden; }
    .chat-messages { max-height: 400px; overflow-y: auto; padding: 12px; display: flex; flex-direction: column; gap: 10px; }
    .message { display: flex; align-items: flex-start; gap: 10px; max-width: 90%; }
    .message-avatar { width: 30px; height: 30px; border-radius: 50%; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 600; }
    .ai-message .message-avatar { background: var(--green); color: white; }
    .user-message .message-avatar { background: #e8e8e8; color: #333; }
    .message-content { padding: 10px 14px; border-radius: 12px; font-size: 13px; line-height: 1.5; }
    .ai-message { align-self: flex-start; }
    .ai-message .message-content { background: #f0f0f0; color: #222; border-top-left-radius: 0; }
    .user-message { align-self: flex-end; flex-direction: row-reverse; }
    .user-message .message-content { background: #e8f5e9; color: #111; border-top-right-radius: 0; }
    .chat-input-area { display: flex; align-items: center; padding: 8px 12px; border-top: 1px solid var(--border-light); }
    .chat-input-area input { flex-grow: 1; border: none; background: transparent; padding: 10px; font-size: 13px; outline: none; color: #222; margin-right: 8px; font-family: inherit; }
    .chat-input-area button { background: var(--green); color: white; border: none; border-radius: 50%; width: 34px; height: 34px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background 0.2s; flex-shrink: 0; }
    .chat-input-area button:hover { background: var(--green-dark); }
    .ai-output-content p { margin: 4px 0 6px 0; }
    .ai-output-content strong { display: block; margin: 10px 0 4px 0; font-size: 14px; font-weight: 600; }
    .ai-output-content ul { margin: 4px 0 8px 18px; padding: 0; }
    .ai-output-content li { margin: 2px 0; }
    .loading-text-gradient {
      font-size: 14px; font-weight: 500; padding: 10px;
      background: linear-gradient(to right, #222 30%, #ccc 50%, #222 70%);
      background-size: 200% auto; color: transparent; background-clip: text; -webkit-background-clip: text;
      animation: shimmer 1s linear infinite; text-align: left;
    }
    @keyframes shimmer { to { background-position: -200% center; } }

    /* LOADING */
    .loading { text-align: center; padding: 20px; color: var(--text-muted); font-size: 14px; }
    .loading-spinner { display: inline-block; width: 18px; height: 18px; border: 2px solid #e8e8e8; border-top: 2px solid var(--green); border-radius: 50%; animation: spin 0.8s linear infinite; margin-right: 8px; vertical-align: middle; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* DETAIL CONTENT RELATIVE */
    .detail-content-wrap { position: relative; }

    /* RESPONSIVE */
    @media (max-width: 900px) {
      .nav-links { display: none; }
      .split-layout { grid-template-columns: 1fr; height: auto; }
      .sidebar { max-height: 400px; }
      .stat-cards { grid-template-columns: repeat(2, 1fr); }
    }

    .adj-pagination { display: flex; align-items: center; justify-content: center; gap: 6px; padding: 20px 0; flex-wrap: wrap; }
    .adj-pagination button { padding: 6px 12px; border: 1px solid var(--border-light); border-radius: 6px; background: white; font-size: 13px; cursor: pointer; font-family: inherit; transition: all 0.15s; color: var(--text-secondary); }
    .adj-pagination button:hover { background: #f5f5f5; color: var(--text-primary); }
    .adj-pagination button.active { background: var(--green); color: #000; border-color: var(--green); font-weight: 600; }
    .adj-pagination button:disabled { opacity: 0.4; cursor: default; }
    .adj-pagination .page-info { width: 100%; text-align: center; font-size: 12px; color: var(--text-muted); margin-top: 6px; }
  </style>
</head>
<body>

  <!-- NAV -->
  <nav class="nav">
    <div class="nav-inner">
      <div class="nav-left">
        <a href="/" class="nav-logo">
  <img src="/assets/sopal_logo_white_v1.png" alt="Sopal" style="height: 22px; width: auto;">
</a>
        <div class="nav-links">
          <a href="/search">Search</a>
          <a href="/adjudicators" class="active">Adjudicators</a>
          <a href="/interest-calculator">Interest Calculator</a>
          <a href="/due-date-calculator">Due Date Calculator</a>
          <a href="/how-to">How-To Guide</a>
          <a href="/feedback">Feedback</a>
        </div>
      </div>
      <div class="nav-right"><a href="#" class="btn-signin">Sign In</a></div>
    </div>
  </nav>

  <!-- SPLIT LAYOUT -->
  <div class="split-layout">

    <!-- SIDEBAR -->
    <div class="sidebar">
      <div class="sidebar-header">
        <h2>Adjudicators</h2>
        <div class="sidebar-search">
          <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
          <input type="text" id="adjudicatorSearch" placeholder="Search by name...">
        </div>
        <div class="sidebar-controls">
          <select id="sortBy">
            <option value="decisions">Sort: Most decisions</option>
            <option value="award_rate">Sort: Highest award rate</option>
            <option value="name">Sort: A-Z</option>
          </select>
        </div>
      </div>
      <div id="adjudicatorsList" class="sidebar-list">
        <!-- Populated by JS -->
      </div>
    </div>

    <!-- DETAIL PANEL -->
    <div id="rightPane" class="detail-panel empty-state">
      <p style="color: var(--text-muted); font-size: 15px;">Select an adjudicator to view detailed statistics and analysis</p>
    </div>
  </div>

  <!-- AUTH MODAL -->
  <div id="authModal" class="auth-modal">
    <div class="auth-modal-content">
      <button class="auth-modal-close" onclick="closeAuthModal()">&times;</button>
      <h2 style="text-align: center; font-size: 20px; font-weight: 700; letter-spacing: -0.02em; margin-bottom: 6px;">Access Required</h2>
      <p style="text-align: center; color: var(--text-muted); margin-bottom: 20px; font-size: 14px;">Create an account or login to purchase access</p>

      <div class="auth-tabs">
        <button class="auth-tab active" onclick="showAuthTab('login')">Login</button>
        <button class="auth-tab" onclick="showAuthTab('register')">Register</button>
      </div>

      <!-- Login Form -->
      <form id="loginForm" class="auth-form active">
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="loginEmail" required>
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="loginPassword" required>
        </div>
        <button type="submit" class="auth-submit-btn">Login</button>
        <div id="loginError" class="auth-error"></div>
      </form>

      <!-- Register Form -->
      <form id="registerForm" class="auth-form" style="max-height: 460px; overflow-y: auto; padding-right: 8px;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
          <div class="form-group">
            <label>First Name *</label>
            <input type="text" id="registerFirstName" required>
          </div>
          <div class="form-group">
            <label>Last Name *</label>
            <input type="text" id="registerLastName" required>
          </div>
        </div>
        <div class="form-group">
          <label>Email *</label>
          <input type="email" id="registerEmail" required>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
          <div class="form-group">
            <label>Password *</label>
            <input type="password" id="registerPassword" required minlength="8">
          </div>
          <div class="form-group">
            <label>Confirm Password *</label>
            <input type="password" id="registerPasswordConfirm" required>
          </div>
        </div>
        <div class="form-group">
          <label>Firm/Company Name</label>
          <input type="text" id="registerFirmName">
        </div>
        <div class="form-group">
          <label>ABN</label>
          <input type="text" id="registerABN" pattern="[0-9\s]{11,14}" placeholder="11 digit ABN (optional)">
          <small>Optional - Enter 11 digits (spaces optional)</small>
        </div>
        <div class="form-group">
          <label>Address *</label>
          <input type="text" id="registerBillingAddress" required placeholder="Street address">
        </div>
        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 12px;">
          <div class="form-group">
            <label>City *</label>
            <input type="text" id="registerBillingCity" required>
          </div>
          <div class="form-group">
            <label>State *</label>
            <select id="registerBillingState" required>
              <option value="">Select</option>
              <option value="QLD">QLD</option>
              <option value="NSW">NSW</option>
              <option value="VIC">VIC</option>
              <option value="SA">SA</option>
              <option value="WA">WA</option>
              <option value="TAS">TAS</option>
              <option value="NT">NT</option>
              <option value="ACT">ACT</option>
            </select>
          </div>
          <div class="form-group">
            <label>Postcode *</label>
            <input type="text" id="registerBillingPostcode" required pattern="[0-9]{4}" placeholder="4000">
          </div>
        </div>
        <div class="form-group">
          <label>Phone</label>
          <input type="tel" id="registerPhone" placeholder="Optional">
        </div>
        <div class="form-group">
          <label>Company Size</label>
          <select id="registerEmployeeSize">
            <option value="">Select company size (optional)</option>
            <option value="1-5">1-5 employees</option>
            <option value="6-10">6-10 employees</option>
            <option value="11-25">11-25 employees</option>
            <option value="26-50">26-50 employees</option>
            <option value="51-100">51-100 employees</option>
            <option value="101-250">101-250 employees</option>
            <option value="251-500">251-500 employees</option>
            <option value="500+">500+ employees</option>
          </select>
        </div>
        <button type="submit" class="auth-submit-btn">Create Account</button>
        <div id="registerError" class="auth-error"></div>
      </form>
    </div>
  </div>

  <!-- PAYMENT MODAL -->
  <div id="paymentModal" class="payment-modal">
    <div class="payment-modal-content">
      <button class="payment-modal-close" onclick="closePaymentModal()">&times;</button>
      <div class="payment-modal-header">
        <h2>Unlock Adjudicator Access</h2>
        <p id="modalAdjudicatorName" style="color: var(--text-secondary); font-size: 15px;"></p>
        <div class="price-tag">$69.95 <sup>incl GST</sup></div>
        <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 20px;">One-time payment &middot; Chargeable disbursement &middot; Receipt/invoice immediately on payment</p>

        <div class="terms-wrapper">
          <label>
            <input type="checkbox" id="terms-checkbox" required>
            <span>By purchasing Adjudicator Insights for <span id="terms-adjudicator-name"></span>, you agree to the <a href="/adjudicator-insights-terms" target="_blank">Adjudicator Insights Terms &amp; Conditions</a>.</span>
          </label>
        </div>
      </div>

      <form id="payment-form">
        <div id="card-element"></div>
        <div id="card-errors" role="alert"></div>
        <button type="submit" id="submit-payment" class="pay-button" disabled>
          <span id="button-text">Complete Purchase</span>
        </button>
      </form>
    </div>
  </div>

  <!-- SUCCESS MODAL -->
  <div id="paymentSuccessModal" class="success-modal">
    <div class="success-modal-content">
      <div style="font-size: 56px; color: var(--green); margin-bottom: 16px;">&#10003;</div>
      <h2>Payment Successful!</h2>
      <p>You now have permanent access to the insights for <strong id="successModalAdjudicatorName"></strong>.</p>
      <button id="view-insights-btn" class="unlock-btn">View Insights</button>
      <button id="download-invoice-btn" class="unlock-btn" style="margin-top: 10px; background-color: #6c757d; display: none;">Download Invoice</button>
    </div>
  </div>

  <!-- STRIPE -->
  <script src="https://js.stripe.com/v3/"></script>

  <script>
// ============================================================
// STATE
// ============================================================
let allAdjudicators = [];
let filteredAdjudicators = [];
let selectedAdjudicator = null;
let currentAdjudicatorForPurchase = null;
let purchasedAdjudicators = new Set();
let userToken = null;
let originalDecisions = [];
let isDecisionSearchActive = false;
let chatHistoriesAdjudicators = {};
let adjDecisionPage = 1;
const ADJ_DECISIONS_PER_PAGE = 100;
let lastFilteredDecisions = null;
let lastSearchQuery = null;

// Stripe globals
let stripe = null;
let elements = null;
let cardElement = null;

// ============================================================
// INITIALIZATION
// ============================================================
document.addEventListener('DOMContentLoaded', async function() {
    // Initialize Stripe
    stripe = Stripe('pk_live_51SGxeHAIOAykxV504w220IB6SNF8PWmMovA3Vcj7BU34qr4lxSftuuc6vhGtb0CURpjiR2e2OMMNdyMuzVXbH286002Y11rMPE');
    elements = stripe.elements();
    cardElement = elements.create('card', {
        style: {
            base: {
                fontSize: '16px',
                color: '#333',
                '::placeholder': { color: '#aaa' },
            },
        },
    });

    // Terms checkbox controls pay button
    const termsCheckbox = document.getElementById('terms-checkbox');
    const paymentButton = document.getElementById('submit-payment');
    if (termsCheckbox && paymentButton) {
        termsCheckbox.addEventListener('change', () => {
            paymentButton.disabled = !termsCheckbox.checked;
        });
    }

    cardElement.mount('#card-element');

    cardElement.on('change', function(event) {
        const displayError = document.getElementById('card-errors');
        if (event.error) {
            displayError.textContent = event.error.message;
        } else {
            displayError.textContent = '';
        }
    });

    // Setup auth forms
    document.getElementById('loginForm').addEventListener('submit', handleLogin);
    document.getElementById('registerForm').addEventListener('submit', handleRegister);

    // Load all adjudicators
    await loadAdjudicators();

    // Load user access status
    await loadUserAccessStatus();

    // Re-render with access info
    renderAdjudicatorsList();

    // Check URL params (e.g. ?q=name)
    checkUrlParams();

    // Setup event listeners
    setupEventListeners();
});

// ============================================================
// LOAD USER ACCESS
// ============================================================
async function loadUserAccessStatus() {
    const token = localStorage.getItem('purchase_token');
    if (!token) return;

    try {
        const response = await fetch('/purchase-me', {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
            const user = await response.json();

            if (user.has_full_access) {
                allAdjudicators.forEach(adj => purchasedAdjudicators.add(adj.name));
            } else if (user.has_subscription) {
                allAdjudicators.forEach(adj => purchasedAdjudicators.add(adj.name));
            } else {
                const purchasesResponse = await fetch('/my-purchases', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (purchasesResponse.ok) {
                    const purchases = await purchasesResponse.json();
                    purchases.forEach(p => purchasedAdjudicators.add(p.adjudicator_name));
                }
            }
        }
    } catch (e) {
        console.error('Failed to load user access status:', e);
    }
}

// ============================================================
// CORE: LOAD, FILTER, RENDER
// ============================================================
async function loadAdjudicators() {
    const container = document.getElementById('adjudicatorsList');
    container.innerHTML = '<div class="loading"><div class="loading-spinner"></div>Loading adjudicators...</div>';

    try {
        const response = await fetch('/api/adjudicators');
        if (!response.ok) throw new Error('Failed to fetch adjudicators');

        allAdjudicators = await response.json();
        filteredAdjudicators = [...allAdjudicators];
        filterAdjudicators();
    } catch (error) {
        console.error('Error loading adjudicators:', error);
        container.innerHTML = '<div class="loading">Error loading adjudicators. Please try again later.</div>';
    }
}

function filterAdjudicators() {
    const searchTerm = document.getElementById('adjudicatorSearch').value.toLowerCase();
    const sortBy = document.getElementById('sortBy').value;

    filteredAdjudicators = allAdjudicators.filter(adj =>
        adj.name.toLowerCase().includes(searchTerm)
    );

    filteredAdjudicators.sort((a, b) => {
        // Always pin Russell Welsh to the top
        if (a.name === 'Russell Welsh') return -1;
        if (b.name === 'Russell Welsh') return 1;

        switch (sortBy) {
            case 'name':
                return a.name.localeCompare(b.name);
            case 'award_rate':
                return b.avgAwardRate - a.avgAwardRate;
            case 'decisions':
            default:
                return b.totalDecisions - a.totalDecisions;
        }
    });

    renderAdjudicatorsList();
}

function renderAdjudicatorsList() {
    const container = document.getElementById('adjudicatorsList');

    if (filteredAdjudicators.length === 0) {
        container.innerHTML = '<div class="loading">No adjudicators found.</div>';
        return;
    }

    container.innerHTML = filteredAdjudicators.map(adj => {
        const decisionCount = adj.totalDecisions;
        const awardRate = adj.avgAwardRate.toFixed(1) + '%';

        const isPurchased = purchasedAdjudicators.has(adj.name);
        const isDemo = adj.name === 'Russell Welsh';
        const shouldBlur = !isPurchased && !isDemo;

        const decisionHtml = shouldBlur ? `<span class="blur-value">${decisionCount}</span>` : decisionCount;
        const awardHtml = shouldBlur ? `<span class="blur-value">${awardRate}</span>` : awardRate;

        return `
        <div class="adj-item ${selectedAdjudicator?.id === adj.id ? 'active' : ''}"
             onclick="selectAdjudicator('${adj.id.replace(/'/g, "\\'")}')">
          <div class="adj-name">
            ${sanitizeHtml(adj.name)}
            ${adj.name === 'Russell Welsh' ? '<span class="badge-free">FREE DEMO</span>' : ''}
          </div>
          <div class="adj-stats">
            <span>${decisionHtml} decisions</span>
            <span>${awardHtml} avg awarded</span>
          </div>
        </div>
      `;
    }).join('');
}

// ============================================================
// SELECT ADJUDICATOR
// ============================================================
async function selectAdjudicator(adjudicatorId) {
    selectedAdjudicator = allAdjudicators.find(adj => adj.id === adjudicatorId);
    if (!selectedAdjudicator) return;

    const rightPane = document.getElementById('rightPane');
    rightPane.className = 'detail-panel';
    rightPane.innerHTML = '<div class="loading"><div class="loading-spinner"></div>Loading...</div>';

    try {
        let hasAccess = false;

        if (selectedAdjudicator.name === 'Russell Welsh') {
            hasAccess = true;
            purchasedAdjudicators.add('Russell Welsh');
        } else {
            const token = localStorage.getItem('purchase_token');
            if (token) {
                const isValid = await refreshTokenIfNeeded();
                if (isValid) {
                    try {
                        const accessResponse = await fetch(`/check-adjudicator-access/${encodeURIComponent(selectedAdjudicator.name)}`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (accessResponse.ok) {
                            const accessData = await accessResponse.json();
                            hasAccess = accessData.hasAccess;
                            if (hasAccess) {
                                purchasedAdjudicators.add(selectedAdjudicator.name);
                            }
                        }
                    } catch (e) {
                        console.error('Access check error:', e);
                    }
                }
            }
        }

        renderAdjudicatorsList();

        const decisionsResponse = await fetch(`/api/adjudicator/${encodeURIComponent(selectedAdjudicator.name)}`);
        if (!decisionsResponse.ok) throw new Error('Failed to fetch decisions');

        const decisions = await decisionsResponse.json();
        selectedAdjudicator.decisions = decisions;
        initializeDecisionSearch();

        showAdjudicatorDetail(hasAccess);
    } catch (error) {
        console.error('Error in selectAdjudicator:', error);
        rightPane.innerHTML = '<div class="loading">Error loading decisions. Please try again.</div>';
    }
}

// ============================================================
// SHOW DETAIL
// ============================================================
function showAdjudicatorDetail(hasAccess) {
    const rightPane = document.getElementById('rightPane');
    rightPane.className = 'detail-panel';

    const avgClaimAmount = selectedAdjudicator.totalClaimAmount / selectedAdjudicator.totalDecisions;
    const avgAwardedAmount = selectedAdjudicator.totalAwardedAmount / selectedAdjudicator.totalDecisions;

    const subtitleHtml = !hasAccess ?
        `<span class="blur-value">${selectedAdjudicator.totalDecisions}</span> decisions analysed` :
        `${selectedAdjudicator.totalDecisions} decisions analysed`;

    const lockedOverlay = !hasAccess ? `
      <div class="locked-overlay">
        <div class="locked-content">
          <h3>Unlock Full Insights for ${sanitizeHtml(selectedAdjudicator.name)}</h3>
          <p>Get access to detailed statistics, decision patterns, and the complete history of decisions.</p>
          <div class="price-tag">$69.95 <sup>incl GST</sup></div>
          <p style="color: var(--text-muted); font-size: 13px;">One-time payment &middot; Chargeable disbursement</p>
          <button class="unlock-btn" onclick="unlockAdjudicator('${selectedAdjudicator.name.replace(/'/g, "\\'")}')">
            Unlock Access
          </button>
        </div>
      </div>
    ` : '';

    adjDecisionPage = 1;
    lastFilteredDecisions = null;
    lastSearchQuery = null;

    rightPane.innerHTML = `
      <div class="detail-header">
        <h1>${sanitizeHtml(selectedAdjudicator.name)}</h1>
        <div class="subtitle">${subtitleHtml}</div>
      </div>

      <div class="tabs">
        <button class="tab-btn active" onclick="showTab('stats', this)">Statistics</button>
        <button class="tab-btn" onclick="showTab('decisions', this)">Decisions</button>
      </div>

      <div class="detail-content-wrap ${!hasAccess ? 'blur-stats' : ''}">
        ${lockedOverlay}

        <!-- Statistics Tab -->
        <div id="stats-tab" class="tab-content" style="display: block;">
          <div class="stat-cards">
            <div class="stat-card">
              <div class="stat-label">Total Decisions</div>
              <div class="stat-value">${selectedAdjudicator.totalDecisions}</div>
              <div class="info-icon">i
                <div class="tooltip">The total number of adjudication decisions made by this adjudicator in the database</div>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Avg Portion Awarded</div>
              <div class="stat-value">${selectedAdjudicator.avgAwardRate.toFixed(1)}%</div>
              <div class="info-icon">i
                <div class="tooltip">The average percentage of the claimed amount that was awarded per decision</div>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Total Claimed</div>
              <div class="stat-value">${formatCurrency(selectedAdjudicator.totalClaimAmount)}</div>
              <div class="info-icon">i
                <div class="tooltip">The sum of all payment claim amounts across all decisions by this adjudicator</div>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Total Adjudicated</div>
              <div class="stat-value">${formatCurrency(selectedAdjudicator.totalAwardedAmount)}</div>
              <div class="info-icon">i
                <div class="tooltip">The sum of all amounts adjudicated (awarded) across all decisions by this adjudicator</div>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Avg Claimed</div>
              <div class="stat-value">${formatCurrency(avgClaimAmount)}</div>
              <div class="info-icon">i
                <div class="tooltip">The average payment claim amount per decision</div>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Avg Adjudicated</div>
              <div class="stat-value">${formatCurrency(avgAwardedAmount)}</div>
              <div class="info-icon">i
                <div class="tooltip">The average adjudicated amount per decision</div>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Avg Claimant Fee</div>
              <div class="stat-value">${selectedAdjudicator.avgClaimantFeeProportion.toFixed(1)}%</div>
              <div class="info-icon">i
                <div class="tooltip">The average percentage of adjudicator fees paid by the claimant across all decisions</div>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Avg Respondent Fee</div>
              <div class="stat-value">${selectedAdjudicator.avgRespondentFeeProportion.toFixed(1)}%</div>
              <div class="info-icon">i
                <div class="tooltip">The average percentage of adjudicator fees paid by the respondent across all decisions</div>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-label">$Nil Decisions</div>
              <div class="stat-value">${selectedAdjudicator.zeroAwardCount || 0}</div>
              <div class="info-icon">i
                <div class="tooltip">The number of decisions where the adjudicator awarded $0.00 or otherwise found no jurisdiction</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Decisions Tab -->
        <div id="decisions-tab" class="tab-content" style="display: none;">
          <div style="position: relative; margin-bottom: 16px;">
            <div id="decisionSearchLoadingBar" class="decision-search-loading"></div>
            <div class="decision-list-controls">
              <div class="decision-search-wrap">
                <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                <input type="text" id="decisionSearchInput"
                       placeholder="Search decisions (e.g., 'defect AND delay' or 'payment w/5 claim')"
                       onkeydown="if(event.key==='Enter') searchDecisions()">
              </div>
              <button type="button" class="decision-search-btn" onclick="searchDecisions()">Search</button>
              <button type="button" class="decision-clear-btn" onclick="clearDecisionSearch()">Clear</button>
            </div>
            <div id="decisionSearchResults" class="decision-search-results">
              <span id="decisionSearchCount"></span>
            </div>
          </div>

          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px;">
            <h4 style="margin: 0; font-size: 14px; font-weight: 600;">All Decisions</h4>
            <select id="decisionSort" onchange="sortDecisions()" class="decision-sort-select">
              <option value="date_newest">Date (Newest First)</option>
              <option value="date_oldest">Date (Oldest First)</option>
              <option value="az">Claimant (A-Z)</option>
              <option value="za">Claimant (Z-A)</option>
              <option value="claim_high">Claim Amount (Highest)</option>
              <option value="claim_low">Claim Amount (Lowest)</option>
              <option value="award_high">Adjudicated Amount (Highest)</option>
              <option value="award_low">Adjudicated Amount (Lowest)</option>
            </select>
          </div>
          <div id="decisionsListContainer">
            ${renderDecisionsPaginated(selectedAdjudicator.decisions, hasAccess)}
          </div>
        </div>
      </div>
    `;
}

// ============================================================
// RENDER DECISION ITEMS
// ============================================================
function renderDecisionItems(decisions, hasAccess, searchQuery = null) {
    if (!decisions || decisions.length === 0) {
        return '<div class="loading">No decisions found</div>';
    }

    return decisions.map(decision => {
        const decisionTitleHtml = !hasAccess ?
            (decision.title || '').split(' v ').map(name => `<span class="blur-value">${sanitizeHtml(name)}</span>`).join(' v ') :
            sanitizeHtml(decision.title);

        const decisionLinkHtml = decision.pdfPath ?
            (!hasAccess ?
                `<span class="disabled">Open Decision (PDF)</span>` :
                `<a href="#" onclick="event.preventDefault(); openDecision('${decision.id}', '${decision.pdfPath}')">Open Decision (PDF)</a>`
            ) :
            `<span class="disabled">PDF not available</span>`;

        return `
            <div class="decision-list-item">
              <div class="dl-title">${decisionTitleHtml}</div>
              <div class="dl-meta">
                <span><strong>Date:</strong> ${decision.date || 'Unknown'}</span>
                <span><strong>Claim:</strong> $${Math.round(decision.claimAmount).toLocaleString()}</span>
                <span><strong>Awarded:</strong> $${Math.round(decision.awardedAmount).toLocaleString()}</span>
                ${(decision.claimantFeeProportion > 0 || decision.respondentFeeProportion > 0) ? `
                  <span><strong>Claimant Fee:</strong> ${decision.claimantFeeProportion > 0 ? decision.claimantFeeProportion.toFixed(1) : (100 - decision.respondentFeeProportion).toFixed(1)}%</span>
                  <span><strong>Respondent Fee:</strong> ${decision.respondentFeeProportion > 0 ? decision.respondentFeeProportion.toFixed(1) : (100 - decision.claimantFeeProportion).toFixed(1)}%</span>
                ` : ''}
              </div>
              <div class="dl-actions">
                ${decisionLinkHtml}
                <span style="color:#ccc; margin:0 6px;">|</span>
                ${!hasAccess ?
                  `<span class="disabled">Ask SopalAI</span>` :
                  `<a href="javascript:void(0)" onclick="summariseDecisionInAdjudicators('${decision.id}')">Ask SopalAI</a>`
                }
              </div>

              ${searchQuery && decision.matchedText ? `
                <div class="snippet">${extractSnippet(decision.matchedText, searchQuery)}</div>
              ` : ''}

              <!-- AI Chat Container -->
              <div id="ai-container-${decision.id}" class="ai-container" style="display:none;">
                <div class="chat-messages" id="chat-messages-${decision.id}"></div>
                <div class="chat-input-area" id="chat-input-area-${decision.id}" style="display:none;">
                  <input type="text" id="chat-input-${decision.id}" placeholder="Ask a follow-up question..." onkeydown="if(event.key==='Enter') sendChatMessageInAdjudicators('${decision.id}')">
                  <button onclick="sendChatMessageInAdjudicators('${decision.id}')" aria-label="Send message">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                  </button>
                </div>
              </div>
            </div>
        `;
    }).join('');
}

// ============================================================
// PAGINATED DECISIONS RENDERING
// ============================================================
function renderDecisionsPaginated(decisions, hasAccess, searchQuery = null) {
    if (!decisions || decisions.length === 0) {
        return '<div class="loading">No decisions found</div>';
    }

    const totalPages = Math.ceil(decisions.length / ADJ_DECISIONS_PER_PAGE);
    if (adjDecisionPage > totalPages) adjDecisionPage = totalPages;
    if (adjDecisionPage < 1) adjDecisionPage = 1;

    const startIdx = (adjDecisionPage - 1) * ADJ_DECISIONS_PER_PAGE;
    const endIdx = Math.min(startIdx + ADJ_DECISIONS_PER_PAGE, decisions.length);
    const sliced = decisions.slice(startIdx, endIdx);

    let html = renderDecisionItems(sliced, hasAccess, searchQuery);

    if (totalPages > 1) {
        html += '<div class="adj-pagination">';

        // Previous button
        html += `<button ${adjDecisionPage === 1 ? 'disabled' : ''} onclick="goAdjDecisionPage(${adjDecisionPage - 1})">&#8592; Prev</button>`;

        // Page number buttons with windowing (max ~7 visible)
        let startPage, endPage;
        if (totalPages <= 7) {
            startPage = 1;
            endPage = totalPages;
        } else {
            if (adjDecisionPage <= 4) {
                startPage = 1;
                endPage = 7;
            } else if (adjDecisionPage >= totalPages - 3) {
                startPage = totalPages - 6;
                endPage = totalPages;
            } else {
                startPage = adjDecisionPage - 3;
                endPage = adjDecisionPage + 3;
            }
        }

        if (startPage > 1) {
            html += `<button onclick="goAdjDecisionPage(1)">1</button>`;
            if (startPage > 2) html += `<span style="color:var(--text-muted);font-size:13px;padding:0 2px;">...</span>`;
        }

        for (let i = startPage; i <= endPage; i++) {
            html += `<button class="${i === adjDecisionPage ? 'active' : ''}" onclick="goAdjDecisionPage(${i})">${i}</button>`;
        }

        if (endPage < totalPages) {
            if (endPage < totalPages - 1) html += `<span style="color:var(--text-muted);font-size:13px;padding:0 2px;">...</span>`;
            html += `<button onclick="goAdjDecisionPage(${totalPages})">${totalPages}</button>`;
        }

        // Next button
        html += `<button ${adjDecisionPage === totalPages ? 'disabled' : ''} onclick="goAdjDecisionPage(${adjDecisionPage + 1})">Next &#8594;</button>`;

        // Page info
        html += `<div class="page-info">Showing ${startIdx + 1}\u2013${endIdx} of ${decisions.length}</div>`;

        html += '</div>';
    }

    return html;
}

function goAdjDecisionPage(page) {
    adjDecisionPage = page;
    const hasAccess = !document.querySelector('.detail-content-wrap.blur-stats');
    const container = document.getElementById('decisionsListContainer');
    if (!container) return;

    let decisions, searchQuery;
    if (lastFilteredDecisions) {
        decisions = lastFilteredDecisions;
        searchQuery = lastSearchQuery;
    } else if (selectedAdjudicator) {
        decisions = selectedAdjudicator.decisions;
        searchQuery = null;
    } else {
        return;
    }

    container.innerHTML = renderDecisionsPaginated(decisions, hasAccess, searchQuery);

    // Scroll to top of decisions section
    const decisionsHeader = container.previousElementSibling;
    if (decisionsHeader) {
        decisionsHeader.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}

// ============================================================
// TABS
// ============================================================
function showTab(tabName, btnEl) {
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');

    if (btnEl) btnEl.classList.add('active');
    const tab = document.getElementById(`${tabName}-tab`);
    if (tab) tab.style.display = 'block';
}

// ============================================================
// SORT DECISIONS
// ============================================================
function sortDecisions() {
    const sortBy = document.getElementById('decisionSort').value;

    selectedAdjudicator.decisions.sort((a, b) => {
        switch (sortBy) {
            case 'date_newest': return (b.date || '').localeCompare(a.date || '');
            case 'date_oldest': return (a.date || '').localeCompare(b.date || '');
            case 'az': return (a.claimant || '').localeCompare(b.claimant || '');
            case 'za': return (b.claimant || '').localeCompare(a.claimant || '');
            case 'claim_high': return b.claimAmount - a.claimAmount;
            case 'claim_low': return a.claimAmount - b.claimAmount;
            case 'award_high': return b.awardedAmount - a.awardedAmount;
            case 'award_low': return a.awardedAmount - b.awardedAmount;
            default: return 0;
        }
    });

    adjDecisionPage = 1;
    const hasAccess = !document.querySelector('.detail-content-wrap.blur-stats');
    const decisions = lastFilteredDecisions || selectedAdjudicator.decisions;
    if (lastFilteredDecisions) {
        lastFilteredDecisions.sort((a, b) => {
            switch (document.getElementById('decisionSort').value) {
                case 'date_newest': return (b.date || '').localeCompare(a.date || '');
                case 'date_oldest': return (a.date || '').localeCompare(b.date || '');
                case 'az': return (a.claimant || '').localeCompare(b.claimant || '');
                case 'za': return (b.claimant || '').localeCompare(a.claimant || '');
                case 'claim_high': return b.claimAmount - a.claimAmount;
                case 'claim_low': return a.claimAmount - b.claimAmount;
                case 'award_high': return b.awardedAmount - a.awardedAmount;
                case 'award_low': return a.awardedAmount - b.awardedAmount;
                default: return 0;
            }
        });
    }
    const container = document.getElementById('decisionsListContainer');
    container.innerHTML = renderDecisionsPaginated(decisions, hasAccess, lastSearchQuery);
}

// ============================================================
// OPEN DECISION PDF
// ============================================================
async function openDecision(decisionId, pdfPath) {
    try {
        const response = await fetch(`/open?p=${encodeURIComponent(pdfPath)}`);
        const data = await response.json();
        if (data.url) {
            window.open(data.url, '_blank');
        } else {
            alert('PDF not available');
        }
    } catch (error) {
        console.error('Error opening decision:', error);
        alert('Error opening decision PDF');
    }
}

// ============================================================
// AUTH MODAL
// ============================================================
function showAuthTab(tab) {
    document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));

    event.target.classList.add('active');
    document.getElementById(tab + 'Form').classList.add('active');

    document.getElementById('loginError').textContent = '';
    document.getElementById('registerError').textContent = '';
}

function closeAuthModal() {
    document.getElementById('authModal').classList.remove('active');
}

async function handleLogin(e) {
    e.preventDefault();

    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    const errorDiv = document.getElementById('loginError');

    try {
        const formData = new FormData();
        formData.append('username', email);
        formData.append('password', password);

        const response = await fetch('/purchase-login', {
            method: 'POST',
            body: formData
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Login failed');
        }

        const data = await response.json();
        localStorage.setItem('purchase_token', data.access_token);
        userToken = data.access_token;

        closeAuthModal();

        const adjudicatorToUnlock = sessionStorage.getItem('unlock_adjudicator_after_login');
        if (adjudicatorToUnlock && currentAdjudicatorForPurchase) {
            sessionStorage.removeItem('unlock_adjudicator_after_login');
            showPaymentModal();
        }
    } catch (error) {
        errorDiv.textContent = error.message;
    }
}

async function handleRegister(e) {
    e.preventDefault();

    const email = document.getElementById('registerEmail').value;
    const password = document.getElementById('registerPassword').value;
    const passwordConfirm = document.getElementById('registerPasswordConfirm').value;
    const firstName = document.getElementById('registerFirstName').value;
    const lastName = document.getElementById('registerLastName').value;
    const firmName = document.getElementById('registerFirmName').value;
    const abn = document.getElementById('registerABN').value;
    const billingAddress = document.getElementById('registerBillingAddress').value;
    const billingCity = document.getElementById('registerBillingCity').value;
    const billingState = document.getElementById('registerBillingState').value;
    const billingPostcode = document.getElementById('registerBillingPostcode').value;
    const employeeSize = document.getElementById('registerEmployeeSize').value;
    const phone = document.getElementById('registerPhone').value;
    const errorDiv = document.getElementById('registerError');

    // Validation
    const errors = [];
    if (!email) errors.push('Email is required');
    if (!password) errors.push('Password is required');
    if (password !== passwordConfirm) errors.push('Passwords do not match');
    if (password.length < 8) errors.push('Password must be at least 8 characters');
    if (!firstName) errors.push('First name is required');
    if (!lastName) errors.push('Last name is required');
    if (!billingAddress) errors.push('Address is required');
    if (!billingCity) errors.push('City is required');
    if (!billingState) errors.push('State is required');
    if (!billingPostcode) errors.push('Postcode is required');

    if (abn && abn.trim()) {
        const abnCleaned = abn.replace(/\s/g, '');
        if (abnCleaned.length !== 11 || !/^\d+$/.test(abnCleaned)) {
            errors.push('ABN must be exactly 11 digits');
        }
    }

    if (errors.length > 0) {
        errorDiv.innerHTML = errors.map(err => `&bull; ${err}`).join('<br>');
        errorDiv.style.display = 'block';
        return;
    }

    try {
        const formData = new FormData();
        formData.append('email', email);
        formData.append('password', password);
        formData.append('first_name', firstName);
        formData.append('last_name', lastName);
        formData.append('firm_name', firmName || '');
        formData.append('abn', abn ? abn.replace(/\s/g, '') : '');
        formData.append('billing_address', billingAddress);
        formData.append('billing_city', billingCity);
        formData.append('billing_state', billingState);
        formData.append('billing_postcode', billingPostcode);
        formData.append('employee_size', employeeSize || '');
        formData.append('phone', phone || '');

        const response = await fetch('/purchase-register', {
            method: 'POST',
            body: formData
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Registration failed');
        }

        // Auto-login after successful registration
        const loginFormData = new FormData();
        loginFormData.append('username', email);
        loginFormData.append('password', password);

        const loginResponse = await fetch('/purchase-login', {
            method: 'POST',
            body: loginFormData
        });

        const loginData = await loginResponse.json();
        localStorage.setItem('purchase_token', loginData.access_token);
        userToken = loginData.access_token;

        closeAuthModal();

        const adjudicatorToUnlock = sessionStorage.getItem('unlock_adjudicator_after_login');
        if (adjudicatorToUnlock && currentAdjudicatorForPurchase) {
            sessionStorage.removeItem('unlock_adjudicator_after_login');
            showPaymentModal();
        }
    } catch (error) {
        errorDiv.textContent = error.message;
        errorDiv.style.display = 'block';
    }
}

// ============================================================
// AUTH HELPERS
// ============================================================
async function checkAuthStatus() {
    const token = localStorage.getItem('purchase_token');
    if (token) {
        userToken = token;
        try {
            const response = await fetch('/purchase-me', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (response.ok) return true;
        } catch (e) {
            console.error('Auth check failed:', e);
        }
    }
    return false;
}

async function refreshTokenIfNeeded() {
    const token = localStorage.getItem('purchase_token');
    if (!token) return false;

    try {
        const response = await fetch('/purchase-me', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.status === 401) {
            localStorage.removeItem('purchase_token');
            userToken = null;
            return false;
        }
        return response.ok;
    } catch (e) {
        return false;
    }
}

// ============================================================
// PAYMENT MODAL
// ============================================================
function showPaymentModal() {
    document.getElementById('modalAdjudicatorName').textContent = currentAdjudicatorForPurchase;
    document.getElementById('paymentModal').classList.add('active');
}

function closePaymentModal() {
    document.getElementById('paymentModal').classList.remove('active');
    currentAdjudicatorForPurchase = null;
}

async function unlockAdjudicator(adjudicatorName) {
    currentAdjudicatorForPurchase = adjudicatorName;
    document.getElementById('terms-adjudicator-name').textContent = adjudicatorName;

    const token = localStorage.getItem('purchase_token');
    if (!token) {
        document.getElementById('authModal').classList.add('active');
        sessionStorage.setItem('unlock_adjudicator_after_login', adjudicatorName);
        return;
    }

    showPaymentModal();
}

// Payment form submit handler
document.getElementById('payment-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const submitButton = document.getElementById('submit-payment');
    submitButton.disabled = true;
    submitButton.querySelector('#button-text').textContent = 'Processing...';

    try {
        const token = localStorage.getItem('purchase_token');
        if (!token) throw new Error('Not authenticated. Please log in again.');

        const intentResponse = await fetch('/create-payment-intent', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `adjudicator_name=${encodeURIComponent(currentAdjudicatorForPurchase)}`
        });

        if (!intentResponse.ok) {
            const error = await intentResponse.json();
            throw new Error(error.detail || 'Could not initiate payment.');
        }

        const { clientSecret, paymentIntentId } = await intentResponse.json();

        const { error } = await stripe.confirmCardPayment(clientSecret, {
            payment_method: { card: cardElement }
        });
        if (error) throw new Error(error.message);

        const confirmResponse = await fetch('/confirm-purchase', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `payment_intent_id=${paymentIntentId}&adjudicator_name=${encodeURIComponent(currentAdjudicatorForPurchase)}`
        });

        if (!confirmResponse.ok) throw new Error('Failed to confirm purchase on server.');

        const confirmData = await confirmResponse.json();
        const adjudicatorName = currentAdjudicatorForPurchase;
        purchasedAdjudicators.add(adjudicatorName);

        const paymentModal = document.getElementById('paymentModal');
        const modalContent = paymentModal.querySelector('.payment-modal-content');
        modalContent.innerHTML = `
          <div style="text-align: center; padding: 40px 20px;">
            <div style="width: 64px; height: 64px; background: var(--green); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
              <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
            </div>
            <h2 style="font-size: 22px; font-weight: 700; color: var(--green); margin-bottom: 12px; letter-spacing: -0.02em;">Payment Successful!</h2>
            <p style="margin-bottom: 28px; font-size: 15px; color: var(--text-secondary); line-height: 1.6;">
              You now have permanent access to <strong>${sanitizeHtml(adjudicatorName)}</strong>'s insights.
            </p>
            ${confirmData.receiptUrl ? `
              <button onclick="window.open('${confirmData.receiptUrl}', '_blank')"
                      style="background: var(--green); color: white; border: none; padding: 13px 28px;
                             border-radius: 10px; cursor: pointer; font-size: 15px; font-weight: 600;
                             margin-bottom: 10px; width: 100%; font-family: inherit;">
                View Receipt
              </button>
            ` : ''}
            <button onclick="closeSuccessAndRefresh()"
                    style="background: #6c757d; color: white; border: none; padding: 13px 28px;
                           border-radius: 10px; cursor: pointer; font-size: 15px; font-weight: 600;
                           width: 100%; font-family: inherit;">
              View Insights
            </button>
          </div>
        `;
    } catch (error) {
        document.getElementById('card-errors').textContent = error.message;
    } finally {
        submitButton.disabled = false;
        submitButton.querySelector('#button-text').textContent = 'Complete Purchase';
    }
});

// ============================================================
// SUCCESS MODAL
// ============================================================
function closeSuccessAndRefresh() {
    closePaymentModal();
    if (selectedAdjudicator) {
        selectAdjudicator(selectedAdjudicator.id);
    }
}

function showSuccessModal(adjudicatorName, invoiceId) {
    document.getElementById('successModalAdjudicatorName').textContent = adjudicatorName;
    const downloadBtn = document.getElementById('download-invoice-btn');

    if (invoiceId) {
        downloadBtn.style.display = 'block';
        downloadBtn.onclick = () => handleInvoiceDownload(invoiceId);
    } else {
        downloadBtn.style.display = 'none';
    }

    document.getElementById('paymentSuccessModal').classList.add('active');
}

async function handleInvoiceDownload(invoiceId) {
    const downloadBtn = document.getElementById('download-invoice-btn');
    const originalText = downloadBtn.textContent;
    downloadBtn.textContent = 'Downloading...';
    downloadBtn.disabled = true;

    try {
        const token = localStorage.getItem('purchase_token');
        const response = await fetch(`/download-invoice/${invoiceId}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) {
            throw new Error('Could not download invoice. Please try again later from your account page.');
        }

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = '';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        a.remove();
    } catch (error) {
        alert(error.message);
    } finally {
        downloadBtn.textContent = originalText;
        downloadBtn.disabled = false;
    }
}

function closeSuccessModal() {
    document.getElementById('paymentSuccessModal').classList.remove('active');
    if (selectedAdjudicator) {
        selectAdjudicator(selectedAdjudicator.id);
    }
}

// ============================================================
// DECISION SEARCH
// ============================================================
function initializeDecisionSearch() {
    if (selectedAdjudicator && selectedAdjudicator.decisions) {
        originalDecisions = [...selectedAdjudicator.decisions];
    } else {
        originalDecisions = [];
    }
    isDecisionSearchActive = false;
}

async function searchDecisions() {
    const searchInput = document.getElementById('decisionSearchInput');
    const query = searchInput.value.trim();
    const loadingBar = document.getElementById('decisionSearchLoadingBar');
    const resultsDiv = document.getElementById('decisionSearchResults');
    const resultsCount = document.getElementById('decisionSearchCount');

    if (!query) {
        clearDecisionSearch();
        return;
    }

    if (loadingBar) loadingBar.style.width = '30%';

    try {
        isDecisionSearchActive = true;
        const processedQuery = normalizeInput(query);

        if (loadingBar) loadingBar.style.width = '60%';

        const filtered = await filterDecisionsLocally(originalDecisions, processedQuery);

        if (loadingBar) loadingBar.style.width = '90%';

        const hasAccess = !document.querySelector('.detail-content-wrap.blur-stats');
        const container = document.getElementById('decisionsListContainer');

        if (filtered.length === 0) {
            container.innerHTML = '<div class="loading">No matching decisions found. Try different search terms.</div>';
            if (resultsDiv) resultsDiv.style.display = 'none';
        } else {
            adjDecisionPage = 1;
            lastFilteredDecisions = filtered;
            lastSearchQuery = processedQuery;
            container.innerHTML = renderDecisionsPaginated(filtered, hasAccess, processedQuery);
            if (resultsDiv && resultsCount) {
                resultsCount.textContent = `Found ${filtered.length} matching decision${filtered.length === 1 ? '' : 's'} out of ${originalDecisions.length} total`;
                resultsDiv.style.display = 'block';
            }
        }

        if (loadingBar) {
            loadingBar.style.width = '100%';
            setTimeout(() => { loadingBar.style.width = '0%'; }, 400);
        }
    } catch (error) {
        console.error('Search failed:', error);
        alert('Search failed: ' + error.message);
        if (loadingBar) loadingBar.style.width = '0%';
    }
}

function clearDecisionSearch() {
    const searchInput = document.getElementById('decisionSearchInput');
    const loadingBar = document.getElementById('decisionSearchLoadingBar');
    const resultsDiv = document.getElementById('decisionSearchResults');

    if (searchInput) searchInput.value = '';
    if (loadingBar) loadingBar.style.width = '0%';
    if (resultsDiv) resultsDiv.style.display = 'none';

    isDecisionSearchActive = false;
    adjDecisionPage = 1;
    lastFilteredDecisions = null;
    lastSearchQuery = null;

    const hasAccess = !document.querySelector('.detail-content-wrap.blur-stats');
    const container = document.getElementById('decisionsListContainer');

    if (container && originalDecisions) {
        container.innerHTML = renderDecisionsPaginated(originalDecisions, hasAccess);
    }
}

async function filterDecisionsLocally(decisions, query) {
    try {
        const decisionIds = decisions.map(d => d.id);

        const response = await fetch('/api/adjudicator-decisions-text', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(decisionIds)
        });

        if (!response.ok) throw new Error('Failed to fetch decision texts');

        const data = await response.json();
        const textsMap = data.decisions;

        const matches = [];
        for (const decision of decisions) {
            const fullText = textsMap[decision.id] || '';
            if (simpleMatchQuery(fullText, query)) {
                matches.push({...decision, matchedText: fullText});
            }
        }

        return matches;
    } catch (e) {
        console.error('Batch fetch failed:', e);
        throw e;
    }
}

function simpleMatchQuery(text, query) {
    const lowerText = text.toLowerCase();
    let lowerQuery = query.toLowerCase();

    // Remove outer quotes
    lowerQuery = lowerQuery.replace(/^["']|["']$/g, '');

    // Handle quoted phrases
    const phrases = lowerQuery.match(/"([^"]+)"/g);
    if (phrases) {
        for (const phrase of phrases) {
            const clean = phrase.replace(/"/g, '');
            if (!lowerText.includes(clean)) return false;
        }
        return true;
    }

    // Handle AND
    if (lowerQuery.includes(' and ')) {
        const terms = lowerQuery.split(' and ').map(t => t.trim().replace(/"/g, ''));
        return terms.every(term => lowerText.includes(term));
    }

    // Handle OR
    if (lowerQuery.includes(' or ')) {
        const terms = lowerQuery.split(' or ').map(t => t.trim().replace(/"/g, ''));
        return terms.some(term => lowerText.includes(term));
    }

    // Handle proximity (w/N)
    const proximityMatch = lowerQuery.match(/(\w+)\s+w\/(\d+)\s+(\w+)/i);
    if (proximityMatch) {
        const [, term1, distance, term2] = proximityMatch;
        return checkProximity(lowerText, term1, term2, parseInt(distance));
    }

    // Simple keyword
    return lowerText.includes(lowerQuery);
}

function checkProximity(text, term1, term2, maxDistance) {
    const words = text.toLowerCase().split(/\s+/);
    const positions1 = words.map((w, i) => w.includes(term1) ? i : -1).filter(i => i >= 0);
    const positions2 = words.map((w, i) => w.includes(term2) ? i : -1).filter(i => i >= 0);

    for (const pos1 of positions1) {
        for (const pos2 of positions2) {
            if (Math.abs(pos2 - pos1) <= maxDistance) return true;
        }
    }
    return false;
}

function extractSnippet(text, query, length = 200) {
    const lowerText = text.toLowerCase();
    const firstTerm = query.toLowerCase().split(/\s+and\s+|\s+or\s+|\s+w\/\d+\s+/)[0].replace(/"/g, '');
    const index = lowerText.indexOf(firstTerm);

    if (index === -1) return '';

    const start = Math.max(0, index - 50);
    const end = Math.min(text.length, index + length);
    let snippet = text.substring(start, end);

    if (start > 0) snippet = '...' + snippet;
    if (end < text.length) snippet = snippet + '...';

    const terms = query.toLowerCase().match(/\w+/g);
    if (terms) {
        terms.forEach(term => {
            const regex = new RegExp(`(${term})`, 'gi');
            snippet = snippet.replace(regex, '<mark>$1</mark>');
        });
    }

    return snippet;
}

// ============================================================
// AI CHAT
// ============================================================
async function summariseDecisionInAdjudicators(id) {
    const container = document.getElementById(`ai-container-${id}`);
    const messagesBox = document.getElementById(`chat-messages-${id}`);
    const inputBox = document.getElementById(`chat-input-area-${id}`);

    if (container.style.display === 'block') {
        container.style.display = 'none';
        return;
    }

    container.style.display = 'block';
    messagesBox.innerHTML = '<div class="loading-text-gradient">Generating summary...</div>';
    inputBox.style.display = 'none';
    chatHistoriesAdjudicators[id] = [];

    try {
        const res = await fetch(`/summarise/${id}`);
        const data = await res.json();
        messagesBox.innerHTML = '';

        if (data.summary) {
            addAiMessageAdjudicators(id, data.summary);
            inputBox.style.display = 'flex';
        } else {
            addAiMessageAdjudicators(id, 'Failed to generate summary.');
        }
    } catch (e) {
        messagesBox.innerHTML = '';
        addAiMessageAdjudicators(id, 'Error contacting server.');
    }
}

async function sendChatMessageInAdjudicators(id) {
    const input = document.getElementById(`chat-input-${id}`);
    const question = input.value.trim();
    if (!question) return;

    addUserMessageAdjudicators(id, question);
    input.value = '';

    const typingIndicator = addTypingIndicatorAdjudicators(id);

    const history = chatHistoriesAdjudicators[id] || [];

    try {
        const res = await fetch(`/ask/${id}`, {
            method: "POST",
            body: new URLSearchParams({ question, history: JSON.stringify(history) }),
            headers: { "Content-Type": "application/x-www-form-urlencoded" }
        });
        const data = await res.json();

        typingIndicator.remove();

        if (data.answer) {
            addAiMessageAdjudicators(id, data.answer);
            chatHistoriesAdjudicators[id].push({ role: 'assistant', content: data.answer });
        } else {
            addAiMessageAdjudicators(id, `Error: ${data.error || "Failed to get answer"}`);
        }
    } catch (e) {
        typingIndicator.remove();
        addAiMessageAdjudicators(id, 'Network or server error.');
    }
}

function addAiMessageAdjudicators(id, htmlContent) {
    const messagesBox = document.getElementById(`chat-messages-${id}`);
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message ai-message';
    messageDiv.innerHTML = `
        <div class="message-avatar">S</div>
        <div class="message-content"><div class="ai-output-content">${htmlContent}</div></div>
    `;
    messagesBox.appendChild(messageDiv);
    messagesBox.scrollTop = messagesBox.scrollHeight;
}

function addUserMessageAdjudicators(id, text) {
    const messagesBox = document.getElementById(`chat-messages-${id}`);
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message user-message';
    messageDiv.innerHTML = `
        <div class="message-avatar">U</div>
        <div class="message-content">${sanitizeHtml(text)}</div>
    `;
    messagesBox.appendChild(messageDiv);
    chatHistoriesAdjudicators[id].push({ role: 'user', content: text });
    messagesBox.scrollTop = messagesBox.scrollHeight;
}

function addTypingIndicatorAdjudicators(id) {
    const messagesBox = document.getElementById(`chat-messages-${id}`);
    const typingDiv = document.createElement('div');
    typingDiv.className = 'message ai-message typing-indicator';
    typingDiv.innerHTML = `
        <div class="message-avatar">S</div>
        <div class="message-content">...</div>
    `;
    messagesBox.appendChild(typingDiv);
    messagesBox.scrollTop = messagesBox.scrollHeight;
    return typingDiv;
}

// ============================================================
// UTILITIES
// ============================================================
function sanitizeHtml(str) {
    if (!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

function formatCurrency(amount) {
    if (!amount) return '$0';
    if (amount >= 1000000) return '$' + (amount / 1000000).toFixed(1) + 'M';
    if (amount >= 1000) return '$' + (amount / 1000).toFixed(0) + 'K';
    return '$' + Math.round(amount).toLocaleString();
}

function normalizeInput(s) {
    return (s || '')
        .replace(/[\u201C\u201D]/g, '"')
        .replace(/[\u2018\u2019]/g, "'")
        .replace(/[\u2013\u2014\u2012\u2015]/g, '-')
        .replace(/\s+/g, ' ')
        .trim();
}

async function downloadSummary() {
    const token = localStorage.getItem('purchase_token');
    if (!token) {
        alert("You must be logged in to download a summary.");
        return;
    }

    const name = selectedAdjudicator.name;
    const button = event.target;
    button.textContent = "Generating...";
    button.disabled = true;

    const formData = new FormData();
    formData.append('adjudicator_name', name);

    try {
        const res = await fetch('/generate-summary-pdf', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` },
            body: formData
        });

        if (!res.ok) throw new Error('Failed to generate PDF. You may not have access.');

        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${name}_SopalInsights.pdf`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);
    } catch (error) {
        console.error("PDF Download Error:", error);
        alert(error.message);
    } finally {
        button.textContent = "Summary (PDF)";
        button.disabled = false;
    }
}

// ============================================================
// EVENT SETUP
// ============================================================
function checkUrlParams() {
    const urlParams = new URLSearchParams(window.location.search);
    const queryParam = urlParams.get('q');

    if (queryParam) {
        const searchInput = document.getElementById('adjudicatorSearch');
        if (searchInput) searchInput.value = queryParam;

        filterAdjudicators();

        if (filteredAdjudicators.length === 1) {
            selectAdjudicator(filteredAdjudicators[0].id);
        }
    }
}

function setupEventListeners() {
    document.getElementById('adjudicatorSearch').addEventListener('input', filterAdjudicators);
    document.getElementById('sortBy').addEventListener('change', filterAdjudicators);
    document.getElementById('view-insights-btn').addEventListener('click', closeSuccessModal);

    document.addEventListener('keydown', function(e) {
        const searchInput = document.getElementById('decisionSearchInput');
        if (searchInput && document.activeElement === searchInput && e.key === 'Enter') {
            searchDecisions();
        }
    });
}

function searchAdjudicators() {
    filterAdjudicators();
}
  </script>

  <script src="/assets/js/main.js"></script>
</body>
</html>
