<!doctype html>
<html lang="en">
<head>
 <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-QEN3X3DQLR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-QEN3X3DQLR');
</script>
 <link rel="icon" href="assets/favicon.ico" type="image/x-icon">
<link rel="shortcut icon" href="assets/favicon.ico" type="image/x-icon">

  <link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.js"></script>
  <meta charset="utf-8">
  <title>Sopal â€“ Adjudication Search</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  /* Light theme overrides */
  .light {
    background: #ffffff !important;
    color: #222 !important;
  }

  .light body {
    background: #ffffff !important;
    color: #222 !important;
  }

  .light header {
    background: #fdfdfd !important;
    border-bottom: 1px solid #ccc !important;
  }
  .light header h1 { color: #000 !important; }
  .light #themeToggle { color: #000 !important; }

  .light .search-bar {
    background: #ffffff !important;
    border: 1px solid #ccc !important;
  }
  .light .search-bar input { color: #000 !important; }

  .light .filters input,
  .light .filters select {
    background: #ffffff !important;
    border: 1px solid #ccc !important;
    color: #000 !important;
  }

  .light #results { background: #ffffff !important; }
  .light .result { border-bottom: 1px solid #ddd !important; }
  .light .result h3 { color: #000 !important; }
  .light .meta { color: #555 !important; }
  .light .snippet {
    background: #f7f7f7 !important;
    color: #222 !important;
    border: 0.5px solid #ddd !important;
  }
  .light a { color: #0066cc !important; }
  .light .pagination button { color: #0066cc !important; }

  /* Theme toggle button */
  #themeToggle {
    background: none;
    border: none;
    font-size: 11px;
    cursor: pointer;
    color: white;
    opacity: 0.8;
    margin-left: auto;
  }
  #themeToggle:hover { opacity: 1; }
  .light #themeToggle { color: #000; }

  /* Base body + main layout */
body {
  font-family: Inter, sans-serif;
  margin: 0;
  background: rgba(33,33,33,255);
  color: #e4e4e4;
  font-size: 80%;   /* ðŸ”¥ new line â€“ shrinks everything ~20% */
}


  main {
    margin-top: 35px;
    margin-right: auto;
    margin-left: 180px; /* sidebar space */
    max-width: 720px;
    padding: 0 1px;
  }

  /* Search header */
  .search-header {
    background: #fcfcfc;
    padding: 20px 25px;
    border-bottom: 1px solid #ddd;
  }
  .search-header .top-row {
    display: flex;
    align-items: center;
  }
  .search-header .logo {
    flex: 0 0 auto;
    font-size: 10px;
    font-weight: bold;
    color: #000;
    margin-right: 10px;
  }
  .search-container {
    margin-left: 20px;
    max-width: 900px;
    width: 100%;
    display: flex;
    align-items: center;
    gap: 10px;
  }
.search-header .search-bar {
  flex: 1;
  display: flex;
  align-items: center;
  background: #fff;
  border-radius: 20px;   /* was 24px */
  border: 1px solid #ccc;
  padding: 4px 13px;     /* was 6px 14px */
  max-width: 760px;
  box-shadow: 0 1px 8px rgba(0,0,0,0.08);
}

.search-header .search-bar input {
  flex: 1;
  padding: 6px;          /* was 8px */
  font-size: 10px;       /* was 13px */
  border: none;
  outline: none;
  background: transparent;
  color: #000;
}

.search-header .search-bar button {
  background: #10a37f;
  border: none;
  color: white;
  padding: 6px 10px;     /* was 8px 13px */
  border-radius: 18px;   /* was 20px */
  cursor: pointer;
  font-size: 10px;       /* was 13px */
}


  .search-header .search-bar button:hover { background: #0d8a6c; }

  #results { margin-top: 20px; }
  .result {
    padding: 20px 0;
    border-bottom: 1px solid #ddd;
  }
  .result h3 {
    margin: 0 0 6px;
    font-size: 16px;
    color: #fff;
  }
  .meta {
    font-size: 13px;
    color: #aaa;
    margin-bottom: 8px;
  }
  .snippet {
    background: rgba(24,24,24,255);
    padding: 8px;
    border-radius: 6px;
    font-size: 12px;
    color: #ddd;
  }
  mark {
    background: #8BD69A;
    color: black;
    padding: 0 2px;
    border-radius: 2px;
  }
  a { color: #8BD69A; text-decoration: none; font-size: 14px; }
  a:hover { text-decoration: underline; }

  /* Pagination */
  .pagination {
    margin: 30px 0;
    display: flex;
    justify-content: flex-end;
    gap: 6px;
    font-size: 14px;
  }
  .pagination button {
    background: transparent;
    border: none;
    color: #8BD69A;
    cursor: pointer;
    padding: 4px 8px;
  }
  .pagination button.active {
    font-weight: bold;
    border-bottom: 2px solid #8BD69A;
  }
  .pagination button:hover { text-decoration: underline; }



  /* Filters sidebar (disabled for now) */
  .filters-sidebar { display: none !important; }

  /* Loading bar */
  #loadingBar {
    position: fixed;
    top: 0;
    left: 0;
    width: 0%;
    height: 4px;
    background: linear-gradient(to left, #21db87, #42ffaa);
    transition: width 0.7s ease;
    z-index: 9999;
  }

 /* Dark mode unified overrides */
.dark body {
  background: #0d0d0d !important;
  color: #e0e0e0 !important;
}

.dark header,
.dark footer,
.dark .search-header,
.dark .search-bar,
.dark .results-limit {
  background: #141414 !important;
  color: #f0f0f0 !important;
  border: 1px solid #333 !important;
}


.dark .snippet {
  background: #141414 !important;
  border: 1px solid #222 !important;
}

.dark a { color: #4da6ff !important; }
.dark .pagination button.active { border-bottom: 2px solid #4da6ff; }

/* --- Fix dark mode result cards + footer divider --- */
.dark #results,
.dark #results .result {
  border: none !important;
  color: #f0f0f0 !important;
}

.dark .snippet {
  background: #141414 !important;  /* slight contrast inside results */
  border: 1px solid #222 !important;
  color: #ddd !important;
}

.dark .footer-bottom {
  border-top: 1px solid #333 !important; /* subtle divider */
  color: #aaa !important;
}

/* Search button colors */
.search-header .search-bar button {
  background: #00c97c;  /* brighter green */
  border: none;
  color: white;
  padding: 8px 14px;
  border-radius: 20px;
  cursor: pointer;
  font-size: 10px;
}
.search-header .search-bar button:hover {
  background: #00a568;  /* darker on hover */
}

/* Dark mode search bar input text */
.dark .search-bar input {
  color: #fff !important;
}

 /* Base style */
.results-limit {
  appearance: none;         /* hide default arrow */
  -webkit-appearance: none;
  -moz-appearance: none;

  background: #1c1c1c;      /* dark rectangle */
  color: #fff;
  border: 1px solid #333;
  border-radius: 6px;
  padding: 6px 28px 6px 13px;
  font-size: 13px;
  cursor: pointer;
  transition: background 0.2s, border 0.2s;
  position: relative;
}

/* Hover effect: greyed rectangle */
.results-limit:hover {
  background: #2a2a2a;
  border-color: #555;
}

/* Add a custom arrow */
.results-limit::after {
  content: "â–¾";
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  pointer-events: none;
  color: #aaa;
}

/* Light mode adjustments */
.light .results-limit {
  background: #fff;
  color: #000;
  border: 1px solid #ccc;
}
.light .results-limit:hover {
  background: #f7f7f7;
  border-color: #aaa;
}

 .results-limit {
  appearance: none;             /* remove OS styling */
  -webkit-appearance: none;
  -moz-appearance: none;

  background: #1c1c1c;
  color: #fff;
  border: 1px solid #333;
  border-radius: 6px;
  padding: 6px 24px 6px 10px;   /* right padding leaves space for arrow */
  font-size: 13px;
  cursor: pointer;
  line-height: 1.4;
  transition: background 0.2s, border 0.2s;
  position: relative;
}

/* hover effect */
.results-limit:hover {
  background: #2a2a2a;
  border-color: #555;
}

/* custom arrow */
.results-limit::after {
  content: "â–¾";
  position: absolute;
  right: 8px;    /* closer to text */
  top: 50%;
  transform: translateY(-50%);
  pointer-events: none;
  font-size: 11px;
  color: #aaa;
}

/* Light mode */
.light .results-limit {
  background: #fff;
  color: #000;
  border: 1px solid #ccc;
}
.light .results-limit:hover {
  background: #f7f7f7;
  border-color: #aaa;
}

  :root {
    --primary-green: #08cc7c;
  }

/* Highlight style */
mark {
  background: #b9f6ca;   /* flat light green */
  color: #000;           /* dark text */
  padding: 0 1px;        /* very minimal padding */
  border-radius: 1px;    /* subtle rounding */
  font-weight: inherit;  /* donâ€™t over-emphasise */
}

/* Dark mode highlight */
.dark mark {
  background: #2e7d32;   /* deep green for dark background */
  color: #e0ffe0;        /* light text for contrast */
}


 /* --- Mobile responsiveness --- */
@media (max-width: 768px) {
  main {
    margin-left: 0;          /* remove sidebar space */
    padding: 0 13px;         /* breathing room on small screens */
    max-width: 100%;
  }

  .search-header {
    padding: 13px;
  }

  .search-header .top-row {
    flex-direction: column;  /* stack items vertically */
    align-items: stretch;
    gap: 13px;
  }

  .search-container {
    flex-direction: column;
    margin-left: 0;
    width: 100%;
    gap: 8px;
  }

  .search-header .search-bar {
    width: 100%;
    max-width: none;
  }

  .search-header .search-bar input {
    font-size: 13px;
    padding: 10px;
  }

  .search-header .search-bar button {
    font-size: 13px;
    padding: 10px;
  }

  .results-limit {
    width: 100%;
  }

  .result h3 {
    font-size: 18px;
  }

  .snippet {
    font-size: 11px;
  }

  .pagination {
    justify-content: center; /* center buttons on mobile */
    flex-wrap: wrap;
  }

}

@media (max-width: 480px) {
  .search-header .search-bar input {
    font-size: 13px;
  }
  .search-header .search-bar button {
    font-size: 13px;
  }
  .result h3 {
    font-size: 16px;
  }
  .snippet {
    font-size: 11px;
  }
}

/* --- Mobile tweaks --- */
@media (max-width: 768px) {
  .search-header .top-row {
    display: flex;
    flex-direction: row;
    justify-content: space-between;
    align-items: center;
  }

  #themeToggle {
    margin: 0;
    font-size: 14px;
    opacity: 1;
  }

  .search-container {
    flex-direction: column;
    width: 100%;
    margin-top: 13px;
    gap: 8px;
  }
}
  /* Add breathing room to search bar */
  .search-header .search-bar {
    padding: 10px 16px;
    border-radius: 28px;
  }

  .search-header .search-bar input {
    font-size: 13px;
    padding: 10px 8px;
  }

  .search-header .search-bar button {
    padding: 10px 16px;
    font-size: 13px;
  }

  /* Add slightly more padding to results */
  .result {
    padding: 35px 0;  /* was 20px */
  }

  /* Hide sorting dropdown on mobile */
  #sort {
    display: none;
  }
}

@media (max-width: 768px) {
  .search-header .top-row {
    display: flex;
    flex-direction: row;
    justify-content: space-between;
    align-items: center;
  }

  #themeToggle {
    margin: 0;
    font-size: 14px;
    opacity: 1;
  }

  .search-container {
    flex-direction: column;
    width: 100%;
    margin-top: 13px;
    gap: 8px;
  }
}
  .search-header .search-bar {
    width: 100%;
    padding: 5px 5px;
    border-radius: 28px;
  }

  .search-header .search-bar input {
    font-size: 13px;
  }

  /* Hide dropdowns, show Options button */
  #limit, #sort {
    display: none;
  }

  #mobileOptions {
    display: block;
    background: #f4f4f4;
    border: 1px solid #ccc;
    border-radius: 6px;
    padding: 10px;
    font-size: 14px;
    text-align: center;
    cursor: pointer;
  }

  /* Results spacing */
  .result {
    padding: 28px 0;
  }

  .result h3 {
    font-size: 18px;
  }

  .meta {
    font-size: 14px;
  }


 
}

@media (min-width: 769px) {
  #mobileOptions { display: none; }
}

/* --- Mobile clean layout --- */
@media (max-width: 768px) {
  /* Top row: logo left, dark mode right */
@media (max-width: 768px) {
  .search-header .top-row {
    display: flex;
    flex-direction: row;
    justify-content: space-between;
    align-items: center;
  }

  #themeToggle {
    margin: 0;
    font-size: 14px;
    opacity: 1;
  }

  .search-container {
    flex-direction: column;
    width: 100%;
    margin-top: 13px;
    gap: 8px;
  }

  .search-header .search-bar {
    width: 100%;
    padding: 13px 16px;
    border-radius: 28px;
  }

  /* Results: give a touch more space */
  .result {
    padding: 24px 0;
  }

  /* Hide sorting dropdown only */
  #sort {
    display: none;
  }
}

 /* --- Mobile clean layout --- */
@media (max-width: 768px) {
  .search-header .top-row {
    display: flex;
    flex-direction: row;
    justify-content: space-between;
    align-items: center;
  }

  #themeToggle {
    margin: 0;
    font-size: 14px;
    opacity: 1;
  }

  .search-container {
    flex-direction: column;
    width: 100%;
    margin-top: 13px;
    gap: 8px;
  }

  #themeToggle {
    margin: 0;
    font-size: 14px;
    opacity: 1;
  }

  /* Search bar full width below header */
  .search-container {
    flex-direction: column;
    width: 100%;
    margin: 13px 0 0 0;
    gap: 8px;
  }

  .search-header .search-bar {
    width: 100%;
    padding: 13px 16px;
    border-radius: 28px;
  }

  .search-header .search-bar input {
    font-size: 13px;
    padding: 10px 8px;
  }

  .search-header .search-bar button {
    padding: 10px 16px;
    font-size: 13px;
  }

  /* Hide dropdowns on mobile */
  #limit, #sort {
    display: none;
  }

  /* Results spacing */
  .result {
    padding: 24px 0;
  }

  .result h3 {
    font-size: 18px;
  }

  .snippet {
    font-size: 11px;
  }
}

@media (max-width: 768px) {
  .search-header {
    padding: 13px;
  }

  .search-header .top-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  #themeToggle {
    margin: 0;
    font-size: 14px;
  }

  .search-container {
    flex-direction: column;
    width: 100%;
    margin-top: 13px;
    gap: 8px;
  }

  .search-header .search-bar {
    width: 100%;
    padding: 13px 16px;
    border-radius: 28px;
  }

  #sort {
    display: none; /* hide sorting on mobile */
  }

  .result {
    padding: 24px 0;
  }
}

/* Desktop: search bar stays full width of container */
.search-header .search-bar {
  flex: 1;
  max-width: 900px;
  margin: 0; /* no side margin on desktop */
}

/* Mobile: add side padding so it's not edge-to-edge */
@media (max-width: 768px) {
  .search-header .search-bar {
    margin: 0 14px;      /* breathing room left/right */
    padding: 14px 18px;  /* taller inside */
    border-radius: 32px;
  }

  .search-header .search-bar input {
    font-size: 16px;
    padding: 13px 10px;
  }

  .search-header .search-bar button {
    font-size: 15px;
    padding: 5px 5px;
  }
}

/* Desktop: logo, search bar, and dark mode toggle inline */
@media (min-width: 769px) {
  .search-header .top-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .search-container {
    display: flex;
    flex: 1;
    margin: 0 20px; /* space between logo and toggle */
    align-items: center;
  }

  .search-header .search-bar {
    flex: 1;
    max-width: 600px;   /* reasonable width */
    margin: 0 auto;     /* centers between logo + toggle */
    padding: 6px 14px;  /* compact padding */
    border-radius: 24px;
  }
}

/* Mobile: stack logo + toggle, then search bar full width */
@media (max-width: 768px) {
  .search-header .top-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .search-container {
    width: 100%;
    margin: 13px 0 0 0;
  }

  .search-header .search-bar {
    width: 100%;
    margin: 0 13px;
    padding: 13px 16px;
    border-radius: 28px;
  }
}

/* Desktop layout: inline row */
@media (min-width: 769px) {
  .search-header .top-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 20px;
  }

  .search-container {
    flex: 1;              /* expand in middle */
    display: flex;
    align-items: center;
    gap: 10px;
    max-width: 700px;
  }

  .search-header .search-bar {
    flex: 1;
    margin: 0;
    padding: 6px 14px;
    border-radius: 24px;
  }
}

/* Mobile layout: stack */
@media (max-width: 768px) {
  .search-header .top-row {
    flex-direction: column;
    align-items: stretch;
    gap: 13px;
  }

  .search-container {
    flex-direction: column;
    width: 100%;
    gap: 8px;
  }

  .search-header .search-bar {
    margin: 0 13px;
    padding: 13px 16px;
    border-radius: 28px;
  }
}

 /* --- Fix search bar size on desktop --- */
@media (min-width: 769px) {
  .search-header .search-bar {
    max-width: 500px;   /* tighter width */
    padding: 4px 10px;  /* smaller inside padding */
    border-radius: 20px;
  }

  .search-header .search-bar input {
    font-size: 13px;
    padding: 6px 8px;
  }

  .search-header .search-bar button {
    font-size: 13px;
    padding: 6px 13px;
  }
}

/* --- Align status + result count to the left --- */
#status, #total {
  text-align: left !important;
  margin-left: 0;
  font-size: 13px;
  color: #666;
}

/* --- Reduce result card text sizes --- */
.result h3 {
  font-size: 15px;   /* was 16â€“18px */
  margin-bottom: 4px;
}

.meta {
  font-size: 13px;
  line-height: 1.4;
  color: #777;
}

.snippet {
  font-size: 11px;
  line-height: 1.5;
}

 #status, #total {
  margin: 0 0 10px 0;
  padding: 0;
  font-size: 11px;
  color: #666;
  text-align: left;      /* force left alignment */
}

/* Footer */
.footer {
  background: #fcfcfc;
  color: #333;
  padding: 40px 20px 20px;
  margin-top: 80px;
  border-top: 1px solid #ddd;
}

.footer-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  max-width: 1200px;
  margin: auto;
}

.footer-left {
  max-width: 400px;
}

.footer-logo {
  height: 24px;
  width: auto;      /* âœ… ensure it never stretches */
  margin-bottom: 10px;
  display: block;   /* âœ… fixes any inline weirdness */
}

.footer-links {
  display: flex;
  gap: 20px;
}

.footer-links a {
  color: #333;
  text-decoration: none;
  transition: color 0.2s;
}

.footer-links a:hover {
  color: #00c853;
}

.footer-bottom {
  text-align: center;
  border-top: 1px solid #eee;
  margin-top: 20px;
  padding-top: 15px;
  font-size: 0.85em;
  color: #666;
}

</style>

</head>
  <body class="light">
    <div id="loadingBar"></div>

<div class="search-header">
  <div class="top-row">
    <div class="logo">
      <a href="/">
        <img id="logo" src="assets/sopal_logo_v1.png" alt="SOPAL" style="height:31px;">
      </a>
    </div>

    <div class="search-container">
      <div class="search-bar">
        <input id="q" placeholder="Search adjudication decisionsâ€¦ (e.g. ''s 68'' AND ''KDV''; ''EOT'' w/10 ''time bar'')">
        <button onclick="runSearch()">Search</button>
      </div>

      <select id="limit" class="results-limit">
        <option value="20">20 results</option>
        <option value="50">50 results</option>
        <option value="100">100 results</option>
      </select>

      <select id="sort" class="results-limit">
        <option value="relevance">Relevance</option>
        <option value="newest" selected>Date: Newest to Oldest</option>
        <option value="oldest">Date: Oldest to Newest</option>
        <option value="atoz">A â†’ Z (Claimant)</option>
        <option value="ztoa">Z â†’ A (Claimant)</option>
      </select>
    </div>

    <button id="themeToggle" onclick="toggleTheme()">Switch to Dark Mode ðŸŒ™</button>
  </div>
</div>




    <select id="limit" class="results-limit">
      <option value="20">20 results</option>
      <option value="50">50 results</option>
      <option value="100">100 results</option>
    </select>

   <select id="sort" class="results-limit">
     <option value="relevance">Relevance</option>
     <option value="newest" selected>Date: Newest to Oldest</option>
     <option value="oldest">Date: Oldest to Newest</option>
     <option value="atoz">A â†’ Z (Claimant)</option>
     <option value="ztoa">Z â†’ A (Claimant)</option>
   </select>

  </div>


      </div>
    </div>





    <!-- Sidebar Filters -->


    <aside class="filters-sidebar">
      <h3>Filters</h3>

      <!-- Jurisdiction -->
      <label>
        <input type="checkbox" id="jurisdiction"> Jurisdiction
      </label>

      <!-- Vexatious/Frivolous -->
      <label>
        <input type="checkbox" id="vexatious"> Vexatious / Frivolous
      </label>

      <!-- Year -->
      <label for="year">Year</label>
      <select id="year">
        <option value="">Any</option>
        <option>2025</option>
        <option>2024</option>
        <option>2023</option>
        <!-- add dynamically later -->
      </select>

      <!-- Act -->
      <label for="act">Act</label>
      <select id="act">
        <option value="">Any</option>
        <option value="bif">BIF Act</option>
        <option value="bcipa">BCIPA</option>
      </select>

      <!-- Amount ranges -->
      <label>Payment Claim ($)</label>
      <div id="claim-slider"></div>
      <div class="slider-inputs">
        <input type="number" id="claim-min" placeholder="Min">
        <input type="number" id="claim-max" placeholder="Max">
      </div>

      <label>Payment Schedule ($)</label>
      <div id="schedule-slider"></div>
      <div class="slider-inputs">
        <input type="number" id="schedule-min" placeholder="Min">
        <input type="number" id="schedule-max" placeholder="Max">
      </div>

      <label>Adjudicated Amount ($)</label>
      <div id="adj-slider"></div>
      <div class="slider-inputs">
        <input type="number" id="adj-min" placeholder="Min">
        <input type="number" id="adj-max" placeholder="Max">
      </div>

      <button id="applyFilters">Apply Filters</button>
    </aside>


    <main>
      <div id="status">Ready.</div>
      <div id="total"></div>
      <div id="results"></div>
      <div class="pagination" id="pagination"></div>
    </main>


    <script>
    function $(sel){ return document.querySelector(sel); }
    function sanitize(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
    function getFileName(path){ if (!path) return ''; return path.split('/').pop(); }
    function buildPdfLinks(path){
      if (!path) return null;
      const fileName = path.split("/").pop();  // just the filename
      const open = `https://storage.googleapis.com/sopal-bucket/pdfs/${fileName}`;
      return { open, download: open };
    }

    let state = { q:'', claimant:'', respondent:'', limit:20, offset:0, total:0 };

    async function runSearch(page=1){
      $('#status').textContent = 'Searchingâ€¦';
      startLoadingBar();   // ðŸ”¥ ADD THIS LINE

      state.q = ($('#q')?.value || '').trim();
      state.claimant = ($('#claimant')?.value || '').trim();
      state.respondent = ($('#respondent')?.value || '').trim();
      state.limit = +($('#limit')?.value || 20);
      state.offset = (page-1) * state.limit;
      const params = new URLSearchParams();
      state.sort = ($('#sort')?.value || 'newest');
      params.set('sort', state.sort);

      if (state.q) params.set('q', state.q);
      if (state.claimant) params.set('claimant', state.claimant);
      if (state.respondent) params.set('respondent', state.respondent);
      params.set('limit', state.limit);
      params.set('offset', state.offset);

      const res = await fetch('/search_fast?' + params.toString(), { headers: { 'Accept':'application/json' }});
      const data = await res.json().catch(()=>({}));

      finishLoadingBar();  // ðŸ”¥ ADD THIS LINE

      state.total = data.total || 0;

      $('#total').textContent = `Total: ${state.total.toLocaleString()} results`;
      $('#status').textContent = 'Done.';

      const items = data.items || [];
      $('#results').innerHTML = items.length ? items.map(renderItem).join('') : '<p>No results.</p>';



      renderPagination(page);
    }


    function renderItem(it){
      const pdf = buildPdfLinks(it.pdf_path);
      const caseName = `${sanitize(it.claimant)} v ${sanitize(it.respondent)}`;
      const caseNo = sanitize(it.case_no || it.adj_no || it.id || '');

      return `
        <div class="result">
          <h3>${caseName}</h3>
          <div class="meta">
            ${it.decision_date_norm ? `<strong>Date:</strong> ${formatAusDate(it.decision_date_norm)}<br>` : '<strong>Date:</strong> Unknown<br>'}
            ${it.adjudicator ? `<strong>Adjudicator:</strong> ${sanitize(it.adjudicator)}<br>` : ''}
            ${it.claimant ? `<strong>Claimant:</strong> ${sanitize(it.claimant)}<br>` : ''}
            ${it.respondent ? `<strong>Respondent:</strong> ${sanitize(it.respondent)}<br>` : ''}
            ${it.act ? `<strong>Act:</strong> ${sanitize(it.act)}<br>` : ''}
          </div>
          ${it.snippet ? `<p class="snippet">${it.snippet}</p>` : ''}
          ${pdf ? `<a class="open-btn" href="${pdf.open}" target="_blank">Open Decision (PDF)</a>` : ''}
        </div>`;
    }

    function renderPagination(currentPage) {
      const totalPages = Math.ceil(state.total / state.limit);
      const container = $('#pagination');
      container.innerHTML = '';
      if (totalPages <= 1) return;

      const maxVisible = 10;
      let start = Math.max(1, currentPage - Math.floor(maxVisible / 2));
      let end = start + maxVisible - 1;
      if (end > totalPages) {
        end = totalPages;
        start = Math.max(1, end - maxVisible + 1);
      }

      if (currentPage > 1) {
        const prev = document.createElement('button');
        prev.textContent = 'â€¹ Previous';
        prev.onclick = () => runSearch(currentPage - 1);
        container.appendChild(prev);
      }

      if (start > 1) {
        const first = document.createElement('button');
        first.textContent = '1';
        first.onclick = () => runSearch(1);
        container.appendChild(first);
        const dots = document.createElement('span');
        dots.textContent = '...';
        dots.style.color = '#aaa';
        container.appendChild(dots);
      }

      for (let i = start; i <= end; i++) {
        const btn = document.createElement('button');
        btn.textContent = i;
        if (i === currentPage) btn.classList.add('active');
        btn.onclick = () => runSearch(i);
        container.appendChild(btn);
      }

      if (end < totalPages) {
        const dots = document.createElement('span');
        dots.textContent = '...';
        dots.style.color = '#aaa';
        container.appendChild(dots);
        const last = document.createElement('button');
        last.textContent = totalPages;
        last.onclick = () => runSearch(totalPages);
        container.appendChild(last);
      }

      if (currentPage < totalPages) {
        const next = document.createElement('button');
        next.textContent = 'Next â€º';
        next.onclick = () => runSearch(currentPage + 1);
        container.appendChild(next);
      }

      const info = document.createElement('div');
      info.textContent = `Page ${currentPage} of ${totalPages}`;
      info.style.fontSize = '13px';
      info.style.color = '#aaa';
      info.style.marginTop = '6px';
      info.style.textAlign = 'right';
      container.appendChild(info);
    }

function toggleTheme() {
  const body = document.body;
  const isDark = body.classList.contains('dark');

  if (isDark) {
    body.classList.remove('dark');
    body.classList.add('light');
    localStorage.setItem('theme', 'light');
    document.getElementById('themeToggle').textContent = 'Switch to Dark Mode ðŸŒ™';
  } else {
    body.classList.remove('light');
    body.classList.add('dark');
    localStorage.setItem('theme', 'dark');
    document.getElementById('themeToggle').textContent = 'Switch to Light Mode â˜€ï¸';
  }

  const logo = document.getElementById('logo');
  const footerLogo = document.getElementById('footerLogo');
  if (logo && footerLogo) {
    logo.src = body.classList.contains('dark')
      ? "assets/sopal_logo_white_v1.png"
      : "assets/sopal_logo_v1.png";
    footerLogo.src = body.classList.contains('dark')
      ? "assets/sopal_logo_white_v1.png"
      : "assets/sopal_logo_v1.png";
  }
}




    // ---- Init on load ----
const saved = localStorage.getItem('theme');
if (saved === 'dark') {
  document.body.classList.remove('light');
  document.body.classList.add('dark');
  document.getElementById('themeToggle').textContent = 'Switch to Light Mode â˜€ï¸';
} else {
  document.body.classList.add('light');
  document.getElementById('themeToggle').textContent = 'Switch to Dark Mode ðŸŒ™';
}


      // Pressing Enter in the search bar
      const input = document.getElementById('q');
      if (input) {
        input.addEventListener('keydown', e => {
          if (e.key === 'Enter') {
            e.preventDefault();
            runSearch(1);
          }
        });
      }

      // Changing results-per-page triggers new search
      const limitSel = document.getElementById('limit');
      if (limitSel) {
        limitSel.addEventListener('change', () => runSearch(1));
      }

      // Initial search
      runSearch();
    

    function startLoadingBar() {
  const bar = document.getElementById('loadingBar');
  bar.style.width = '0%';
  setTimeout(() => { bar.style.width = '50%'; }, 50); // jump to 50 quickly
}

function finishLoadingBar() {
  const bar = document.getElementById('loadingBar');
  bar.style.width = '100%';
  setTimeout(() => { bar.style.width = '0%'; }, 400); // hide after fill
}

function formatAusDate(iso) {
  if (!iso) return null;
  const d = new Date(iso);
  if (isNaN(d)) return null;
  return d.toLocaleDateString("en-AU", {
    day: "numeric",
    month: "long",
    year: "numeric"
  });
}

    </script>

<footer class="footer">
  <div class="footer-content">
    <div class="footer-left">
      <img id="footerLogo" src="assets/sopal_logo_v1.png" alt="SOPAL" class="footer-logo">
      <p>An intelligent search tool for adjudication decisions under the Building Industry Fairness (Security of Payment) Act 2017 (Qld)</p>
    </div>
    <div class="footer-links">
      <a href="feedback.html">Send feedback</a>
      <a href="privacy.html">Privacy</a>
      <a href="terms.html">Terms</a>
    </div>
  </div>
  <div class="footer-bottom">
    <p>Â© 2025 SOPAL. All rights reserved.</p>
  </div>
</footer>

</body>
</html>
