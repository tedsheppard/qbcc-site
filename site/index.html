<!doctype html>
<html lang="en">
<head>
 <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-QEN3X3DQLR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-QEN3X3DQLR');
</script>
 <link rel="icon" href="assets/favicon.ico" type="image/x-icon">
<link rel="shortcut icon" href="assets/favicon.ico" type="image/x-icon">

  <link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.js"></script>
  <meta charset="utf-8">
  <title>Sopal ‚Äì Adjudication Search</title>
  <meta name="description" content="Sopal is an intelligent search tool for finding adjudication decisions under the Building Industry Fairness (Security of Payment) Act 2017 (BIF Act) in Queensland, Australia. Search decisions by keyword, adjudicator, date, and more.">
  <meta name="keywords" content="Sopal, adjudication decisions, BIF Act, Building Industry Fairness, Security of Payment Act, Queensland, construction law, payment disputes, QBCC search, adjudicator search, construction adjudication">
  <meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  /* Header from Privacy Page */
  .header {
    background: #fdfdfd;
    padding: 20px 25px;
    border-bottom: 1px solid #ddd;
    position: sticky;
    top: 0;
    z-index: 100;
  }
  .header-content {
    display: flex;
    align-items: center;
    max-width: 1200px;
    margin: 0 auto;
  }
  .logo {
    height: 31px;
    margin-right: 20px;
  }
  .nav-links {
    margin-left: auto;
    display: flex;
    gap: 20px;
  }
  .nav-links a {
    color: black; 
    text-decoration: none;
    font-size: 14px;
    transition: color 0.2s;
  }
  .nav-links a:hover {
    color: #00c97c;
  }
  .nav-links a.active {
    color: #008a5c; /* Darker green for active link */
    font-weight: 600;
  }

  /* Light theme overrides */
  .light {
    background: #ffffff !important;
    color: #222 !important;
  }

  .light body {
    background: #ffffff !important;
    color: #222 !important;
  }

  .light header {
    background: #fdfdfd !important;
    border-bottom: 1px solid #ccc !important;
  }
  .light header h1 { color: #000 !important; }
  .light #themeToggle { color: #000 !important; }

  .light .search-bar {
    background: #ffffff !important;
    border: 1px solid #ccc !important;
  }
  .light .search-bar input { color: #000 !important; }

  .light .filters input,
  .light .filters select {
    background: #ffffff !important;
    border: 1px solid #ccc !important;
    color: #000 !important;
  }

  .light #results { background: #ffffff !important; }
  .light .result { border-bottom: 1px solid #ddd !important; }
  .light .result h3 { color: #000 !important; }
  .light .meta { color: #555 !important; }
  .light .snippet {
    background: #f7f7f7 !important;
    color: #222 !important;
    border: 0.5px solid #ddd !important;
  }
  .light .pagination button { color: #8BD69A !important; }

  /* Theme toggle button */
  #themeToggle {
    background: none;
    border: none;
    font-size: 11px;
    cursor: pointer;
    color: white;
    opacity: 0.8;
  }
  #themeToggle:hover { opacity: 1; }
  .light #themeToggle { color: #000; }

  /* Base body + main layout */
body {
  font-family: Inter, sans-serif;
  margin: 0;
  background: rgba(33,33,33,255);
  color: #e4e4e4;
  font-size: 80%;
}

  /* Main content alignment */
  main {
    max-width: 1200px;
    margin: 35px auto 0; /* Centers and adds top margin */
    padding: 0 25px; /* Matches header horizontal padding */
  }

  /* Search header */
  .search-header {
    background: #fcfcfc;
    padding: 20px 25px;
    border-bottom: 1px solid #ddd;
  }
  
  .search-header-content {
    max-width: 1200px;
    margin: 0 auto;
  }

  .search-header .top-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 20px;
  }

  .search-header .search-bar {
    display: flex;
    align-items: center;
    background: #fff;
    border-radius: 20px;
    border: 1px solid #ccc;
    padding: 6px 15px; /* Slightly smaller height */
    box-shadow: 0 1px 8px rgba(0,0,0,0.08);
    width: 100%;
    max-width: 800px; /* Gives the search bar a max width so it doesn't look too wide */
  }

.search-header .search-bar input {
  flex: 1;
  padding: 6px;
  font-size: 13px; /* Increased font size */
  border: none;
  outline: none;
  background: transparent;
  color: #000;
}

.search-header .search-bar button {
  background: #10a37f;
  border: none;
  color: white;
  padding: 8px 16px; /* Adjusted padding for new height */
  border-radius: 18px;
  cursor: pointer;
  font-size: 13px; /* Match input text size */
}

  .search-header .search-bar button:hover { background: #0d8a6c; }

  .search-controls {
    display: flex;
    gap: 10px;
    margin-top: 15px;
  }

  #results { margin-top: 20px; }
  .result {
    padding: 20px 0;
    border-bottom: 1px solid #ddd;
  }
  .result h3 {
    margin: 0 0 6px;
    font-size: 16px;
  }
  .result h3 a {
      color: #fff; /* White for dark mode titles */
  }
   .light .result h3 a {
      color: #000; /* Black for light mode titles */
  }

  .meta {
    font-size: 13px;
    color: #aaa;
    margin-bottom: 8px;
  }
  .snippet {
    background: rgba(24,24,24,255);
    padding: 8px;
    border-radius: 6px;
    font-size: 12px;
    color: #ddd;
  }
  mark {
    background: #8BD69A;
    color: black;
    padding: 0 2px;
    border-radius: 2px;
  }
  
  /* General link styling */
  a {
    color: black;
    text-decoration: none;
    font-size: 14px;
    transition: color 0.2s;
  }
  a:hover {
    color: #00c97c; /* Green on hover */
    text-decoration: none;
  }
  
  /* NEW: Specific style for result action links */
  .result .open-btn {
      color: #0066cc;
  }
   .result .open-btn:hover {
      color: #004c99;
      text-decoration: underline;
  }


  /* Pagination */
  .pagination {
    margin: 30px 0;
    display: flex;
    justify-content: center; /* Changed from flex-end */
    flex-wrap: wrap; /* Add wrap for mobile */
    gap: 6px;
    font-size: 14px;
  }
  .pagination button {
    background: transparent;
    border: none;
    color: #8BD69A;
    cursor: pointer;
    padding: 4px 8px;
  }
  .pagination button.active {
    font-weight: bold;
    border-bottom: 2px solid #8BD69A;
  }
  .pagination button:hover { text-decoration: underline; }

  /* Footer */
  .footer {
    background: #fcfcfc;
    color: #333;
    padding: 40px 25px 20px;
    margin-top: 60px;
    border-top: 1px solid #ddd;
  }
  .footer-content {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    flex-wrap: wrap;
    max-width: 1200px;
    margin: auto;
  }
  .footer-left { 
    max-width: 400px;
    text-align: left;
  }
  .footer-logo { height: 24px; margin-bottom: 10px; }
  
  .footer-links {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px 40px;
    text-align: left;
  }
  .footer-links a {
    font-size: 13px; /* Smaller text */
  }

  .footer-bottom {
    text-align: center;
    border-top: 1px solid #eee;
    margin-top: 30px; /* Increased space */
    padding-top: 20px;
    width: 100%;
    font-size: 0.85em;
    color: #666;
  }

  /* Filters sidebar (disabled for now) */
  .filters-sidebar { display: none !important; }

  /* Loading bar */
  #loadingBar {
    position: fixed;
    top: 0;
    left: 0;
    width: 0%;
    height: 4px;
    background: linear-gradient(to left, #21db87, #42ffaa);
    transition: width 0.7s ease;
    z-index: 9999;
  }

 /* Dark mode unified overrides */
.dark body {
  background: #0d0d0d !important;
  color: #e0e0e0 !important;
}

.dark header,
.dark .header, /* Added dark mode for main header */
.dark footer,
.dark .search-header,
.dark .search-bar,
.dark .results-limit {
  background: #141414 !important;
  color: #f0f0f0 !important;
  border-color: #333 !important;
}

.dark .nav-links a, .dark .footer-links a, .dark a {
  color: #f0f0f0; /* Light text for dark mode header */
}
.dark a:hover {
  color: #00c97c;
}
.dark .nav-links a.active {
    color: #008a5c; /* Darker green for active link */
}


.dark .snippet {
  background: #141414 !important;
  border: 1px solid #222 !important;
}

.dark .result .open-btn { color: #4da6ff !important; }
.dark .pagination button.active { border-bottom: 2px solid #4da6ff; }

/* --- Fix dark mode result cards + footer divider --- */
.dark #results,
.dark #results .result {
  border: none !important;
  color: #f0f0f0 !important;
}

.dark .snippet {
  background: #141414 !important;  /* slight contrast inside results */
  border: 1px solid #222 !important;
  color: #ddd !important;
}

.dark .footer-bottom {
  border-top: 1px solid #333 !important; /* subtle divider */
  color: #aaa !important;
}

/* Search button colors */
.search-header .search-bar button {
  background: #00c97c;  /* brighter green */
  border: none;
  color: white;
  padding: 8px 16px; /* Adjusted padding for new height */
  border-radius: 20px;
  cursor: pointer;
  font-size: 13px; /* Match input text size */
}
.search-header .search-bar button:hover {
  background: #00a568;  /* darker on hover */
}

/* Dark mode search bar input text */
.dark .search-bar input {
  color: #fff !important;
}

 /* Base style */
.results-limit {
  appearance: none;         /* hide default arrow */
  -webkit-appearance: none;
  -moz-appearance: none;

  background: #fff;
  color: #000;
  border: 1px solid #ccc;
  border-radius: 6px;
  padding: 5px 24px 5px 12px; /* Adjusted padding */
  font-size: 12px; /* Reduced font size */
  cursor: pointer;
  transition: background 0.2s, border 0.2s;
  position: relative;
  width: 180px; /* NEW: Set a fixed width */
  text-align: left; /* NEW: Align text to the left */
}
.dark .results-limit {
  background: #1c1c1c;
  color: #fff;
  border-color: #333;
}


/* Hover effect: greyed rectangle */
.results-limit:hover {
  background: #f7f7f7;
  border-color: #aaa;
}
.dark .results-limit:hover {
  background: #2a2a2a;
  border-color: #555;
}

/* Add a custom arrow */
.results-limit::after {
  content: "‚ñæ";
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  pointer-events: none;
  color: #aaa;
}


  :root {
    --primary-green: #08cc7c;
  }

/* Highlight style */
mark {
  background: #b9f6ca;   /* flat light green */
  color: #000;           /* dark text */
  padding: 0 1px;        /* very minimal padding */
  border-radius: 1px;    /* subtle rounding */
  font-weight: inherit;  /* don‚Äôt over-emphasise */
}

/* Dark mode highlight */
.dark mark {
  background: #2e7d32;   /* deep green for dark background */
  color: #e0ffe0;        /* light text for contrast */
}

 /* --- Mobile responsiveness --- */
@media (max-width: 768px) {
  /* Header from Privacy Page */
  .header-content {
    flex-direction: column;
    gap: 16px;
  }
  .nav-links {
    margin: 0;
    flex-wrap: wrap;
    justify-content: center;
  }
  .footer-content {
    flex-direction: column;
    align-items: center;
    text-align: center;
  }
  .footer-left {
    margin-bottom: 25px;
  }
  .footer-links {
    grid-template-columns: repeat(2, 1fr); /* 2 columns on mobile */
    gap: 15px;
  }

  main {
    padding: 0 13px;
    max-width: 100%;
  }

  .search-header {
    padding: 13px;
  }
  
  .search-header-content {
    padding: 0;
  }

  .search-header .top-row {
    flex-direction: column;
    align-items: stretch;
    gap: 13px;
  }
  
  .search-header .search-bar {
    max-width: none;
  }
}

 #status, #total {
  margin: 0 0 10px 0;
  padding: 0;
  font-size: 11px;
  color: #666;
  text-align: left;
}

/* ---- NEW AI CHAT INTERFACE STYLES ---- */
.ai-container {
  border: 1px solid #ccc;
  border-radius: 8px;
  margin-top: 15px;
  max-width: 700px;
}
.dark .ai-container {
  border-color: #444;
}

.chat-messages {
  max-height: 400px;
  overflow-y: auto;
  padding: 10px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.message {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  max-width: 90%;
}
.message-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
}
.ai-message .message-avatar {
  background: #10a37f;
  color: white;
}
.user-message .message-avatar {
  background: #e0e0e0;
  color: #333;
}
.dark .user-message .message-avatar {
    background: #555;
    color: #eee;
}

.message-content {
  padding: 10px 14px;
  border-radius: 12px;
  font-size: 13px;
  line-height: 1.5;
}

.ai-message {
  align-self: flex-start;
}
.ai-message .message-content {
  background: #f0f0f0;
  color: #222;
  border-top-left-radius: 0;
}
.dark .ai-message .message-content {
  background: #2a2a2a;
  color: #eee;
}


.user-message {
  align-self: flex-end;
  flex-direction: row-reverse;
}
.user-message .message-content {
  background: #dcf8c6;
  color: #111;
  border-top-right-radius: 0;
}
.dark .user-message .message-content {
    background: #056162;
    color: #e0e0e0;
}

/* Updated Chat Input Area */
.chat-input-area {
  display: flex;
  align-items: center;
  padding: 8px 12px;
  border-top: 1px solid #e0e0e0;
}
.dark .chat-input-area {
  border-top-color: #444;
}

.chat-input-area input {
  flex-grow: 1;
  border: none;
  background: transparent;
  padding: 10px;
  font-size: 13px;
  outline: none;
  color: #222;
  margin-right: 8px;
}
.dark .chat-input-area input {
  color: #eee;
}

.chat-input-area button {
  background: #10a37f;
  color: white;
  border: none;
  border-radius: 50%;
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: background 0.2s;
  flex-shrink: 0;
}
.chat-input-area button:hover {
  background: #0d8a6c;
}
.chat-input-area button svg {
    margin-left: -1px; /* Visual centering for the icon */
    margin-top: 1px;
}

.typing-indicator {
    font-style: italic;
    color: #888;
}

.ai-output-content p { margin: 4px 0 6px 0; }
.ai-output-content strong { display: block; margin: 10px 0 4px 0; font-size: 14px; font-weight: 600; }
.ai-output-content ul { margin: 4px 0 8px 18px; padding: 0; }
.ai-output-content li { margin: 2px 0; }
.ai-output-content h3, .ai-output-content h4 { font-size: 15px; font-weight: 600; margin: 10px 0 4px 0; }
/* ---- END AI CHAT STYLES ---- */

/* Loading text gradient */
.loading-text-gradient {
  font-size: 14px;
  font-weight: 500;
  padding: 10px;
  background: linear-gradient(to right, #222 20%, #999 50%, #222 80%);
  background-size: 200% auto;
  color: transparent;
  background-clip: text;
  -webkit-background-clip: text;
  animation: shimmer 1.5s linear infinite;
  text-align: left;
}

@keyframes shimmer {
  to {
    background-position: -200% center;
  }
}

.dark .loading-text-gradient {
  background: linear-gradient(to right, #eee 20%, #777 50%, #eee 80%);
  background-size: 200% auto;
  background-clip: text;
  -webkit-background-clip: text;
  color: transparent;
}


</style>

</head>
  <body class="light">
    <div id="loadingBar"></div>

<!-- Header -->
<div class="header">
  <div class="header-content">
    <a href="/">
      <img id="logo" src="assets/sopal_logo_v1.png" alt="SOPAL" class="logo">
    </a>
    <div class="nav-links">
      <a href="index.html" class="active">Search</a>
      <a href="interest-calculator">Interest Calculator</a>
      <a href="due-date-calculator">Due Date Calculator</a>
      <a href="how-to">How-To Guide</a>
      <a href="feedback">Feedback</a>
    </div>
  </div>
</div>

<div class="search-header">
  <div class="search-header-content">
    <div class="top-row">
      <div class="search-bar">
        <input id="q" placeholder="Search adjudication decisions‚Ä¶ (e.g. ''example'' AND ''text''; ''example'' w/10 ''text'')">
        <button onclick="runSearch()">Search</button>
      </div>
      <button id="themeToggle" onclick="toggleTheme()">Switch to Dark Mode üåô</button>
    </div>
    <div class="search-controls">
      <select id="limit" class="results-limit">
        <option value="20">20 results</option>
        <option value="50">50 results</option>
        <option value="100">100 results</option>
      </select>
  
     <select id="sort" class="results-limit">
       <option value="relevance">Relevance</option>
       <option value="newest" selected>Date: Newest to Oldest</option>
       <option value="oldest">Date: Oldest to Newest</option>
       <option value="atoz">A ‚Üí Z (Claimant)</option>
       <option value="ztoa">Z ‚Üí A (Claimant)</option>
     </select>
    </div>
  </div>
</div>

    <!-- Sidebar Filters -->
    <aside class="filters-sidebar">
      <h3>Filters</h3>

      <!-- Jurisdiction -->
      <label>
        <input type="checkbox" id="jurisdiction"> Jurisdiction
      </label>

      <!-- Vexatious/Frivolous -->
      <label>
        <input type="checkbox" id="vexatious"> Vexatious / Frivolous
      </label>

      <!-- Year -->
      <label for="year">Year</label>
      <select id="year">
        <option value="">Any</option>
        <option>2025</option>
        <option>2024</option>
        <option>2023</option>
        <!-- add dynamically later -->
      </select>

      <!-- Act -->
      <label for="act">Act</label>
      <select id="act">
        <option value="">Any</option>
        <option value="bif">BIF Act</option>
        <option value="bcipa">BCIPA</option>
      </select>

      <!-- Amount ranges -->
      <label>Payment Claim ($)</label>
      <div id="claim-slider"></div>
      <div class="slider-inputs">
        <input type="number" id="claim-min" placeholder="Min">
        <input type="number" id="claim-max" placeholder="Max">
      </div>

      <label>Payment Schedule ($)</label>
      <div id="schedule-slider"></div>
      <div class="slider-inputs">
        <input type="number" id="schedule-min" placeholder="Min">
        <input type="number" id="schedule-max" placeholder="Max">
      </div>

      <label>Adjudicated Amount ($)</label>
      <div id="adj-slider"></div>
      <div class="slider-inputs">
        <input type="number" id="adj-min" placeholder="Min">
        <input type="number" id="adj-max" placeholder="Max">
      </div>

      <button id="applyFilters">Apply Filters</button>
    </aside>


    <main>
      <div id="status">Ready.</div>
      <div id="total"></div>
      <div id="results"></div>
      <div class="pagination" id="pagination"></div>
    </main>


    <script>
    function $(sel){ return document.querySelector(sel); }
    function sanitize(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
    function getFileName(path){ if (!path) return ''; return path.split('/').pop(); }
    function buildPdfLinks(path){
      if (!path) return null;
      const fileName = path.split("/").pop();  // just the filename
      const open = `https://storage.googleapis.com/sopal-bucket/pdfs/${fileName}`;
      return { open, download: open };
    }

    let state = { q:'', claimant:'', respondent:'', limit:20, offset:0, total:0 };
    let chatHistories = {}; // Store chat history for each decision

    async function runSearch(page=1){
      window.scrollTo(0, 0); // Scroll to top on new search/page
      $('#status').textContent = 'Searching‚Ä¶';
      startLoadingBar();

      state.q = normalizeInput($('#q')?.value);
      state.limit = +($('#limit')?.value || 20);
      state.offset = (page-1) * state.limit;
      const params = new URLSearchParams();
      state.sort = ($('#sort')?.value || 'newest');
      params.set('sort', state.sort);
      if (state.q) params.set('q', state.q);
      params.set('limit', state.limit);
      params.set('offset', state.offset);
      
      const res = await fetch(`/search_fast?${params.toString()}`, { headers: { 'Accept':'application/json' }});
      const data = await res.json().catch(()=>({}));

      finishLoadingBar();

      state.total = data.total || 0;

      $('#total').textContent = `Total: ${state.total.toLocaleString()} results`;
      $('#status').textContent = 'Done.';

      const items = data.items || [];
      $('#results').innerHTML = items.length
        ? items.map(it => renderItem(it, state.q && state.q.length > 0)).join('')
        : '<p>No results.</p>';

      renderPagination(page);
    }


function renderItem(it, query) {
  const pdf = buildPdfLinks(it.pdf_path);
  const caseName = `${sanitize(it.claimant)} v ${sanitize(it.respondent)}`;
  const caseNo = sanitize(it.case_no || it.adj_no || it.id || '');

  return `
    <div class="result">
      <h3><a href="#">${caseName}</a></h3>
      <div class="meta">
        ${it.decision_date_norm ? `<strong>Date:</strong> ${formatAusDate(it.decision_date_norm)}<br>` : '<strong>Date:</strong> Unknown<br>'}
        ${it.adjudicator ? `<strong>Adjudicator:</strong> ${sanitize(it.adjudicator)}<br>` : ''}
        ${it.claimant ? `<strong>Claimant:</strong> ${sanitize(it.claimant)}<br>` : ''}
        ${it.respondent ? `<strong>Respondent:</strong> ${sanitize(it.respondent)}<br>` : ''}
      </div>
      ${query ? (it.snippet ? `<p class="snippet">${it.snippet}</p>` : '') : ''}
      ${pdf ? `
        <a class="open-btn" href="${pdf.open}" target="_blank">Open Decision (PDF)</a>
        <span style="color:black; margin:0 6px;">|</span>
        <a href="javascript:void(0)" class="open-btn" onclick="summariseDecision('${it.id}')">
          Ask SopalAI
        </a>
      ` : ''}
      <div id="ai-container-${it.id}" class="ai-container" style="display:none;">
          <div class="chat-messages" id="chat-messages-${it.id}"></div>
          <div class="chat-input-area" id="chat-input-area-${it.id}" style="display:none;">
              <input type="text" id="chat-input-${it.id}" placeholder="Ask a follow-up question..." onkeydown="if(event.key==='Enter') sendChatMessage('${it.id}')">
              <button onclick="sendChatMessage('${it.id}')" aria-label="Send message">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
              </button>
          </div>
      </div>
    </div>`;
}


    function renderPagination(currentPage) {
      const totalPages = Math.ceil(state.total / state.limit);
      const container = $('#pagination');
      container.innerHTML = '';
      if (totalPages <= 1) return;

      const maxVisible = 10;
      let start = Math.max(1, currentPage - Math.floor(maxVisible / 2));
      let end = start + maxVisible - 1;
      if (end > totalPages) {
        end = totalPages;
        start = Math.max(1, end - maxVisible + 1);
      }

      if (currentPage > 1) {
        const prev = document.createElement('button');
        prev.textContent = '‚Äπ Previous';
        prev.onclick = () => runSearch(currentPage - 1);
        container.appendChild(prev);
      }

      if (start > 1) {
        const first = document.createElement('button');
        first.textContent = '1';
        first.onclick = () => runSearch(1);
        container.appendChild(first);
        const dots = document.createElement('span');
        dots.textContent = '...';
        dots.style.color = '#aaa';
        container.appendChild(dots);
      }

      for (let i = start; i <= end; i++) {
        const btn = document.createElement('button');
        btn.textContent = i;
        if (i === currentPage) btn.classList.add('active');
        btn.onclick = () => runSearch(i);
        container.appendChild(btn);
      }

      if (end < totalPages) {
        const dots = document.createElement('span');
        dots.textContent = '...';
        dots.style.color = '#aaa';
        container.appendChild(dots);
        const last = document.createElement('button');
        last.textContent = totalPages;
        last.onclick = () => runSearch(totalPages);
        container.appendChild(last);
      }

      if (currentPage < totalPages) {
        const next = document.createElement('button');
        next.textContent = 'Next ‚Ä∫';
        next.onclick = () => runSearch(currentPage - 1);
        container.appendChild(next);
      }

      const info = document.createElement('div');
      info.textContent = `Page ${currentPage} of ${totalPages}`;
      info.style.fontSize = '13px';
      info.style.color = '#aaa';
      info.style.marginTop = '6px';
      info.style.textAlign = 'center'; // Changed from right
      info.style.width = '100%'; // Ensure it takes full width to center
      container.appendChild(info);
    }

function toggleTheme() {
  const body = document.body;
  const isDark = body.classList.contains('dark');

  if (isDark) {
    body.classList.remove('dark');
    body.classList.add('light');
    localStorage.setItem('theme', 'light');
    document.getElementById('themeToggle').textContent = 'Switch to Dark Mode üåô';
  } else {
    body.classList.remove('light');
    body.classList.add('dark');
    localStorage.setItem('theme', 'dark');
    document.getElementById('themeToggle').textContent = 'Switch to Light Mode ‚òÄÔ∏è';
  }

  const logo = document.getElementById('logo');
  const footerLogo = document.getElementById('footerLogo');
  if (logo && footerLogo) {
    logo.src = body.classList.contains('dark')
      ? "assets/sopal_logo_white_v1.png"
      : "assets/sopal_logo_v1.png";
    footerLogo.src = body.classList.contains('dark')
      ? "assets/sopal_logo_white_v1.png"
      : "assets/sopal_logo_v1.png";
  }
}




    // ---- Init on load ----
const saved = localStorage.getItem('theme');
if (saved === 'dark') {
  document.body.classList.remove('light');
  document.body.classList.add('dark');
  document.getElementById('themeToggle').textContent = 'Switch to Light Mode ‚òÄÔ∏è';
} else {
  document.body.classList.add('light');
  document.getElementById('themeToggle').textContent = 'Switch to Dark Mode üåô';
}


      // Pressing Enter in the search bar
      const input = document.getElementById('q');
      if (input) {
        input.addEventListener('keydown', e => {
          if (e.key === 'Enter') {
            e.preventDefault();
            runSearch(1);
          }
        });
      }

      // Changing results-per-page triggers new search
      const limitSel = document.getElementById('limit');
      if (limitSel) {
        limitSel.addEventListener('change', () => runSearch(1));
      }
      
      const sortSel = document.getElementById('sort');
      if (sortSel) {
        sortSel.addEventListener('change', () => runSearch(1));
      }

      // Initial search
      runSearch();
    

    function startLoadingBar() {
  const bar = document.getElementById('loadingBar');
  bar.style.width = '0%';
  setTimeout(() => { bar.style.width = '50%'; }, 50); // jump to 50 quickly
}

function finishLoadingBar() {
  const bar = document.getElementById('loadingBar');
  bar.style.width = '100%';
  setTimeout(() => { bar.style.width = '0%'; }, 400); // hide after fill
}

function formatAusDate(iso) {
  if (!iso) return null;
  const d = new Date(iso);
  if (isNaN(d)) return null;
  return d.toLocaleDateString("en-AU", {
    day: "numeric",
    month: "long",
    year: "numeric"
  });
}

async function summariseDecision(id) {
    const container = document.getElementById(`ai-container-${id}`);
    const messagesBox = document.getElementById(`chat-messages-${id}`);
    const inputBox = document.getElementById(`chat-input-area-${id}`);

    if (container.style.display === 'block') {
        container.style.display = 'none';
        return;
    }

    container.style.display = 'block';
    messagesBox.innerHTML = '<div class="loading-text-gradient">Generating summary...</div>';
    inputBox.style.display = 'none';
    chatHistories[id] = [];

    try {
        const res = await fetch(`/summarise/${id}`);
        const data = await res.json();
        messagesBox.innerHTML = '';

        if (data.summary) {
            addAiMessage(id, data.summary);
            inputBox.style.display = 'flex';
        } else {
            addAiMessage(id, '‚ö†Ô∏è Failed to generate summary.');
        }
    } catch (e) {
        messagesBox.innerHTML = '';
        addAiMessage(id, '‚ö†Ô∏è Error contacting server.');
    }
}

async function sendChatMessage(id) {
    const input = document.getElementById(`chat-input-${id}`);
    const question = input.value.trim();
    if (!question) return;

    addUserMessage(id, question);
    input.value = '';

    const typingIndicator = addTypingIndicator(id);

    const history = chatHistories[id] || [];

    try {
        const res = await fetch(`/ask/${id}`, {
            method: "POST",
            body: new URLSearchParams({ question, history: JSON.stringify(history) }),
            headers: { "Content-Type": "application/x-www-form-urlencoded" }
        });
        const data = await res.json();

        typingIndicator.remove();

        if (data.answer) {
            addAiMessage(id, data.answer);
            chatHistories[id].push({ role: 'assistant', content: data.answer });
        } else {
            addAiMessage(id, `‚ö†Ô∏è Error: ${data.error || "Failed to get answer"}`);
        }
    } catch (e) {
         typingIndicator.remove();
         addAiMessage(id, `‚ö†Ô∏è Network or server error.`);
    }
}

function addAiMessage(id, htmlContent) {
    const messagesBox = document.getElementById(`chat-messages-${id}`);
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message ai-message';
    messageDiv.innerHTML = `
        <div class="message-avatar">S</div>
        <div class="message-content">
            <div class="ai-output-content">${cleanAIText(htmlContent)}</div>
        </div>
    `;
    messagesBox.appendChild(messageDiv);
    messagesBox.scrollTop = messagesBox.scrollHeight;
}

function addUserMessage(id, text) {
    const messagesBox = document.getElementById(`chat-messages-${id}`);
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message user-message';
    messageDiv.innerHTML = `
        <div class="message-avatar">U</div>
        <div class="message-content">${sanitize(text)}</div>
    `;
    messagesBox.appendChild(messageDiv);
    chatHistories[id].push({ role: 'user', content: text });
    messagesBox.scrollTop = messagesBox.scrollHeight;
}

function addTypingIndicator(id) {
    const messagesBox = document.getElementById(`chat-messages-${id}`);
    const typingDiv = document.createElement('div');
    typingDiv.className = 'message ai-message typing-indicator';
    typingDiv.innerHTML = `
        <div class="message-avatar">S</div>
        <div class="message-content">...</div>
    `;
    messagesBox.appendChild(typingDiv);
    messagesBox.scrollTop = messagesBox.scrollHeight;
    return typingDiv;
}


function cleanAIText(text) {
  if (!text) return '';
  // This function is now simplified as the backend sends HTML
  return text;
}

function normalizeInput(s) {
  return (s || '')
    .replace(/[‚Äú‚Äù]/g, '"')   // smart double ‚Üí straight
    .replace(/[‚Äò‚Äô]/g, "'")   // smart single ‚Üí straight
    .replace(/[‚Äê-‚Äì‚Äî]/g, '-') // hyphen variants ‚Üí hyphen
    .replace(/\s+/g, ' ')
    .trim();
}

   
    </script>

<footer class="footer">
  <div class="footer-content">
    <div class="footer-left">
      <img id="footerLogo" src="assets/sopal_logo_v1.png" alt="SOPAL" class="footer-logo">
      <p>An intelligent search tool for adjudication decisions under the Building Industry Fairness (Security of Payment) Act 2017 (Qld)</p>
    </div>

<div class="footer-links">
    <a href="index.html">Search</a>
    <a href="interest-calculator">Interest Calculator</a>
    <a href="due-date-calculator">Due Date Calculator</a>
    <a href="feedback">Feedback</a>
    <a href="how-to">How-To Guide</a>
    <a href="privacy">Privacy</a>
    <a href="terms">Terms</a>
</div>
  </div>
  <div class="footer-bottom">
    <p>¬© 2025 Sopal Australia. All rights reserved.</p>
  </div>


</footer>




   
</body>
</html>

