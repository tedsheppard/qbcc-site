<!doctype html>
<html lang="en">
<head>
 <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-QEN3X3DQLR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-QEN3X3DQLR');
</script>
 <link rel="icon" href="assets/favicon.ico" type="image/x-icon">
<link rel="shortcut icon" href="assets/favicon.ico" type="image/x-icon">

  <link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.js"></script>
  <meta charset="utf-8">
  <title>Sopal – Adjudication Search</title>
  <meta name="description" content="Sopal is an intelligent search tool for finding adjudication decisions under the Building Industry Fairness (Security of Payment) Act 2017 (BIF Act) in Queensland, Australia. Search decisions by keyword, adjudicator, date, and more.">
  <meta name="keywords" content="Sopal, adjudication decisions, BIF Act, Building Industry Fairness, Security of Payment Act, Queensland, construction law, payment disputes, QBCC search, adjudicator search, construction adjudication">
  <meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  /* Header from Privacy Page */
  .header {
    background: #fdfdfd;
    padding: 20px 25px;
    border-bottom: 1px solid #ddd;
    position: sticky;
    top: 0;
    z-index: 100;
  .header-content {
    display: flex;
    align-items: center;
    max-width: 1200px;
    margin: 0 auto;
  }
  .logo {
    height: 31px;
    margin-right: 20px;
  }
  .nav-links {
    margin-left: auto;
    display: flex;
    gap: 20px;
  }
  .nav-links a {
    color: black; 
    text-decoration: none;
    font-size: 14px;
    transition: color 0.2s;
  }
  .nav-links a:hover {
    color: #00c97c;
  }
  .nav-links a.active {
    color: #008a5c;
    font-weight: 600;
  }

  /* Light theme overrides */
  .light {
    background: #ffffff !important;
    color: #222 !important;
  }

  .light body {
    background: #ffffff !important;
    color: #222 !important;
  }

  .light header {
    background: #fdfdfd !important;
    border-bottom: 1px solid #ccc !important;
  }
  .light header h1 { color: #000 !important; }
  .light #themeToggle { color: #000 !important; }

  .light .search-section {
    background: #ffffff !important;
    border: 1px solid #ddd !important;
  }
  .light .search-section input { color: #000 !important; }

  .light .filters input,
  .light .filters select {
    background: #ffffff !important;
    border: 1px solid #ccc !important;
    color: #000 !important;
  }

  .light #results { background: #ffffff !important; }
  .light .result { 
    background: #fdfdfd !important;
    border: 1px solid #e5e5e5 !important;
  }
  .light .result h3 { color: #000 !important; }
  .light .meta { color: #666 !important; }
  .light .meta strong { color: #333 !important; }
  .light .snippet {
    background: #f8f9fa !important;
    color: #222 !important;
    border: 1px solid #e5e5e5 !important;
  }
  .light .pagination button { color: #00c97c !important; }

  /* Theme toggle button */
  #themeToggle {
    background: none;
    border: none;
    font-size: 11px;
    cursor: pointer;
    color: white;
    opacity: 0.8;
  }
  #themeToggle:hover { opacity: 1; }
  .light #themeToggle { color: #000; }

  /* Base body + main layout */
body {
  font-family: Inter, sans-serif;
  margin: 0;
  background: rgba(33,33,33,255);
  color: #e4e4e4;
  font-size: 80%;
}

  /* Main content alignment */
  main {
    max-width: 1200px;
    margin: 35px auto 0;
    padding: 0 25px;
  }

  h1 {
    font-size: 28px;
    border-bottom: 1px solid #eee;
    padding-bottom: 15px;
    margin-bottom: 20px;
  }

  /* Disclaimer */
  .disclaimer {
    background: #fffbeb;
    border-left: 4px solid #fbbf24;
    padding: 15px 20px;
    margin-bottom: 30px;
    border-radius: 0 6px 6px 0;
    font-size: 14px;
    color: #92400e;
  }

  .disclaimer strong {
    color: #b45309;
  }

  .dark .disclaimer {
    background: #2d1b0a;
    border-left-color: #f59e0b;
    color: #fbbf24;
  }

  /* Search section */
  .search-section {
    background: #fdfdfd;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
  }
  
  .search-section-content {
    max-width: 100%;
  }

  .search-section .search-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 20px;
    margin-bottom: 15px;
  }

  .search-section .search-bar {
    display: flex;
    align-items: center;
    background: #fff;
    border-radius: 20px;
    border: 1px solid #ccc;
    padding: 6px 15px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    flex: 1;
    max-width: 100%;
  }

.search-section .search-bar input {
  flex: 1;
  padding: 6px;
  font-size: 13px;
  border: none;
  outline: none;
  background: transparent;
  color: #000;
}

.search-section .search-bar button {
  background: #00c97c;
  border: none;
  color: white;
  padding: 8px 16px;
  border-radius: 18px;
  cursor: pointer;
  font-size: 13px;
  transition: all 0.2s;
}

  .search-section .search-bar button:hover { 
    background: #00a568;
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(0,201,124,0.25);
  }

  .search-controls {
    display: flex;
    gap: 10px;
  }

  #results { 
    margin-top: 20px;
    display: flex;
    flex-direction: column;
    gap: 0;
  }

  .result {
    padding: 20px;
    background: #fdfdfd;
    border: 1px solid #e5e5e5;
    border-radius: 8px;
    margin-bottom: 15px;
    transition: all 0.2s;
  }

  .result:hover {
    border-color: #00c97c;
    box-shadow: 0 2px 8px rgba(0,201,124,0.1);
  }

  .result h3 {
    margin: 0 0 10px;
    font-size: 16px;
  }
  .result h3 a {
      color: #fff;
  }
   .light .result h3 a {
      color: #000;
  }

  .meta {
    font-size: 13px;
    color: #aaa;
    margin-bottom: 12px;
    line-height: 1.8;
  }

  .meta strong {
    color: #ddd;
    font-weight: 600;
    min-width: 160px;
    display: inline-block;
  }

  .light .meta {
    color: #666;
  }

  .light .meta strong {
    color: #333;
  }

  .snippet {
    background: rgba(24,24,24,255);
    padding: 12px;
    border-radius: 6px;
    font-size: 12px;
    color: #ddd;
    border: 1px solid #2a2a2a;
    margin-bottom: 10px;
  }

  .light .snippet {
    background: #f8f9fa;
    color: #222;
    border-color: #e5e5e5;
  }

  mark {
    background: #b9f6ca;
    color: #000;
    padding: 0 1px;
    border-radius: 1px;
    font-weight: inherit;
  }

  .dark mark {
    background: #2e7d32;
    color: #e0ffe0;
  }
  
  /* General link styling */
  a {
    color: black;
    text-decoration: none;
    font-size: 14px;
    transition: color 0.2s;
  }
  a:hover {
    color: #00c97c;
    text-decoration: none;
  }
  
  /* Specific style for result action links */
  .result .open-btn {
      color: #0066cc;
      font-size: 13px;
  }
   .result .open-btn:hover {
      color: #004c99;
      text-decoration: underline;
  }

  .dark .result .open-btn { 
    color: #4da6ff !important; 
  }

  /* Pagination */
  .pagination {
    margin: 30px 0;
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 6px;
    font-size: 14px;
  }
  .pagination button {
    background: transparent;
    border: none;
    color: #8BD69A;
    cursor: pointer;
    padding: 4px 8px;
  }
  .pagination button.active {
    font-weight: bold;
    border-bottom: 2px solid #8BD69A;
  }
  .pagination button:hover { text-decoration: underline; }

  .dark .pagination button.active { 
    border-bottom: 2px solid #4da6ff; 
  }

  /* Footer */
  .footer {
    background: #fcfcfc;
    color: #333;
    padding: 40px 25px 20px;
    margin-top: 60px;
    border-top: 1px solid #ddd;
  }
  .footer-content {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    flex-wrap: wrap;
    max-width: 1200px;
    margin: auto;
  }
  .footer-left { 
    max-width: 400px;
    text-align: left;
  }
  .footer-logo { height: 24px; margin-bottom: 10px; }
  
  .footer-links {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px 40px;
    text-align: left;
  }
  .footer-links a {
    font-size: 13px;
  }

  .footer-bottom {
    text-align: center;
    border-top: 1px solid #eee;
    margin-top: 30px;
    padding-top: 20px;
    width: 100%;
    font-size: 0.85em;
    color: #666;
  }

  /* Filters sidebar (disabled for now) */
  .filters-sidebar { display: none !important; }

  /* Loading bar */
  #loadingBar {
    position: fixed;
    top: 0;
    left: 0;
    width: 0%;
    height: 4px;
    background: linear-gradient(to left, #21db87, #42ffaa);
    transition: width 0.7s ease;
    z-index: 9999;
  }

 /* Dark mode unified overrides */
.dark body {
  background: #0d0d0d !important;
  color: #e0e0e0 !important;
}

.dark .header,
.dark footer,
.dark .search-section {
  background: #141414 !important;
  color: #f0f0f0 !important;
  border-color: #333 !important;
}

.dark .nav-links a, 
.dark .footer-links a, 
.dark a {
  color: #f0f0f0;
}
.dark a:hover {
  color: #00c97c;
}
.dark .nav-links a.active {
    color: #00c97c;
}

.dark .result {
  background: #1a1a1a !important;
  border-color: #2a2a2a !important;
}

.dark .result:hover {
  border-color: #21db87;
  box-shadow: 0 2px 8px rgba(33,219,135,0.15);
}

.dark .snippet {
  background: #141414 !important;
  border: 1px solid #222 !important;
}

.dark .footer-bottom {
  border-top: 1px solid #333 !important;
  color: #aaa !important;
}

.dark .search-section {
  background: #1a1a1a !important;
  border-color: #2a2a2a !important;
}

.dark .search-bar {
  background: #141414 !important;
  border-color: #333 !important;
}

.dark .search-bar input {
  color: #fff !important;
}

 /* Base style */
.results-limit {
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;

  background: #fff;
  color: #000;
  border: 1px solid #ccc;
  border-radius: 6px;
  padding: 5px 24px 5px 12px;
  font-size: 12px;
  cursor: pointer;
  transition: background 0.2s, border 0.2s;
  position: relative;
  width: 180px;
  text-align: left;
}
.dark .results-limit {
  background: #1c1c1c;
  color: #fff;
  border-color: #333;
}

.results-limit:hover {
  background: #f7f7f7;
  border-color: #aaa;
}
.dark .results-limit:hover {
  background: #2a2a2a;
  border-color: #555;
}

.results-limit::after {
  content: "▾";
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  pointer-events: none;
  color: #aaa;
}

  :root {
    --primary-green: #08cc7c;
  }

 /* --- Mobile responsiveness --- */
@media (max-width: 768px) {
  .header-content {
    flex-direction: column;
    gap: 16px;
  }
  .nav-links {
    margin: 0;
    flex-wrap: wrap;
    justify-content: center;
  }
  .footer-content {
    flex-direction: column;
    align-items: center;
    text-align: center;
  }
  .footer-left {
    margin-bottom: 25px;
  }
  .footer-links {
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
  }

  main {
    padding: 0 13px;
    max-width: 100%;
  }

  .search-section {
    padding: 13px;
  }
  
  .search-section .search-row {
    flex-direction: column;
    align-items: stretch;
    gap: 13px;
  }
  
  .search-section .search-bar {
    max-width: none;
  }
}

 #status, #total {
  margin: 0 0 15px 0;
  padding: 0;
  font-size: 13px;
  color: #666;
  text-align: left;
}

.dark #status, 
.dark #total {
  color: #aaa;
}

/* ---- AI CHAT INTERFACE STYLES ---- */
.ai-container {
  border: 1px solid #ccc;
  border-radius: 8px;
  margin-top: 15px;
  max-width: 100%; /* Change from 800px to 100% */
}
.dark .ai-container {
  border-color: #444;
}

.chat-messages {
  max-height: 450px;
  overflow-y: auto;
  padding: 10px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.message {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  max-width: 90%;
}
.message-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
}
.ai-message .message-avatar {
  background: #10a37f;
  color: white;
}
.user-message .message-avatar {
  background: #e0e0e0;
  color: #333;
}
.dark .user-message .message-avatar {
    background: #555;
    color: #eee;
}

.message-content {
  padding: 10px 14px;
  border-radius: 12px;
  font-size: 13px;
  line-height: 1.5;
}

.ai-message {
  align-self: flex-start;
}
.ai-message .message-content {
  background: #f0f0f0;
  color: #222;
  border-top-left-radius: 0;
}
.dark .ai-message .message-content {
  background: #2a2a2a;
  color: #eee;
}

.user-message {
  align-self: flex-end;
  flex-direction: row-reverse;
}
.user-message .message-content {
  background: #dcf8c6;
  color: #111;
  border-top-right-radius: 0;
}
.dark .user-message .message-content {
    background: #056162;
    color: #e0e0e0;
}

.chat-input-area {
  display: flex;
  align-items: center;
  padding: 8px 12px;
  border-top: 1px solid #e0e0e0;
}
.dark .chat-input-area {
  border-top-color: #444;
}

.chat-input-area input {
  flex-grow: 1;
  border: none;
  background: transparent;
  padding: 10px;
  font-size: 13px;
  outline: none;
  color: #222;
  margin-right: 8px;
}
.dark .chat-input-area input {
  color: #eee;
}

.chat-input-area button {
  background: #10a37f;
  color: white;
  border: none;
  border-radius: 50%;
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: background 0.2s;
  flex-shrink: 0;
}
.chat-input-area button:hover {
  background: #0d8a6c;
}
.chat-input-area button svg {
    margin-left: -1px;
    margin-top: 1px;
}

.typing-indicator {
    font-style: italic;
    color: #888;
}

.ai-output-content p { margin: 4px 0 6px 0; }
.ai-output-content strong { display: block; margin: 10px 0 4px 0; font-size: 14px; font-weight: 600; }
.ai-output-content ul { margin: 4px 0 8px 18px; padding: 0; }
.ai-output-content li { margin: 2px 0; }
.ai-output-content h3, .ai-output-content h4 { font-size: 15px; font-weight: 600; margin: 10px 0 4px 0; }

/* Loading text gradient */
.loading-text-gradient {
  font-size: 14px;
  font-weight: 500;
  padding: 10px;
  background: linear-gradient(to right, #222 30%, #ccc 50%, #222 70%);
  background-size: 200% auto;
  color: transparent;
  background-clip: text;
  -webkit-background-clip: text;
  animation: shimmer 1s linear infinite;
  text-align: left;
}

@keyframes shimmer {
  to {
    background-position: -200% center;
  }
}

.dark .loading-text-gradient {
  background: linear-gradient(to right, #eee 30%, #555 50%, #eee 70%);
  background-size: 200% auto;
  background-clip: text;
  -webkit-background-clip: text;
  color: transparent;
}

.meta {
  font-size: 13px;
  color: #aaa;
  margin-bottom: 12px;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px 20px;
}

.meta-column {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.meta-column div {
  line-height: 1.4;
}

.meta strong {
  color: #ddd;
  font-weight: 600;
  min-width: 140px;
  display: inline-block;
}

.light .meta {
  color: #666;
}

.light .meta strong {
  color: #333;
}

@media (max-width: 768px) {
  .meta {
    grid-template-columns: 1fr;
  }
}

/* --- Adjudicator Search Interception Modal --- */
.interception-modal {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 2000;
}
.interception-modal-content {
  background: #fff; color: #333; padding: 30px 35px; border-radius: 8px;
  max-width: 500px; width: 90%; text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.2);
}
.dark .interception-modal-content { background: #1a1a1a; color: #eee; }
.interception-modal h2 { font-size: 22px; margin-top: 0; }
.interception-modal p { margin-bottom: 25px; line-height: 1.6; }
.interception-modal-buttons { display: flex; gap: 15px; justify-content: center; }
.interception-modal-buttons button {
  padding: 12px 20px; border-radius: 6px; border: none; font-size: 15px;
  font-weight: 600; cursor: pointer; transition: all 0.2s;
}
.btn-primary-action { background: #00c97c; color: white; }
.btn-primary-action:hover { background: #00a568; }
.btn-secondary-action { background: #e9ecef; color: #333; }
.dark .btn-secondary-action { background: #333; color: #eee; }
.btn-secondary-action:hover { background: #dee2e6; }

</style>

</head>
  <body class="light">
    <div id="loadingBar"></div>

<!-- Header -->
<div class="header">
  <div class="header-content">
    <a href="/">
      <img id="logo" src="assets/sopal_logo_v1.png" alt="SOPAL" class="logo">
    </a>
    <div class="nav-links">
      <a href="index.html" class="active">Search</a>
      <a href="adjudicators">Adjudicators</a>
      <a href="interest-calculator">Interest Calculator</a>
      <a href="due-date-calculator">Due Date Calculator</a>
      <a href="how-to">How-To Guide</a>
      <a href="feedback">Feedback</a>
    </div>
    <div id="user-profile-nav"></div>
  </div>
</div>

<main>
  <h1>Adjudication Decision Search</h1>


  <div class="search-section">
    <div class="search-section-content">
      <div class="search-row">
        <div class="search-bar">
          <input id="q" placeholder="Search adjudication decisions... (e.g. 'example' AND 'text'; 'example' w/10 'text')">
          <button onclick="runSearch()">Search</button>
        </div>
        <button id="themeToggle" onclick="toggleTheme()">Switch to Dark Mode</button>
      </div>
      <div class="search-controls">
        <select id="limit" class="results-limit">
          <option value="20">20 results</option>
          <option value="50">50 results</option>
          <option value="100">100 results</option>
        </select>
    
        <select id="sort" class="results-limit">
          <option value="relevance">Relevance</option>
          <option value="newest" selected>Date: Newest to Oldest</option>
          <option value="oldest">Date: Oldest to Newest</option>
          <option value="atoz">A → Z (Claimant)</option>
          <option value="ztoa">Z → A (Claimant)</option>
        </select>
      </div>
    </div>
  </div>

  <div id="status">Ready.</div>
  <div id="total"></div>
  <div id="results"></div>
  <div class="pagination" id="pagination"></div>

<div id="adjudicatorSearchModal" class="interception-modal">
  <div class="interception-modal-content">
    <h2>Adjudicator Search</h2>
    <p>
      To view decisions and statistics for a specific adjudicator, please use our dedicated Adjudicator Insights tool. Direct searches for adjudicators are disabled on this page.
    </p>
    <div class="interception-modal-buttons">
      <button id="closeModalBtn" class="btn-secondary-action">Run a Different Search</button>
      <button id="viewInsightsBtn" class="btn-primary-action">Go to Adjudicator Insights</button>
    </div>
  </div>
</div>

</main>

<script>
  
    function $(sel){ return document.querySelector(sel); }
    function sanitize(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
    function getFileName(path){ if (!path) return ''; return path.split('/').pop(); }
    function buildPdfLinks(path){
      if (!path) return null;
      const fileName = path.split("/").pop();
      const open = `https://storage.googleapis.com/sopal-bucket/pdfs/${fileName}`;
      return { open, download: open };
    }

    let state = { q:'', claimant:'', respondent:'', limit:20, offset:0, total:0 };
    let adjudicatorList = []; 
    let chatHistories = {};


    // Replace your existing fetchAdjudicators function with this one
async function fetchAdjudicators() {
  try {
    const response = await fetch('/api/adjudicators');
    if (!response.ok) return;
    const data = await response.json();
    // Store names AND their parts for flexible matching
    adjudicatorList = data.map(adj => ({
      fullName: adj.name.toLowerCase(),
      parts: adj.name.toLowerCase().split(' ').filter(p => p.length > 1) // Store parts, ignore initials
    }));
    console.log(`Loaded ${adjudicatorList.length} adjudicators for search check.`);
  } catch (error) {
    console.error('Could not fetch adjudicator list:', error);
  }
}
   

    async function runSearch(page=1, bypassAdjudicatorCheck = false){
      if (!bypassAdjudicatorCheck && adjudicatorList.length > 0) {
    const query = normalizeInput($('#q').value);
    if (findMatchingAdjudicator(query)) {
      showAdjudicatorModal();
      return; // Stop the standard search
    }
  }
      try {
        window.scrollTo(0, 0);
        const statusEl = $('#status');
        const totalEl = $('#total');
        const qEl = $('#q');
        const limitEl = $('#limit');
        const sortEl = $('#sort');
        
        if (!statusEl || !totalEl || !qEl || !limitEl || !sortEl) {
          console.error('Missing required elements');
          return;
        }
        
        statusEl.textContent = 'Searching...';
        startLoadingBar();

        state.q = normalizeInput(qEl.value);
        state.limit = +(limitEl.value || 20);
        state.offset = (page-1) * state.limit;
        state.sort = (sortEl.value || 'newest');
        
        const params = new URLSearchParams();
        params.set('sort', state.sort);
        if (state.q) params.set('q', state.q);
        params.set('limit', state.limit);
        params.set('offset', state.offset);
        
        const res = await fetch(`/search_fast?${params.toString()}`, { 
          headers: { 'Accept':'application/json' }
        });
        
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        
        const data = await res.json();

        finishLoadingBar();

        state.total = data.total || 0;

        totalEl.textContent = `Total: ${state.total.toLocaleString()} results`;
        statusEl.textContent = 'Done.';

        const items = data.items || [];
        $('#results').innerHTML = items.length
          ? items.map(it => renderItem(it, state.q && state.q.length > 0)).join('')
          : '<p>No results.</p>';

        renderPagination(page);
      } catch (error) {
        console.error('Search error:', error);
        $('#status').textContent = 'Error: ' + error.message;
        finishLoadingBar();
      }
    }

// Replace your existing findMatchingAdjudicator function with this one
function findMatchingAdjudicator(query) {
  if (!query || query.length < 3 || !adjudicatorList.length) return null;

  const cleanedQuery = query
    .toLowerCase()
    .replace(/"/g, '')
    .replace(/\b(and|or|not|w\/\d+|near\/\d+)\b/gi, ' ')
    .replace(/[^\w\s]/g, '')
    .replace(/\s+/g, ' ')
    .trim();

  if (!cleanedQuery) return null;

  for (const adjudicator of adjudicatorList) {
    // We check for names with at least two parts (e.g., "john smith")
    // to avoid blocking common single-word searches.
    if (adjudicator.parts.length < 2) continue;

    // Check if ALL parts of the adjudicator's name are present in the user's query
    const allPartsFound = adjudicator.parts.every(part => cleanedQuery.includes(part));

    if (allPartsFound) {
      return adjudicator.fullName;
    }
  }

  return null;
}

  if (!query || query.length < 3 || !adjudicatorList.length) return null;

  const cleanedQuery = query
    .toLowerCase()
    .replace(/"/g, '')
    .replace(/\b(and|or|not|w\/\d+|near\/\d+)\b/gi, ' ')
    .replace(/[^\w\s]/g, '')
    .replace(/\s+/g, ' ')
    .trim();

  if (!cleanedQuery) return null;

  for (const adjudicator of adjudicatorList) {
    // We check for names with at least two parts (e.g., "john smith")
    // to avoid blocking common single-word searches.
    if (adjudicator.parts.length < 2) continue;

    // Check if ALL parts of the adjudicator's name are present in the user's query
    const allPartsFound = adjudicator.parts.every(part => cleanedQuery.includes(part));

    if (allPartsFound) {
      return adjudicator.fullName;
    }
  }

  return null;
}


// Replace your old showAdjudicatorModal function with this one
function showAdjudicatorModal() {
  const modal = document.getElementById('adjudicatorSearchModal');
  modal.style.display = 'flex';

  // Function to hide the modal
  const closeModal = () => {
    modal.style.display = 'none';
  };

  // Button to go to the adjudicators page
  document.getElementById('viewInsightsBtn').onclick = () => {
    window.location.href = '/adjudicators';
  };

  // New "Close" button functionality
  document.getElementById('closeModalBtn').onclick = closeModal;

  // Allow closing by clicking the background
  modal.onclick = (e) => {
    if (e.target === modal) {
      closeModal();
    }
  };
}

function renderItem(it, query) {
  const pdf = buildPdfLinks(it.pdf_path);
  const caseName = `${sanitize(it.claimant)} v ${sanitize(it.respondent)}`;
  
  const formatCurrency = (val) => {
    if (!val || val === 'N/A' || val === '') return '$0.00';
    const num = parseFloat(val);
    return isNaN(num) ? '$0.00' : `$${num.toLocaleString('en-AU', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
  };
  
  const formatPercent = (val) => {
    if (!val || val === 'N/A' || val === '') return '0.0%';
    const num = parseFloat(val);
    return isNaN(num) ? '0.0%' : `${num.toFixed(1)}%`;
  };

  return `
    <div class="result">
      <h3><a href="#">${caseName}</a></h3>
      <div class="meta">
        <div class="meta-column">
          ${it.decision_date_norm ? `<div><strong>Date:</strong> ${formatAusDate(it.decision_date_norm)}</div>` : '<div><strong>Date:</strong> Unknown</div>'}
          ${it.adjudicator ? `<div><strong>Adjudicator:</strong> ${sanitize(it.adjudicator)}</div>` : ''}
          ${it.claimant ? `<div><strong>Claimant:</strong> ${sanitize(it.claimant)}</div>` : ''}
          ${it.respondent ? `<div><strong>Respondent:</strong> ${sanitize(it.respondent)}</div>` : ''}
          
        </div>
        <div class="meta-column">
          <div><strong>Claimed Amount:</strong> ${formatCurrency(it.claimed_amount)}</div>
          <div><strong>Adjudicated Amount:</strong> ${formatCurrency(it.adjudicated_amount)}</div>
          <div><strong>Claimant Fee:</strong> ${formatPercent(it.fee_claimant_proportion)}</div>
          <div><strong>Respondent Fee:</strong> ${formatPercent(it.fee_respondent_proportion)}</div>
        </div>
      </div>
      ${query ? (it.snippet ? `<p class="snippet">${it.snippet}</p>` : '') : ''}
      ${pdf ? `
        <a class="open-btn" href="${pdf.open}" target="_blank">Open Decision (PDF)</a>
        <span style="color:#666; margin:0 6px;">|</span>
        <a href="javascript:void(0)" class="open-btn" onclick="summariseDecision('${it.id}')">
          Ask SopalAI
        </a>
      ` : ''}
      <div id="ai-container-${it.id}" class="ai-container" style="display:none;">
          <div class="chat-messages" id="chat-messages-${it.id}"></div>
          <div class="chat-input-area" id="chat-input-area-${it.id}" style="display:none;">
              <input type="text" id="chat-input-${it.id}" placeholder="Ask a follow-up question..." onkeydown="if(event.key==='Enter') sendChatMessage('${it.id}')">
              <button onclick="sendChatMessage('${it.id}')" aria-label="Send message">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
              </button>
          </div>
      </div>
    </div>`;
}

function renderPagination(currentPage) {
  const totalPages = Math.ceil(state.total / state.limit);
  const container = $('#pagination');
  if (!container) return;
  
  container.innerHTML = '';
  if (totalPages <= 1) return;

  const maxVisible = 10;
  let start = Math.max(1, currentPage - Math.floor(maxVisible / 2));
  let end = start + maxVisible - 1;
  if (end > totalPages) {
    end = totalPages;
    start = Math.max(1, end - maxVisible + 1);
  }

  if (currentPage > 1) {
    const prev = document.createElement('button');
    prev.textContent = '‹ Previous';
    prev.onclick = () => runSearch(currentPage - 1);
    container.appendChild(prev);
  }

  if (start > 1) {
    const first = document.createElement('button');
    first.textContent = '1';
    first.onclick = () => runSearch(1);
    container.appendChild(first);
    const dots = document.createElement('span');
    dots.textContent = '...';
    dots.style.color = '#aaa';
    container.appendChild(dots);
  }

  for (let i = start; i <= end; i++) {
    const btn = document.createElement('button');
    btn.textContent = i;
    if (i === currentPage) btn.classList.add('active');
    btn.onclick = () => runSearch(i);
    container.appendChild(btn);
  }

  if (end < totalPages) {
    const dots = document.createElement('span');
    dots.textContent = '...';
    dots.style.color = '#aaa';
    container.appendChild(dots);
    const last = document.createElement('button');
    last.textContent = totalPages;
    last.onclick = () => runSearch(totalPages);
    container.appendChild(last);
  }

  if (currentPage < totalPages) {
    const next = document.createElement('button');
    next.textContent = 'Next ›';
    next.onclick = () => runSearch(currentPage + 1);
    container.appendChild(next);
  }

  const info = document.createElement('div');
  info.textContent = `Page ${currentPage} of ${totalPages}`;
  info.style.fontSize = '13px';
  info.style.color = '#aaa';
  info.style.marginTop = '6px';
  info.style.textAlign = 'center';
  info.style.width = '100%';
  container.appendChild(info);
}

function toggleTheme() {
  const body = document.body;
  const isDark = body.classList.contains('dark');

  if (isDark) {
    body.classList.remove('dark');
    body.classList.add('light');
    localStorage.setItem('theme', 'light');
    document.getElementById('themeToggle').textContent = 'Switch to Dark Mode';
  } else {
    body.classList.remove('light');
    body.classList.add('dark');
    localStorage.setItem('theme', 'dark');
    document.getElementById('themeToggle').textContent = 'Switch to Light Mode';
  }

  const logo = document.getElementById('logo');
  const footerLogo = document.getElementById('footerLogo');
  if (logo && footerLogo) {
    logo.src = body.classList.contains('dark')
      ? "assets/sopal_logo_white_v1.png"
      : "assets/sopal_logo_v1.png";
    footerLogo.src = body.classList.contains('dark')
      ? "assets/sopal_logo_white_v1.png"
      : "assets/sopal_logo_v1.png";
  }
}

const saved = localStorage.getItem('theme');
if (saved === 'dark') {
  document.body.classList.remove('light');
  document.body.classList.add('dark');
  document.getElementById('themeToggle').textContent = 'Switch to Light Mode';
} else {
  document.body.classList.add('light');
  document.getElementById('themeToggle').textContent = 'Switch to Dark Mode';
}

const input = document.getElementById('q');
if (input) {
  input.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      e.preventDefault();
      runSearch(1);
    }
  });
}

const limitSel = document.getElementById('limit');
if (limitSel) {
  limitSel.addEventListener('change', () => runSearch(1));
}

const sortSel = document.getElementById('sort');
if (sortSel) {
  sortSel.addEventListener('change', () => runSearch(1));
}

fetchAdjudicators();

runSearch();



function startLoadingBar() {
  const bar = document.getElementById('loadingBar');
  bar.style.width = '0%';
  setTimeout(() => { bar.style.width = '50%'; }, 50);
}

function finishLoadingBar() {
  const bar = document.getElementById('loadingBar');
  bar.style.width = '100%';
  setTimeout(() => { bar.style.width = '0%'; }, 400);
}

function formatAusDate(iso) {
  if (!iso) return null;
  const d = new Date(iso);
  if (isNaN(d)) return null;
  return d.toLocaleDateString("en-AU", {
    day: "numeric",
    month: "long",
    year: "numeric"
  });
}

async function summariseDecision(id) {
    const container = document.getElementById(`ai-container-${id}`);
    const messagesBox = document.getElementById(`chat-messages-${id}`);
    const inputBox = document.getElementById(`chat-input-area-${id}`);

    if (container.style.display === 'block') {
        container.style.display = 'none';
        return;
    }

    container.style.display = 'block';
    messagesBox.innerHTML = '<div class="loading-text-gradient">Generating summary...</div>';
    inputBox.style.display = 'none';
    chatHistories[id] = [];

    try {
        const res = await fetch(`/summarise/${id}`);
        const data = await res.json();
        messagesBox.innerHTML = '';

        if (data.summary) {
            addAiMessage(id, data.summary);
            inputBox.style.display = 'flex';
        } else {
            addAiMessage(id, '⚠️ Failed to generate summary.');
        }
    } catch (e) {
        messagesBox.innerHTML = '';
        addAiMessage(id, '⚠️ Error contacting server.');
    }
}

async function sendChatMessage(id) {
    const input = document.getElementById(`chat-input-${id}`);
    const question = input.value.trim();
    if (!question) return;

    addUserMessage(id, question);
    input.value = '';

    const typingIndicator = addTypingIndicator(id);

    const history = chatHistories[id] || [];

    try {
        const res = await fetch(`/ask/${id}`, {
            method: "POST",
            body: new URLSearchParams({ question, history: JSON.stringify(history) }),
            headers: { "Content-Type": "application/x-www-form-urlencoded" }
        });
        const data = await res.json();

        typingIndicator.remove();

        if (data.answer) {
            addAiMessage(id, data.answer);
            chatHistories[id].push({ role: 'assistant', content: data.answer });
        } else {
            addAiMessage(id, `⚠️ Error: ${data.error || "Failed to get answer"}`);
        }
    } catch (e) {
         typingIndicator.remove();
         addAiMessage(id, `⚠️ Network or server error.`);
    }
}

function addAiMessage(id, htmlContent) {
    const messagesBox = document.getElementById(`chat-messages-${id}`);
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message ai-message';
    messageDiv.innerHTML = `
        <div class="message-avatar">S</div>
        <div class="message-content">
            <div class="ai-output-content">${cleanAIText(htmlContent)}</div>
        </div>
    `;
    messagesBox.appendChild(messageDiv);
    messagesBox.scrollTop = messagesBox.scrollHeight;
}

function addUserMessage(id, text) {
    const messagesBox = document.getElementById(`chat-messages-${id}`);
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message user-message';
    messageDiv.innerHTML = `
        <div class="message-avatar">U</div>
        <div class="message-content">${sanitize(text)}</div>
    `;
    messagesBox.appendChild(messageDiv);
    chatHistories[id].push({ role: 'user', content: text });
    messagesBox.scrollTop = messagesBox.scrollHeight;
}

function addTypingIndicator(id) {
    const messagesBox = document.getElementById(`chat-messages-${id}`);
    const typingDiv = document.createElement('div');
    typingDiv.className = 'message ai-message typing-indicator';
    typingDiv.innerHTML = `
        <div class="message-avatar">S</div>
        <div class="message-content">...</div>
    `;
    messagesBox.appendChild(typingDiv);
    messagesBox.scrollTop = messagesBox.scrollHeight;
    return typingDiv;
}

function cleanAIText(text) {
  if (!text) return '';
  return text;
}

function normalizeInput(s) {
  return (s || '')
    .replace(/[""]/g, '"')
    .replace(/['']/g, "'")
    .replace(/[‐‑‒–—―]/g, '-')
    .replace(/\s+/g, ' ')
    .trim();
}
</script>

<footer class="footer">
  <div class="footer-content">
    <div class="footer-left">
      <img id="footerLogo" src="assets/sopal_logo_v1.png" alt="SOPAL" class="footer-logo">
      <p>An intelligent search tool for adjudication decisions under the Building Industry Fairness (Security of Payment) Act 2017 (Qld)</p>
    </div>

    <div class="footer-links">
      <a href="index.html">Search</a>
      <a href="interest-calculator">Interest Calculator</a>
      <a href="due-date-calculator">Due Date Calculator</a>
      <a href="feedback">Feedback</a>
      <a href="how-to">How-To Guide</a>
      <a href="privacy">Privacy</a>
      <a href="terms">Terms</a>
    </div>
  </div>
  <div class="footer-bottom">
    <p>© 2025 Sopal Australia. All rights reserved.</p>
  </div>
</footer>
<script src="/assets/js/main.js"></script>
</body>
</html>
