<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Create Account | Sopal</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;450;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg-dark: #0a0a0a;
      --bg-darker: #050505;
      --green: #00d47e;
      --green-dark: #00b368;
      --text-primary: #1a1a1a;
      --text-secondary: #6b6b6b;
      --text-muted: #888;
      --border-light: #e5e5e5;
    }
    body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; color: var(--text-primary); background: #fafafa; line-height: 1.5; -webkit-font-smoothing: antialiased; }
    a { text-decoration: none; color: inherit; }
    button { border: none; cursor: pointer; font-family: inherit; }

    .nav { background: var(--bg-dark); border-bottom: 1px solid rgba(255,255,255,0.06); position: sticky; top: 0; z-index: 100; }
    .nav-inner { display: flex; align-items: center; justify-content: space-between; height: 56px; max-width: 1200px; margin: 0 auto; padding: 0 32px; }
    .nav-left { display: flex; align-items: center; gap: 32px; }
    .nav-logo { display: flex; align-items: center; gap: 8px; color: white; font-weight: 700; font-size: 17px; letter-spacing: -0.02em; }
    .nav-logo-icon { width: 28px; height: 28px; background: var(--green); border-radius: 7px; display: flex; align-items: center; justify-content: center; }
    .nav-logo-icon svg { width: 16px; height: 16px; }
    .nav-links { display: flex; align-items: center; gap: 24px; }
    .nav-links a { color: #999; font-size: 14px; font-weight: 450; transition: color 0.2s; }
    .nav-links a:hover { color: white; }
    .nav-right { display: flex; align-items: center; gap: 12px; }

    .main-content { display: flex; justify-content: center; padding: 40px 20px 60px; }
    .register-card { background: white; border: 1px solid var(--border-light); border-radius: 14px; padding: 40px; width: 100%; max-width: 700px; }
    .register-card h1 { font-size: 24px; font-weight: 700; letter-spacing: -0.02em; text-align: center; margin-bottom: 6px; }
    .register-card .subtitle { font-size: 14px; color: var(--text-secondary); text-align: center; margin-bottom: 28px; }

    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .form-group { margin-bottom: 4px; }
    .form-group.full-width { grid-column: 1 / -1; }
    .form-label { display: block; font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.03em; }
    .form-label .required { color: #ef4444; }
    .form-label .optional { font-weight: 400; color: var(--text-muted); text-transform: none; letter-spacing: 0; }
    .form-input, .form-select { width: 100%; padding: 10px 14px; font-size: 14px; font-family: inherit; border: 1px solid var(--border-light); border-radius: 8px; outline: none; transition: border-color 0.2s; background: white; }
    .form-input:focus, .form-select:focus { border-color: var(--green); }
    .form-hint { font-size: 11px; color: var(--text-muted); margin-top: 4px; }

    .section-divider { grid-column: 1 / -1; border-top: 1px solid var(--border-light); margin: 8px 0; }
    .section-title { grid-column: 1 / -1; font-size: 12px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.04em; margin-top: 4px; }

    .submit-btn { width: 100%; padding: 12px; font-size: 14px; font-weight: 600; border-radius: 8px; background: var(--green); color: #000; transition: background 0.2s; margin-top: 8px; }
    .submit-btn:hover { background: var(--green-dark); }

    .terms-label { display: flex; align-items: flex-start; gap: 8px; font-size: 13px; color: var(--text-secondary); cursor: pointer; margin-top: 8px; }
    .terms-label input[type="checkbox"] { margin-top: 2px; cursor: pointer; }
    .terms-label a { color: var(--green-dark); text-decoration: underline; }

    .extra-links { text-align: center; margin-top: 20px; font-size: 13px; color: var(--text-secondary); }
    .extra-links a { color: var(--green-dark); font-weight: 500; }
    .extra-links a:hover { text-decoration: underline; }

    .feedback-message { padding: 12px; margin-top: 12px; border-radius: 8px; font-size: 13px; display: none; grid-column: 1 / -1; line-height: 1.6; }
    .feedback-message.error { background: #fef2f2; color: #991b1b; border: 1px solid #fecaca; display: block; }

    @media (max-width: 768px) {
      .nav-links { display: none; }
      .form-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

  <nav class="nav">
    <div class="nav-inner">
      <div class="nav-left">
        <a href="/new-test/" class="nav-logo">
  <img src="/assets/sopal_logo_white_v1.png" alt="Sopal" style="height: 22px; width: auto;">
</a>
        <div class="nav-links">
          <a href="/new-test/search">Search</a>
          <a href="/new-test/adjudicators">Adjudicators</a>
          <a href="/new-test/interest-calculator">Interest Calculator</a>
          <a href="/new-test/due-date-calculator">Due Date Calculator</a>
          <a href="/new-test/how-to">How-To Guide</a>
          <a href="/new-test/feedback">Feedback</a>
        </div>
      </div>
      <div class="nav-right"></div>
    </div>
  </nav>

  <div class="main-content">
    <div class="register-card">
      <h1>Create an Account</h1>
      <p class="subtitle">Join Sopal to access exclusive features and insights.</p>
      <form id="registerForm">
        <div class="form-grid">
          <div class="section-title">Account</div>
          <div class="form-group full-width">
            <label class="form-label" for="email">Email Address <span class="required">*</span></label>
            <input type="email" class="form-input" id="email" name="email" required>
          </div>
          <div class="form-group">
            <label class="form-label" for="password">Password <span class="required">*</span></label>
            <input type="password" class="form-input" id="password" name="password" required minlength="8">
            <div class="form-hint">Minimum 8 characters</div>
          </div>
          <div class="form-group">
            <label class="form-label" for="password_confirm">Confirm Password <span class="required">*</span></label>
            <input type="password" class="form-input" id="password_confirm" name="password_confirm" required minlength="8">
          </div>

          <div class="section-divider"></div>
          <div class="section-title">Personal Details</div>
          <div class="form-group">
            <label class="form-label" for="first_name">First Name <span class="required">*</span></label>
            <input type="text" class="form-input" id="first_name" name="first_name" required>
          </div>
          <div class="form-group">
            <label class="form-label" for="last_name">Last Name <span class="required">*</span></label>
            <input type="text" class="form-input" id="last_name" name="last_name" required>
          </div>
          <div class="form-group">
            <label class="form-label" for="firm_name">Firm/Company Name <span class="optional">(optional)</span></label>
            <input type="text" class="form-input" id="firm_name" name="firm_name">
          </div>
          <div class="form-group">
            <label class="form-label" for="abn">ABN <span class="optional">(optional)</span></label>
            <input type="text" class="form-input" id="abn" name="abn" pattern="[0-9\s]{11,14}" placeholder="11 digit ABN">
            <div class="form-hint">Enter 11 digits (spaces optional)</div>
          </div>

          <div class="section-divider"></div>
          <div class="section-title">Address</div>
          <div class="form-group full-width">
            <label class="form-label" for="billing_address">Address <span class="required">*</span></label>
            <input type="text" class="form-input" id="billing_address" name="billing_address" required>
          </div>
          <div class="form-group">
            <label class="form-label" for="billing_city">City <span class="required">*</span></label>
            <input type="text" class="form-input" id="billing_city" name="billing_city" required>
          </div>
          <div class="form-group">
            <label class="form-label" for="billing_state">State <span class="required">*</span></label>
            <select class="form-select" id="billing_state" name="billing_state" required>
              <option value="">Select</option>
              <option value="QLD">QLD</option>
              <option value="NSW">NSW</option>
              <option value="VIC">VIC</option>
              <option value="SA">SA</option>
              <option value="WA">WA</option>
              <option value="TAS">TAS</option>
              <option value="NT">NT</option>
              <option value="ACT">ACT</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label" for="billing_postcode">Postcode <span class="required">*</span></label>
            <input type="text" class="form-input" id="billing_postcode" name="billing_postcode" required pattern="[0-9]{4}" placeholder="4000">
          </div>

          <div class="section-divider"></div>
          <div class="form-group">
            <label class="form-label" for="employee_size">Number of Employees <span class="optional">(optional)</span></label>
            <select class="form-select" id="employee_size" name="employee_size">
              <option value="">Select size...</option>
              <option value="1-10">1-10</option>
              <option value="11-50">11-50</option>
              <option value="51-200">51-200</option>
              <option value="201+">201+</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label" for="phone">Phone Number <span class="optional">(optional)</span></label>
            <input type="tel" class="form-input" id="phone" name="phone">
          </div>

          <div id="feedbackDiv" class="feedback-message"></div>

          <div class="form-group full-width">
            <label class="terms-label">
              <input type="checkbox" required>
              <span>I agree to the <a href="/account-terms" target="_blank">Account Terms &amp; Conditions</a></span>
            </label>
          </div>

          <div class="form-group full-width">
            <button type="submit" class="submit-btn">Create Account</button>
          </div>
        </div>
      </form>
      <div class="extra-links">
        <p>Already have an account? <a href="/new-test/login">Sign in</a></p>
      </div>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const registerForm = document.getElementById('registerForm');
    const feedbackDiv = document.getElementById('feedbackDiv');
    const urlParams = new URLSearchParams(window.location.search);
    const redirectUrl = urlParams.get('redirect');

    // Update login link to carry redirect
    const loginLink = document.querySelector('.extra-links a[href="/new-test/login"]');
    if (redirectUrl && loginLink) {
        loginLink.href = `/new-test/login?redirect=${encodeURIComponent(redirectUrl)}`;
    }

    registerForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        feedbackDiv.className = 'feedback-message';
        feedbackDiv.innerHTML = '';

        const formData = new FormData(registerForm);
        const password = formData.get('password');
        const passwordConfirm = formData.get('password_confirm');
        const email = formData.get('email');
        const firstName = formData.get('first_name');
        const lastName = formData.get('last_name');
        const billingAddress = formData.get('billing_address');
        const billingCity = formData.get('billing_city');
        const billingState = formData.get('billing_state');
        const billingPostcode = formData.get('billing_postcode');
        const abn = formData.get('abn');

        // Client-side validation
        const errors = [];
        if (!email) errors.push('Email is required');
        if (!password) errors.push('Password is required');
        if (password !== passwordConfirm) errors.push('Passwords do not match');
        if (password.length < 8) errors.push('Password must be at least 8 characters');
        if (!firstName) errors.push('First name is required');
        if (!lastName) errors.push('Last name is required');
        if (!billingAddress) errors.push('Address is required');
        if (!billingCity) errors.push('City is required');
        if (!billingState) errors.push('State is required');
        if (!billingPostcode) errors.push('Postcode is required');

        if (abn && abn.trim()) {
            const abnCleaned = abn.replace(/\s/g, '');
            if (!/^\d{11}$/.test(abnCleaned)) {
                errors.push('ABN must be exactly 11 digits');
            }
        }

        if (errors.length > 0) {
            feedbackDiv.innerHTML = errors.map(err => `&bull; ${err}`).join('<br>');
            feedbackDiv.className = 'feedback-message error';
            return;
        }

        try {
            const registerResponse = await fetch('/purchase-register', {
                method: 'POST',
                body: formData
            });

            if (!registerResponse.ok) {
                const errorData = await registerResponse.json();
                throw new Error(errorData.detail || 'Registration failed.');
            }

            // Auto-login
            const loginFormData = new FormData();
            loginFormData.append('username', email);
            loginFormData.append('password', password);

            const loginResponse = await fetch('/purchase-login', {
                method: 'POST',
                body: loginFormData
            });

            if (!loginResponse.ok) {
                throw new Error('Registration successful, but auto-login failed. Please try logging in manually.');
            }

            const loginData = await loginResponse.json();
            localStorage.setItem('purchase_token', loginData.access_token);
            window.location.href = redirectUrl || '/account.html';

        } catch (error) {
            feedbackDiv.textContent = error.message;
            feedbackDiv.className = 'feedback-message error';
        }
    });
});
</script>
<script src="/new-test/assets/js/main.js"></script>
</body>
</html>
