<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin | Sopal</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;450;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg-dark: #0a0a0a;
      --bg-darker: #050505;
      --green: #00d47e;
      --green-dark: #00b368;
      --text-primary: #1a1a1a;
      --text-secondary: #6b6b6b;
      --text-muted: #888;
      --border-light: #e5e5e5;
    }
    body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; color: var(--text-primary); background: #fafafa; line-height: 1.5; -webkit-font-smoothing: antialiased; display: flex; flex-direction: column; min-height: 100vh; }
    a { text-decoration: none; color: inherit; }
    button { border: none; cursor: pointer; font-family: inherit; }
    .container { max-width: 1200px; margin: 0 auto; padding: 0 32px; }

    /* Nav */
    .nav { background: var(--bg-dark); border-bottom: 1px solid rgba(255,255,255,0.06); position: sticky; top: 0; z-index: 100; }
    .nav-inner { display: flex; align-items: center; justify-content: space-between; height: 56px; max-width: 1200px; margin: 0 auto; padding: 0 32px; }
    .nav-left { display: flex; align-items: center; gap: 32px; }
    .nav-logo { display: flex; align-items: center; gap: 8px; color: white; font-weight: 700; font-size: 17px; letter-spacing: -0.02em; }
    .nav-links { display: flex; align-items: center; gap: 24px; }
    .nav-links a { color: #999; font-size: 14px; font-weight: 450; transition: color 0.2s; }
    .nav-links a:hover { color: white; }
    .nav-links a.active { color: white; font-weight: 500; }
    .nav-right { display: flex; align-items: center; gap: 12px; }
    .nav-right .nav-user { color: #999; font-size: 13px; }
    .nav-right .nav-logout { color: #999; font-size: 13px; font-weight: 500; background: none; padding: 6px 12px; border-radius: 6px; transition: all 0.2s; }
    .nav-right .nav-logout:hover { color: white; background: rgba(255,255,255,0.08); }

    /* Page Header */
    .page-header { background: white; border-bottom: 1px solid var(--border-light); padding: 32px 0; }
    .page-header h1 { font-size: 28px; font-weight: 700; letter-spacing: -0.03em; margin-bottom: 4px; }
    .page-header p { font-size: 14px; color: var(--text-secondary); }

    /* Login Card */
    .login-wrapper { flex: 1; display: flex; align-items: center; justify-content: center; padding: 40px 20px; }
    .login-card { background: white; border: 1px solid var(--border-light); border-radius: 14px; padding: 40px; width: 100%; max-width: 400px; }
    .login-card h1 { font-size: 24px; font-weight: 700; letter-spacing: -0.02em; text-align: center; margin-bottom: 6px; }
    .login-card .subtitle { font-size: 14px; color: var(--text-secondary); text-align: center; margin-bottom: 28px; }
    .form-group { margin-bottom: 18px; }
    .form-label { display: block; font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.03em; }
    .form-input { width: 100%; padding: 10px 14px; font-size: 14px; font-family: inherit; border: 1px solid var(--border-light); border-radius: 8px; outline: none; transition: border-color 0.2s; }
    .form-input:focus { border-color: var(--green); }
    .submit-btn { width: 100%; padding: 12px; font-size: 14px; font-weight: 600; border-radius: 8px; background: var(--green); color: #000; transition: background 0.2s; margin-top: 4px; }
    .submit-btn:hover { background: var(--green-dark); }
    .feedback-message { padding: 12px; margin-top: 16px; border-radius: 8px; font-size: 13px; display: none; }
    .feedback-message.error { background: #fef2f2; color: #991b1b; border: 1px solid #fecaca; display: block; }
    .feedback-message.success { background: #f0fdf4; color: #166534; border: 1px solid #bbf7d0; display: block; }

    /* Quick Access Gate */
    .quick-access { text-align: center; margin-bottom: 28px; padding-bottom: 28px; border-bottom: 1px solid var(--border-light); }
    .quick-access h2 { font-size: 13px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.04em; margin-bottom: 14px; }
    .quick-access-input { width: 160px; padding: 10px 14px; font-size: 20px; font-family: 'Inter', monospace; text-align: center; letter-spacing: 0.2em; border: 1px solid var(--border-light); border-radius: 8px; outline: none; transition: border-color 0.2s; }
    .quick-access-input:focus { border-color: var(--green); }
    .quick-access-input.error { border-color: #f87171; animation: qa-shake 0.4s ease; }
    @keyframes qa-shake { 0%,100%{transform:translateX(0)} 20%{transform:translateX(-6px)} 40%{transform:translateX(6px)} 60%{transform:translateX(-4px)} 80%{transform:translateX(4px)} }
    .login-form-area { display: block; }
    .or-divider { display: flex; align-items: center; gap: 12px; margin: 20px 0; color: var(--text-muted); font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em; }
    .or-divider::before, .or-divider::after { content: ''; flex: 1; height: 1px; background: var(--border-light); }

    /* Access Denied */
    .access-denied { flex: 1; display: flex; align-items: center; justify-content: center; padding: 40px 20px; }
    .access-denied-card { text-align: center; }
    .access-denied-card h2 { font-size: 22px; font-weight: 700; margin-bottom: 8px; }
    .access-denied-card p { color: var(--text-secondary); font-size: 14px; margin-bottom: 20px; }
    .access-denied-card .btn-back { display: inline-block; padding: 10px 24px; font-size: 14px; font-weight: 600; border-radius: 8px; background: var(--green); color: #000; transition: background 0.2s; }
    .access-denied-card .btn-back:hover { background: var(--green-dark); }

    /* Admin Layout */
    .admin-layout { max-width: 1200px; margin: 0 auto; padding: 32px 32px 72px; flex: 1; }
    .admin-container { display: flex; gap: 32px; }

    /* Admin Sidebar */
    .admin-nav { flex: 0 0 200px; }
    .admin-nav .nav-btn {
      display: block; width: 100%; text-align: left; padding: 10px 14px;
      border: none; background: none; border-radius: 8px; cursor: pointer;
      font-size: 14px; font-weight: 450; color: var(--text-secondary);
      margin-bottom: 4px; transition: all 0.2s; font-family: inherit;
    }
    .admin-nav .nav-btn:hover { background: white; color: var(--text-primary); }
    .admin-nav .nav-btn.active { background: white; color: var(--text-primary); font-weight: 600; border: 1px solid var(--border-light); }

    /* Admin Content */
    .admin-content { flex: 1; min-width: 0; }
    .admin-section { display: none; }
    .admin-section.active { display: block; }

    /* Cards */
    .card { background: white; border: 1px solid var(--border-light); border-radius: 14px; padding: 28px; margin-bottom: 24px; }
    .card h2 { font-size: 18px; font-weight: 700; letter-spacing: -0.02em; margin-bottom: 6px; }
    .card .card-desc { font-size: 13px; color: var(--text-secondary); margin-bottom: 20px; }

    /* Stats Grid */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .stat-card { background: white; border: 1px solid var(--border-light); border-radius: 10px; padding: 20px; }
    .stat-card .stat-label { font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.04em; margin-bottom: 6px; }
    .stat-card .stat-value { font-size: 28px; font-weight: 700; letter-spacing: -0.03em; }
    .chart-card { background: white; border: 1px solid var(--border-light); border-radius: 14px; padding: 28px; margin-bottom: 24px; }
    .chart-card h3 { font-size: 15px; font-weight: 600; margin-bottom: 16px; }
    .chart-card canvas { width: 100% !important; max-height: 300px; }
    .period-selector { display: flex; gap: 6px; margin-bottom: 20px; }
    .period-btn { padding: 6px 14px; font-size: 12px; font-weight: 600; border-radius: 6px; background: #f5f5f5; color: var(--text-secondary); border: 1px solid var(--border-light); transition: all 0.2s; font-family: inherit; cursor: pointer; }
    .period-btn:hover { background: #eee; }
    .period-btn.active { background: var(--green); color: #000; border-color: var(--green); }

    /* Tables */
    .table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th, td { padding: 10px 12px; text-align: left; vertical-align: top; border-bottom: 1px solid var(--border-light); }
    th { font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.04em; background: #fafafa; white-space: nowrap; }
    td { color: var(--text-primary); }

    /* Badges */
    .badge { display: inline-block; padding: 2px 8px; border-radius: 20px; font-size: 11px; font-weight: 600; }
    .badge-green { background: #ecfdf5; color: #065f46; }
    .badge-red { background: #fef2f2; color: #991b1b; }
    .badge-yellow { background: #fffbeb; color: #92400e; }
    .badge-gray { background: #f3f4f6; color: #4b5563; }

    /* Gate Toggle */
    .gate-box { display: flex; align-items: center; gap: 20px; padding: 20px; border-radius: 10px; border: 1px solid var(--border-light); }
    .gate-box .gate-info { flex: 1; }
    .gate-box .gate-info strong { font-size: 15px; display: block; margin-bottom: 4px; }
    .gate-box .gate-info p { font-size: 13px; color: var(--text-secondary); margin: 0; }
    .gate-box.gate-on { background: #fffbeb; border-color: #fde68a; }
    .gate-box.gate-off { background: #ecfdf5; border-color: #a7f3d0; }

    /* Buttons */
    .btn { display: inline-flex; align-items: center; padding: 8px 16px; font-size: 13px; font-weight: 600; border-radius: 8px; transition: all 0.2s; }
    .btn-primary { background: var(--green); color: #000; }
    .btn-primary:hover { background: var(--green-dark); }
    .btn-primary:disabled { background: #e5e5e5; color: #999; cursor: not-allowed; }
    .btn-danger { background: #fef2f2; color: #991b1b; border: 1px solid #fecaca; }
    .btn-danger:hover { background: #fee2e2; }
    .btn-sm { padding: 5px 10px; font-size: 12px; }

    /* Search Input */
    .search-bar { display: flex; gap: 10px; margin-bottom: 20px; }
    .search-bar input { flex: 1; padding: 10px 14px; font-size: 14px; font-family: inherit; border: 1px solid var(--border-light); border-radius: 8px; outline: none; transition: border-color 0.2s; }
    .search-bar input:focus { border-color: var(--green); }

    /* Full Access form */
    .inline-form { display: flex; gap: 10px; margin-bottom: 20px; }
    .inline-form input { flex: 1; padding: 10px 14px; font-size: 14px; font-family: inherit; border: 1px solid var(--border-light); border-radius: 8px; outline: none; }
    .inline-form input:focus { border-color: var(--green); }

    /* Feedback inline */
    .inline-feedback { font-size: 13px; margin-top: 10px; }
    .inline-feedback.ok { color: #065f46; }
    .inline-feedback.err { color: #991b1b; }

    /* Loading & Error */
    .loading { color: var(--text-muted); font-size: 14px; padding: 20px 0; }
    .error-text { color: #991b1b; font-size: 14px; }

    /* Upload zone */
    .drop-zone { border: 2px dashed var(--border-light); border-radius: 10px; padding: 40px; text-align: center; cursor: pointer; transition: all 0.2s; background: #fafafa; }
    .drop-zone:hover, .drop-zone.dragover { background: #ecfdf5; border-color: var(--green); }
    .drop-zone p { margin: 0; color: var(--text-secondary); font-size: 14px; }
    .drop-zone strong { color: var(--text-primary); }

    /* Metadata table inputs */
    .meta-table input, .meta-table select { width: 100%; min-width: 110px; padding: 6px 8px; font-size: 12px; font-family: inherit; border: 1px solid var(--border-light); border-radius: 6px; outline: none; }
    .meta-table input:focus { border-color: var(--green); }
    .status-pending { color: var(--text-muted); font-weight: 600; }
    .status-saving { color: #92400e; font-weight: 600; }
    .status-success { color: #065f46; font-weight: 600; }
    .status-error { color: #991b1b; font-weight: 600; }

    /* Backup feedback */
    .action-feedback { margin-top: 16px; padding: 12px 16px; border-radius: 8px; font-size: 13px; display: none; }
    .action-feedback.show { display: block; }
    .action-feedback.ok { background: #ecfdf5; color: #065f46; border: 1px solid #a7f3d0; }
    .action-feedback.err { background: #fef2f2; color: #991b1b; border: 1px solid #fecaca; }
    .action-feedback.info { background: #f0f9ff; color: #075985; border: 1px solid #bae6fd; }

    /* Footer */
    .footer { background: var(--bg-darker); border-top: 1px solid rgba(255,255,255,0.06); padding: 44px 0 28px; color: #777; margin-top: auto; }
    .footer-inner { display: grid; grid-template-columns: 1.8fr repeat(3, 1fr); gap: 24px; }
    .footer-brand { padding-right: 16px; }
    .footer-brand .footer-logo { display: flex; align-items: center; gap: 7px; color: white; font-weight: 700; font-size: 15px; margin-bottom: 10px; }
    .footer-brand p { font-size: 12px; color: #555; line-height: 1.5; }
    .footer-col h4 { font-size: 11px; font-weight: 600; color: #888; text-transform: uppercase; letter-spacing: 0.04em; margin-bottom: 14px; }
    .footer-col a { display: block; font-size: 13px; color: #666; margin-bottom: 7px; transition: color 0.2s; }
    .footer-col a:hover { color: white; }
    .footer-bottom { display: flex; align-items: center; justify-content: center; margin-top: 36px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.06); font-size: 12px; color: #555; }

    @media (max-width: 768px) {
      .nav-links { display: none; }
      .admin-container { flex-direction: column; }
      .admin-nav { flex: none; display: flex; gap: 8px; overflow-x: auto; }
      .admin-nav .nav-btn { white-space: nowrap; }
      .footer-inner { grid-template-columns: 1fr; }
      .stats-grid { grid-template-columns: 1fr 1fr; }
    }
  </style>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
</head>
<body>

  <!-- Nav -->
  <nav class="nav">
    <div class="nav-inner">
      <div class="nav-left">
        <a href="/new-test/" class="nav-logo"><img src="/assets/sopal_logo_white_v1.png" alt="Sopal" style="height: 22px; width: auto;"></a>
        <div class="nav-links">
          <a href="/new-test/search">Search</a>
          <a href="/new-test/adjudicators">Adjudicators</a>
          <a href="/new-test/interest-calculator">Interest Calculator</a>
          <a href="/new-test/due-date-calculator">Due Date Calculator</a>
        </div>
      </div>
      <div class="nav-right" id="navRight"></div>
    </div>
  </nav>

  <!-- VIEW: Login -->
  <div id="viewLogin" class="login-wrapper" style="display: none;">
    <div class="login-card">
      <h1>Admin Sign In</h1>
      <p class="subtitle">Restricted to admin accounts only.</p>
      <div class="quick-access" id="quickAccess">
        <h2>Quick access code</h2>
        <input type="text" class="quick-access-input" id="qaCode" maxlength="6" inputmode="numeric" pattern="[0-9]*" placeholder="------" autocomplete="off">
      </div>
      <div class="or-divider">or sign in</div>
      <div class="login-form-area" id="loginFormArea">
        <form id="loginForm">
          <div class="form-group">
            <label class="form-label" for="email">Email Address</label>
            <input type="email" class="form-input" id="email" name="username" required>
          </div>
          <div class="form-group">
            <label class="form-label" for="password">Password</label>
            <input type="password" class="form-input" id="password" name="password" required>
          </div>
          <button type="submit" class="submit-btn">Sign In</button>
        </form>
        <div id="loginFeedback" class="feedback-message"></div>
      </div>
    </div>
  </div>

  <!-- VIEW: Access Denied -->
  <div id="viewDenied" class="access-denied" style="display: none;">
    <div class="access-denied-card">
      <h2>Access Denied</h2>
      <p>Your account does not have admin privileges.</p>
      <div style="margin: 24px 0;">
        <div class="quick-access" id="quickAccessDenied">
          <h2>Quick access code</h2>
          <input type="text" class="quick-access-input" id="qaCodeDenied" maxlength="6" inputmode="numeric" pattern="[0-9]*" placeholder="------" autocomplete="off">
        </div>
      </div>
      <a href="#" id="tryDifferentAccount" style="display:inline-block;margin-bottom:12px;color:var(--green-dark);font-size:14px;font-weight:500;">Sign in with a different account</a><br>
      <a href="/new-test/" class="btn-back">Back to Home</a>
    </div>
  </div>

  <!-- VIEW: Admin Dashboard -->
  <div id="viewDashboard" style="display: none;">
    <div class="page-header">
      <div class="container">
        <h1>Admin Hub</h1>
        <p>Manage users, settings, and system operations.</p>
      </div>
    </div>

    <div class="admin-layout">
      <div class="admin-container">
        <aside class="admin-nav" id="adminNav">
          <button class="nav-btn" data-tab="stats">Overview</button>
          <button class="nav-btn" data-tab="gate">Search Gate</button>
          <button class="nav-btn" data-tab="users">User Accounts</button>
          <button class="nav-btn" data-tab="searches">Search Activity</button>
          <button class="nav-btn" data-tab="adjudicators">Adjudicator Activity</button>
          <button class="nav-btn" data-tab="fullaccess">Full Access</button>
          <button class="nav-btn" data-tab="invoicerequests">Invoice Requests</button>
          <button class="nav-btn" data-tab="subscriptions">Subscriptions</button>
          <button class="nav-btn" data-tab="upload">Upload Decisions</button>
          <button class="nav-btn" data-tab="backup">Backups</button>
        </aside>

        <div class="admin-content">
          <!-- Stats / Overview -->
          <section id="tab-stats" class="admin-section"></section>

          <!-- Search Gate -->
          <section id="tab-gate" class="admin-section"></section>

          <!-- Users -->
          <section id="tab-users" class="admin-section"></section>

          <!-- Search Activity -->
          <section id="tab-searches" class="admin-section"></section>

          <!-- Adjudicator Activity -->
          <section id="tab-adjudicators" class="admin-section"></section>

          <!-- Full Access -->
          <section id="tab-fullaccess" class="admin-section"></section>

          <!-- Invoice Requests -->
          <section id="tab-invoicerequests" class="admin-section"></section>

          <!-- Subscriptions -->
          <section id="tab-subscriptions" class="admin-section"></section>

          <!-- Upload Decisions -->
          <section id="tab-upload" class="admin-section">
            <div class="card">
              <h2>Batch Upload Decisions</h2>
              <p class="card-desc">Drag and drop PDF files below. Edit metadata in the table before saving.</p>
              <div class="drop-zone" id="dropZone">
                <p><strong>Drag &amp; Drop PDF files here</strong><br>or click to select files</p>
                <input type="file" id="fileInput" multiple accept=".pdf" style="display: none;">
              </div>
              <div id="metaContainer" style="display: none; margin-top: 24px;">
                <h3 style="font-size: 15px; font-weight: 600; margin-bottom: 12px;">File Metadata</h3>
                <div class="table-wrap">
                  <table class="meta-table" id="metaTable">
                    <thead>
                      <tr>
                        <th>Filename</th>
                        <th>Status</th>
                        <th>EJS ID</th>
                        <th>Reference ID</th>
                        <th>Date (Text)</th>
                        <th>Date (YYYY-MM-DD)</th>
                        <th>Adjudicator</th>
                        <th>Claimant</th>
                        <th>Respondent</th>
                        <th>Claimed $</th>
                        <th>Adjudicated $</th>
                        <th>Fee Claimant %</th>
                        <th>Fee Respondent %</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody id="metaBody"></tbody>
                  </table>
                </div>
                <div style="margin-top: 16px;">
                  <button class="btn btn-primary" id="saveAllBtn">Save All Pending</button>
                  <span id="saveAllFeedback" class="inline-feedback" style="margin-left: 12px;"></span>
                </div>
              </div>
            </div>
          </section>

          <!-- Backups -->
          <section id="tab-backup" class="admin-section">
            <div class="card">
              <h2>Save Database to Cloud</h2>
              <p class="card-desc">Upload the current SQLite database to Google Cloud Storage.</p>
              <button class="btn btn-primary" id="saveDbBtn">Save Database</button>
              <div id="saveDbFeedback" class="action-feedback"></div>
            </div>
            <div class="card">
              <h2>Meilisearch Backup</h2>
              <p class="card-desc">Create a point-in-time snapshot and upload to Google Cloud Storage.</p>
              <button class="btn btn-primary" id="backupBtn">Create New Backup</button>
              <div id="backupFeedback" class="action-feedback"></div>
            </div>
          </section>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <div class="footer-inner">
        <div class="footer-brand">
          <div class="footer-logo"><img src="/assets/sopal_logo_white_v1.png" alt="Sopal" style="height: 18px; width: auto;"></div>
          <p>An intelligent search tool for adjudication decisions under the Building Industry Fairness (Security of Payment) Act 2017 (Qld)</p>
        </div>
        <div class="footer-col"><h4>Tools</h4><a href="/new-test/search">Decision Search</a><a href="/new-test/adjudicators">Adjudicators</a><a href="/new-test/interest-calculator">Interest Calculator</a><a href="/new-test/due-date-calculator">Due Date Calculator</a></div>
        <div class="footer-col"><h4>Resources</h4><a href="/new-test/how-to">How-To Guide</a><a href="/new-test/feedback">Feedback</a></div>
        <div class="footer-col"><h4>Legal</h4><a href="/new-test/privacy">Privacy</a><a href="/new-test/terms">Terms of Use</a><a href="/new-test/account-terms">Account Terms</a><a href="/new-test/adjudicator-insights-terms">Adjudicator Insights Terms</a></div>
      </div>
      <div class="footer-bottom">&copy; 2026 Sopal Australia. All rights reserved.</div>
    </div>
  </footer>

<script>
document.addEventListener('DOMContentLoaded', () => {

  // ─── State ───────────────────────────────────────────────
  let token = localStorage.getItem('purchase_token');
  let currentUser = null;
  const loadedTabs = new Set();
  const filesStore = new Map();

  // ─── DOM refs ────────────────────────────────────────────
  const viewLogin = document.getElementById('viewLogin');
  const viewDenied = document.getElementById('viewDenied');
  const viewDashboard = document.getElementById('viewDashboard');
  const loginForm = document.getElementById('loginForm');
  const loginFeedback = document.getElementById('loginFeedback');
  const navRight = document.getElementById('navRight');

  // ─── Quick Access Gate ──────────────────────────────────
  async function handleQAInput(input) {
    input.value = input.value.replace(/\D/g, '');
    if (input.value.length === 6) {
      try {
        const fd = new FormData();
        fd.append('code', input.value);
        const res = await fetch('/admin/code-auth', { method: 'POST', body: fd });
        if (!res.ok) throw new Error();
        const data = await res.json();
        token = data.access_token;
        localStorage.setItem('purchase_token', token);
        init(); // re-run auth flow — will now see admin token
      } catch {
        input.classList.add('error');
        setTimeout(() => { input.classList.remove('error'); input.value = ''; }, 500);
      }
    }
  }

  document.getElementById('qaCode').addEventListener('input', function() { handleQAInput(this); });
  document.getElementById('qaCodeDenied').addEventListener('input', function() { handleQAInput(this); });
  document.getElementById('tryDifferentAccount').addEventListener('click', (e) => {
    e.preventDefault();
    localStorage.removeItem('purchase_token');
    token = null;
    showView(viewLogin);
    document.getElementById('email').focus();
  });

  // ─── Views ───────────────────────────────────────────────
  function showView(view) {
    viewLogin.style.display = 'none';
    viewDenied.style.display = 'none';
    viewDashboard.style.display = 'none';
    view.style.display = '';
  }

  // ─── Auth Flow ───────────────────────────────────────────
  async function init() {
    if (!token) {
      showView(viewLogin);
      return;
    }
    try {
      const res = await fetch('/purchase-me', {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (!res.ok) {
        localStorage.removeItem('purchase_token');
        token = null;
        showView(viewLogin);
        return;
      }
      const data = await res.json();
      if (!data.is_admin) {
        showView(viewDenied);
        return;
      }
      currentUser = data;
      showDashboard();
    } catch (e) {
      localStorage.removeItem('purchase_token');
      token = null;
      showView(viewLogin);
    }
  }

  // Login form handler
  loginForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    loginFeedback.className = 'feedback-message';
    loginFeedback.textContent = '';

    const formData = new FormData(loginForm);
    try {
      const res = await fetch('/purchase-login', { method: 'POST', body: formData });
      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.detail || 'Login failed.');
      }
      const data = await res.json();
      token = data.access_token;
      localStorage.setItem('purchase_token', token);
      init();
    } catch (err) {
      loginFeedback.textContent = err.message;
      loginFeedback.className = 'feedback-message error';
    }
  });

  // ─── Dashboard Init ──────────────────────────────────────
  function showDashboard() {
    showView(viewDashboard);

    // Nav user info
    navRight.innerHTML = `
      <span class="nav-user">${currentUser.email || ''}</span>
      <button class="nav-logout" id="logoutBtn">Sign Out</button>
    `;
    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('purchase_token');
      token = null;
      currentUser = null;
      window.location.reload();
    });

    // Tab navigation
    const navBtns = document.querySelectorAll('#adminNav .nav-btn');
    navBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        window.location.hash = btn.dataset.tab;
      });
    });
    window.addEventListener('hashchange', () => activateTab(window.location.hash));

    // Setup static sections
    setupUpload();
    setupBackups();

    // Activate initial tab
    activateTab(window.location.hash || '#stats');
  }

  function activateTab(hash) {
    const tabId = (hash || '#stats').replace('#', '');
    const navBtns = document.querySelectorAll('#adminNav .nav-btn');
    const sections = document.querySelectorAll('.admin-section');

    navBtns.forEach(b => b.classList.toggle('active', b.dataset.tab === tabId));
    sections.forEach(s => s.classList.toggle('active', s.id === `tab-${tabId}`));

    if (!loadedTabs.has(tabId)) {
      loadTab(tabId);
    }
  }

  function loadTab(tabId) {
    if (tabId === 'upload' || tabId === 'backup') return; // static sections
    loadedTabs.add(tabId);

    switch (tabId) {
      case 'stats': loadStats(); break;
      case 'gate': loadGate(); break;
      case 'users': loadUsersTab(); break;
      case 'searches': loadTable('/admin/search-activity', 'tab-searches', 'Latest 1000 Searches', renderSearchesTable); break;
      case 'adjudicators': loadTable('/admin/adjudicator-activity', 'tab-adjudicators', 'Latest 1000 Adjudicator Page Views', renderAdjudicatorsTable); break;
      case 'fullaccess': loadFullAccess(); break;
      case 'invoicerequests': loadInvoiceRequests(); break;
      case 'subscriptions': loadTable('/admin/all-subscriptions', 'tab-subscriptions', 'All Subscriptions', renderSubscriptionsTable); break;
    }
  }

  // ─── Helpers ─────────────────────────────────────────────
  function authHeaders() {
    return { 'Authorization': `Bearer ${token}` };
  }

  function formatAEST(isoString) {
    if (!isoString) return 'N/A';
    try {
      const utcStr = isoString.replace(' ', 'T') + (isoString.includes('Z') ? '' : 'Z');
      return new Date(utcStr).toLocaleString('en-AU', {
        timeZone: 'Australia/Sydney',
        year: 'numeric', month: 'short', day: 'numeric',
        hour: '2-digit', minute: '2-digit', hour12: true
      });
    } catch (e) { return isoString; }
  }

  function esc(str) {
    if (str == null) return '';
    const d = document.createElement('div');
    d.textContent = String(str);
    return d.innerHTML;
  }

  // ─── Stats / Overview ────────────────────────────────────
  async function loadStats() {
    const section = document.getElementById('tab-stats');
    section.innerHTML = '<div class="card"><p class="loading">Loading overview...</p></div>';
    let currentPeriod = '30d';

    async function fetchAndRender(period) {
        currentPeriod = period;
        try {
            const [statsRes, usersRes] = await Promise.all([
                fetch(`/admin/stats?period=${period}`, { headers: authHeaders() }),
                fetch('/admin/all-users', { headers: authHeaders() })
            ]);
            let statsData = statsRes.ok ? await statsRes.json() : null;
            let users = usersRes.ok ? await usersRes.json() : [];

            let html = '';

            // Period selector
            const labels = {'7d':'7 Days','14d':'14 Days','30d':'1 Month','90d':'3 Months','365d':'1 Year','all':'All Time'};
            html += '<div class="period-selector">';
            Object.entries(labels).forEach(([p, label]) => {
                html += `<button class="period-btn ${p === period ? 'active' : ''}" data-period="${p}">${label}</button>`;
            });
            html += '</div>';

            // Stat cards
            if (statsData && statsData.summary) {
                const s = statsData.summary;
                html += `<div class="stats-grid">
                    <div class="stat-card"><div class="stat-label">Total Users</div><div class="stat-value">${s.total_users.toLocaleString()}</div></div>
                    <div class="stat-card"><div class="stat-label">Total Searches</div><div class="stat-value">${s.total_searches.toLocaleString()}</div></div>
                    <div class="stat-card"><div class="stat-label">Searches Today</div><div class="stat-value">${s.searches_today.toLocaleString()}</div></div>
                    <div class="stat-card"><div class="stat-label">Users This Month</div><div class="stat-value">${s.users_this_month}</div></div>
                    <div class="stat-card"><div class="stat-label">Adjudicator Views</div><div class="stat-value">${s.total_adjudicator_views.toLocaleString()}</div></div>
                </div>`;
            } else {
                html += `<div class="stats-grid"><div class="stat-card"><div class="stat-label">Total Users</div><div class="stat-value">${users.length}</div></div></div>`;
            }

            // Charts
            if (statsData) {
                html += '<div class="chart-card"><h3>Search Volume</h3><div style="position:relative;height:280px"><canvas id="searchChart"></canvas></div></div>';
                html += '<div class="chart-card"><h3>New Registrations</h3><div style="position:relative;height:280px"><canvas id="regChart"></canvas></div></div>';
                html += '<div class="chart-card"><h3>Adjudicator Page Views</h3><div style="position:relative;height:280px"><canvas id="adjViewChart"></canvas></div></div>';
            }

            // Recent registrations table
            const recent = users.slice(0, 10);
            if (recent.length > 0) {
                html += `<div class="card"><h2>Recent Registrations</h2><div class="table-wrap"><table>
                    <thead><tr><th>Email</th><th>Name</th><th>Firm</th><th>Registered</th></tr></thead>
                    <tbody>${recent.map(u => `<tr>
                        <td>${esc(u.email)}</td>
                        <td>${esc((u.first_name||'')+' '+(u.last_name||''))}</td>
                        <td>${esc(u.firm_name)}</td>
                        <td>${formatAEST(u.created_at)}</td>
                    </tr>`).join('')}</tbody>
                </table></div></div>`;
            }

            section.innerHTML = html;

            // Bind period buttons
            section.querySelectorAll('.period-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    loadedTabs.delete('stats');
                    fetchAndRender(btn.dataset.period);
                });
            });

            // Render charts
            if (statsData) {
                renderLineChart('searchChart', statsData.search_volume, 'Searches', 'rgba(0,212,126,0.8)', 'rgba(0,212,126,0.1)');
                renderLineChart('regChart', statsData.registrations, 'Registrations', 'rgba(59,130,246,0.8)', 'rgba(59,130,246,0.1)');
                renderLineChart('adjViewChart', statsData.adjudicator_views, 'Views', 'rgba(168,85,247,0.8)', 'rgba(168,85,247,0.1)');
            }
        } catch (err) {
            section.innerHTML = `<div class="card"><p class="error-text">Error loading overview: ${esc(err.message)}</p></div>`;
        }
    }

    fetchAndRender(currentPeriod);
  }

  function renderLineChart(canvasId, data, label, borderColor, bgColor) {
    const canvas = document.getElementById(canvasId);
    if (!canvas || !data || data.length === 0) {
        if (canvas) canvas.parentElement.innerHTML = '<p style="color:#888;font-size:13px;text-align:center;padding:40px 0;">No data for this period</p>';
        return;
    }
    new Chart(canvas.getContext('2d'), {
        type: 'line',
        data: {
            labels: data.map(d => {
                const date = new Date(d.day + 'T00:00:00');
                return date.toLocaleDateString('en-AU', { day: 'numeric', month: 'short' });
            }),
            datasets: [{
                label,
                data: data.map(d => d.count),
                borderColor,
                backgroundColor: bgColor,
                fill: true,
                tension: 0.3,
                pointRadius: data.length > 60 ? 0 : 3,
                pointHoverRadius: 5,
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: '#1a1a1a',
                    titleFont: { family: 'Inter', size: 12 },
                    bodyFont: { family: 'Inter', size: 12 },
                    padding: 10,
                    cornerRadius: 8
                }
            },
            scales: {
                x: { grid: { display: false }, ticks: { font: { family: 'Inter', size: 11 }, color: '#888', maxTicksLimit: 12 } },
                y: { beginAtZero: true, grid: { color: '#f0f0f0' }, ticks: { font: { family: 'Inter', size: 11 }, color: '#888', precision: 0 } }
            },
            interaction: { mode: 'nearest', axis: 'x', intersect: false }
        }
    });
  }

  // ─── Search Gate ─────────────────────────────────────────
  async function loadGate() {
    const section = document.getElementById('tab-gate');
    section.innerHTML = '<div class="card"><p class="loading">Loading gate status...</p></div>';

    try {
      const res = await fetch('/admin/search-gate', { headers: authHeaders() });
      if (!res.ok) throw new Error(`Failed (${res.status})`);
      const data = await res.json();
      const isOn = data.gate_enabled;

      section.innerHTML = `
        <div class="card">
          <h2>Search Gate Control</h2>
          <p class="card-desc">Master switch for the search gating system. When enabled, users must be logged in and are limited to 10 free searches per month. Full-access users and admins are exempt.</p>
          <div class="gate-box ${isOn ? 'gate-on' : 'gate-off'}">
            <div class="gate-info">
              <strong>Search Gate is ${isOn ? 'ON' : 'OFF'}</strong>
              <p>${isOn ? 'Users must log in to search. Free tier limited to 10 searches/month.' : 'Search is open to everyone with no limits.'}</p>
            </div>
            <button class="btn ${isOn ? 'btn-danger' : 'btn-primary'}" id="gateToggleBtn">${isOn ? 'Disable Gate' : 'Enable Gate'}</button>
          </div>
          <div id="gateFeedback" class="inline-feedback" style="margin-top: 12px;"></div>
        </div>`;

      document.getElementById('gateToggleBtn').addEventListener('click', async () => {
        const newState = !isOn;
        const msg = newState
          ? 'ENABLE the search gate? Users will need to log in to search.'
          : 'DISABLE the search gate? Search will be open to everyone.';
        if (!confirm(msg)) return;

        const fd = new FormData();
        fd.append('enabled', newState);
        const r = await fetch('/admin/search-gate', { method: 'POST', headers: authHeaders(), body: fd });
        const result = await r.json();
        document.getElementById('gateFeedback').textContent = result.message || 'Done.';
        document.getElementById('gateFeedback').className = 'inline-feedback ok';

        loadedTabs.delete('gate');
        setTimeout(() => loadGate(), 500);
      });
    } catch (err) {
      section.innerHTML = `<div class="card"><h2>Search Gate Control</h2><p class="error-text">${esc(err.message)}</p></div>`;
    }
  }

  // ─── Users Tab (with search) ─────────────────────────────
  async function loadUsersTab() {
    const section = document.getElementById('tab-users');
    section.innerHTML = `
      <div class="card">
        <h2>User Accounts</h2>
        <div class="search-bar">
          <input type="text" id="userSearchInput" placeholder="Search by email, name, or firm...">
          <button class="btn btn-primary" id="userSearchBtn">Search</button>
        </div>
        <div id="usersTableWrap"><p class="loading">Loading users...</p></div>
      </div>`;

    // Initial load
    await fetchAndRenderUsers('');

    document.getElementById('userSearchBtn').addEventListener('click', () => {
      const q = document.getElementById('userSearchInput').value.trim();
      fetchAndRenderUsers(q);
    });
    document.getElementById('userSearchInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        const q = document.getElementById('userSearchInput').value.trim();
        fetchAndRenderUsers(q);
      }
    });
  }

  async function fetchAndRenderUsers(query) {
    const wrap = document.getElementById('usersTableWrap');
    wrap.innerHTML = '<p class="loading">Loading...</p>';

    try {
      const url = query ? `/admin/users?search=${encodeURIComponent(query)}` : '/admin/all-users';
      const res = await fetch(url, { headers: authHeaders() });
      if (!res.ok) throw new Error(`Failed (${res.status})`);
      const users = await res.json();

      if (!users || users.length === 0) {
        wrap.innerHTML = '<p style="color: var(--text-muted);">No users found.</p>';
        return;
      }

      wrap.innerHTML = `
        <div class="table-wrap"><table>
          <thead><tr><th>ID</th><th>Email</th><th>Name</th><th>Firm</th><th>Registered</th><th>Last Login</th></tr></thead>
          <tbody>${users.map(u => `<tr>
            <td>${u.id}</td>
            <td>${esc(u.email)}</td>
            <td>${esc((u.first_name || '') + ' ' + (u.last_name || ''))}</td>
            <td>${esc(u.firm_name)}</td>
            <td>${formatAEST(u.created_at)}</td>
            <td>${u.last_login ? formatAEST(u.last_login) : '<span style="color:var(--text-muted)">Never</span>'}</td>
          </tr>`).join('')}</tbody>
        </table></div>`;
    } catch (err) {
      wrap.innerHTML = `<p class="error-text">${esc(err.message)}</p>`;
    }
  }

  // ─── Generic Table Loader ────────────────────────────────
  async function loadTable(url, sectionId, title, renderer) {
    const section = document.getElementById(sectionId);
    section.innerHTML = `<div class="card"><h2>${title}</h2><p class="loading">Loading...</p></div>`;

    try {
      const res = await fetch(url, { headers: authHeaders() });
      if (!res.ok) throw new Error(`Failed (${res.status})`);
      const data = await res.json();
      renderer(data, section, title);
    } catch (err) {
      section.innerHTML = `<div class="card"><h2>${title}</h2><p class="error-text">${esc(err.message)}</p></div>`;
    }
  }

  function renderSearchesTable(searches, section, title) {
    if (!searches || searches.length === 0) {
      section.innerHTML = `<div class="card"><h2>${title}</h2><p style="color:var(--text-muted);">No search activity logged yet.</p></div>`;
      return;
    }
    section.innerHTML = `
      <div class="card">
        <h2>${title}</h2>
        <div class="table-wrap"><table>
          <thead><tr><th>Timestamp</th><th>User Email</th><th>Query</th><th>Blocked</th></tr></thead>
          <tbody>${searches.map(s => `<tr>
            <td>${formatAEST(s.timestamp)}</td>
            <td>${esc(s.user_email) || '<span style="color:var(--text-muted)">Anonymous</span>'}</td>
            <td>${esc(s.search_query)}</td>
            <td>${s.was_blocked ? '<span class="badge badge-red">Yes</span>' : '<span class="badge badge-green">No</span>'}</td>
          </tr>`).join('')}</tbody>
        </table></div>
      </div>`;
  }

  function renderAdjudicatorsTable(views, section, title) {
    if (!views || views.length === 0) {
      section.innerHTML = `<div class="card"><h2>${title}</h2><p style="color:var(--text-muted);">No adjudicator views logged yet.</p></div>`;
      return;
    }
    section.innerHTML = `
      <div class="card">
        <h2>${title}</h2>
        <div class="table-wrap"><table>
          <thead><tr><th>Timestamp</th><th>User Email</th><th>Adjudicator</th></tr></thead>
          <tbody>${views.map(v => `<tr>
            <td>${formatAEST(v.timestamp)}</td>
            <td>${esc(v.user_email) || '<span style="color:var(--text-muted)">Anonymous</span>'}</td>
            <td>${esc(v.adjudicator_name)}</td>
          </tr>`).join('')}</tbody>
        </table></div>
      </div>`;
  }

  function renderSubscriptionsTable(subs, section, title) {
    if (!subs || subs.length === 0) {
      section.innerHTML = `<div class="card"><h2>${title}</h2><p style="color:var(--text-muted);">No subscriptions yet.</p></div>`;
      return;
    }
    const statusBadge = (s) => {
      const map = { active: 'badge-green', cancelled: 'badge-yellow', past_due: 'badge-red', expired: 'badge-gray' };
      return `<span class="badge ${map[s] || 'badge-gray'}">${esc(s)}</span>`;
    };
    section.innerHTML = `
      <div class="card">
        <h2>${title}</h2>
        <div class="table-wrap"><table>
          <thead><tr><th>ID</th><th>Email</th><th>Plan</th><th>Payment</th><th>Status</th><th>Period End</th><th>Created</th></tr></thead>
          <tbody>${subs.map(s => `<tr>
            <td>${s.id}</td>
            <td>${esc(s.user_email)}</td>
            <td>${esc(s.plan_type)}</td>
            <td>${esc(s.payment_method)}</td>
            <td>${statusBadge(s.status)}</td>
            <td>${s.current_period_end ? formatAEST(s.current_period_end) : ''}</td>
            <td>${formatAEST(s.created_at)}</td>
          </tr>`).join('')}</tbody>
        </table></div>
      </div>`;
  }

  // ─── Full Access ─────────────────────────────────────────
  async function loadFullAccess() {
    const section = document.getElementById('tab-fullaccess');
    section.innerHTML = '<div class="card"><p class="loading">Loading...</p></div>';

    try {
      const res = await fetch('/admin/full-access-users', { headers: authHeaders() });
      if (!res.ok) throw new Error(`Failed (${res.status})`);
      const users = await res.json();

      let rows = '';
      if (users && users.length > 0) {
        rows = users.map(u => `<tr>
          <td>${esc(u.email)}</td>
          <td>${formatAEST(u.added_at)}</td>
          <td><button class="btn btn-danger btn-sm fa-remove-btn" data-email="${esc(u.email)}">Remove</button></td>
        </tr>`).join('');
      } else {
        rows = '<tr><td colspan="3" style="text-align:center; color:var(--text-muted); padding:20px;">No users currently have full access.</td></tr>';
      }

      section.innerHTML = `
        <div class="card">
          <h2>Manage Full Access Privileges</h2>
          <p class="card-desc">Users added here will have free access to all adjudicator insights.</p>
          <div id="faFeedback" class="inline-feedback"></div>
          <div class="inline-form">
            <input type="email" id="faEmailInput" placeholder="Enter user's email address">
            <button class="btn btn-primary" id="faAddBtn">Add User</button>
          </div>
          <div class="table-wrap"><table>
            <thead><tr><th>Email</th><th>Date Added</th><th>Action</th></tr></thead>
            <tbody>${rows}</tbody>
          </table></div>
        </div>`;

      document.getElementById('faAddBtn').addEventListener('click', handleAddFullAccess);
      document.querySelectorAll('.fa-remove-btn').forEach(btn => {
        btn.addEventListener('click', () => handleRemoveFullAccess(btn.dataset.email));
      });
    } catch (err) {
      section.innerHTML = `<div class="card"><h2>Full Access Privileges</h2><p class="error-text">${esc(err.message)}</p></div>`;
    }
  }

  async function handleAddFullAccess() {
    const input = document.getElementById('faEmailInput');
    const email = input.value.trim();
    if (!email) return;
    const fb = document.getElementById('faFeedback');

    const fd = new FormData();
    fd.append('email', email);
    try {
      const res = await fetch('/admin/add-full-access', { method: 'POST', headers: authHeaders(), body: fd });
      const data = await res.json();
      fb.textContent = data.detail || data.message || 'Done.';
      fb.className = res.ok ? 'inline-feedback ok' : 'inline-feedback err';
      if (res.ok) {
        input.value = '';
        loadedTabs.delete('fullaccess');
        loadFullAccess();
      }
    } catch (err) {
      fb.textContent = err.message;
      fb.className = 'inline-feedback err';
    }
  }

  async function handleRemoveFullAccess(email) {
    if (!confirm(`Revoke full access for ${email}?`)) return;
    const fd = new FormData();
    fd.append('email', email);
    await fetch('/admin/remove-full-access', { method: 'POST', headers: authHeaders(), body: fd });
    loadedTabs.delete('fullaccess');
    loadFullAccess();
  }

  // ─── Invoice Requests ────────────────────────────────────
  async function loadInvoiceRequests() {
    const section = document.getElementById('tab-invoicerequests');
    section.innerHTML = '<div class="card"><p class="loading">Loading...</p></div>';

    try {
      const [pendingRes, allRes] = await Promise.all([
        fetch('/admin/invoice-requests?status_filter=pending', { headers: authHeaders() }),
        fetch('/admin/invoice-requests?status_filter=all', { headers: authHeaders() })
      ]);
      if (!pendingRes.ok || !allRes.ok) throw new Error('Failed to fetch invoice requests');
      const pending = await pendingRes.json();
      const all = await allRes.json();

      let html = '<div class="card"><h2>Pending Invoice Requests</h2>';
      if (pending.length === 0) {
        html += '<p style="color:var(--text-muted);">No pending requests.</p>';
      } else {
        html += `<div class="table-wrap"><table>
          <thead><tr><th>ID</th><th>Email</th><th>Firm</th><th>ABN</th><th>Plan</th><th>Accounts Email</th><th>Notes</th><th>Submitted</th><th>Actions</th></tr></thead>
          <tbody>${pending.map(r => `<tr>
            <td>${r.id}</td><td>${esc(r.user_email)}</td><td>${esc(r.firm_name)}</td>
            <td>${esc(r.abn)}</td><td>${esc(r.plan_type)}</td><td>${esc(r.accounts_email)}</td>
            <td>${esc(r.notes)}</td><td>${formatAEST(r.created_at)}</td>
            <td>
              <button class="btn btn-primary btn-sm inv-approve" data-id="${r.id}" style="margin-bottom:4px;">Approve</button>
              <button class="btn btn-danger btn-sm inv-reject" data-id="${r.id}">Reject</button>
            </td>
          </tr>`).join('')}</tbody>
        </table></div>`;
      }
      html += '</div>';

      html += '<div class="card"><h2>All Requests</h2>';
      if (all.length === 0) {
        html += '<p style="color:var(--text-muted);">No requests yet.</p>';
      } else {
        const statusBadge = (s) => {
          const map = { approved: 'badge-green', rejected: 'badge-red', pending: 'badge-yellow' };
          return `<span class="badge ${map[s] || 'badge-gray'}">${esc(s)}</span>`;
        };
        html += `<div class="table-wrap"><table>
          <thead><tr><th>ID</th><th>Email</th><th>Plan</th><th>Status</th><th>Reviewed By</th><th>Reviewed At</th><th>Submitted</th></tr></thead>
          <tbody>${all.map(r => `<tr>
            <td>${r.id}</td><td>${esc(r.user_email)}</td><td>${esc(r.plan_type)}</td>
            <td>${statusBadge(r.status)}</td>
            <td>${esc(r.reviewed_by)}</td><td>${r.reviewed_at ? formatAEST(r.reviewed_at) : ''}</td>
            <td>${formatAEST(r.created_at)}</td>
          </tr>`).join('')}</tbody>
        </table></div>`;
      }
      html += '</div>';

      section.innerHTML = html;

      // Bind action buttons
      section.querySelectorAll('.inv-approve').forEach(btn => {
        btn.addEventListener('click', () => handleApproveInvoice(btn.dataset.id));
      });
      section.querySelectorAll('.inv-reject').forEach(btn => {
        btn.addEventListener('click', () => handleRejectInvoice(btn.dataset.id));
      });
    } catch (err) {
      section.innerHTML = `<div class="card"><h2>Invoice Requests</h2><p class="error-text">${esc(err.message)}</p></div>`;
    }
  }

  async function handleApproveInvoice(id) {
    if (!confirm('Approve this invoice request? This will create an active subscription.')) return;
    try {
      const res = await fetch(`/admin/approve-invoice-request/${id}`, { method: 'POST', headers: authHeaders() });
      const data = await res.json();
      if (!res.ok) throw new Error(data.detail || 'Approval failed');
      alert(data.message);
      loadedTabs.delete('invoicerequests');
      loadInvoiceRequests();
    } catch (err) { alert('Error: ' + err.message); }
  }

  async function handleRejectInvoice(id) {
    const notes = prompt('Rejection reason (optional):');
    if (notes === null) return;
    try {
      const fd = new FormData();
      fd.append('admin_notes', notes);
      const res = await fetch(`/admin/reject-invoice-request/${id}`, { method: 'POST', headers: authHeaders(), body: fd });
      const data = await res.json();
      if (!res.ok) throw new Error(data.detail || 'Rejection failed');
      alert(data.message);
      loadedTabs.delete('invoicerequests');
      loadInvoiceRequests();
    } catch (err) { alert('Error: ' + err.message); }
  }

  // ─── Upload Decisions ────────────────────────────────────
  function setupUpload() {
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const metaContainer = document.getElementById('metaContainer');
    const metaBody = document.getElementById('metaBody');
    const saveAllBtn = document.getElementById('saveAllBtn');

    dropZone.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(ev => {
      dropZone.addEventListener(ev, (e) => { e.preventDefault(); e.stopPropagation(); }, false);
    });
    ['dragenter', 'dragover'].forEach(ev => {
      dropZone.addEventListener(ev, () => dropZone.classList.add('dragover'), false);
    });
    ['dragleave', 'drop'].forEach(ev => {
      dropZone.addEventListener(ev, () => dropZone.classList.remove('dragover'), false);
    });
    dropZone.addEventListener('drop', (e) => handleFiles(e.dataTransfer.files), false);
    saveAllBtn.addEventListener('click', handleSaveAll);

    function handleFiles(files) {
      if (!files) return;
      metaContainer.style.display = '';
      [...files].forEach(file => {
        if (file.type === 'application/pdf') {
          const rowId = `row-${Date.now()}-${Math.random().toString(36).slice(2)}`;
          filesStore.set(rowId, file);
          addRow(file, rowId);
        }
      });
    }

    function addRow(file, rowId) {
      const tr = document.createElement('tr');
      tr.id = rowId;
      tr.innerHTML = `
        <td>${esc(file.name)}</td>
        <td class="status-cell status-pending">Pending</td>
        <td><input type="text" name="ejs_id" required></td>
        <td><input type="text" name="reference" required></td>
        <td><input type="text" name="decision_date" required></td>
        <td><input type="date" name="decision_date_norm" required></td>
        <td><input type="text" name="adjudicator" required></td>
        <td><input type="text" name="claimant" required></td>
        <td><input type="text" name="respondent" required></td>
        <td><input type="number" step="0.01" name="claimed_amount" required></td>
        <td><input type="number" step="0.01" name="adjudicated_amount" required></td>
        <td><input type="number" step="0.01" name="fee_claimant_proportion" placeholder="e.g. 50"></td>
        <td><input type="number" step="0.01" name="fee_respondent_proportion" placeholder="e.g. 50"></td>
        <td>
          <button class="btn btn-primary btn-sm save-row-btn" style="margin-bottom:4px;">Save</button>
          <button class="btn btn-danger btn-sm remove-row-btn">Remove</button>
        </td>`;
      metaBody.appendChild(tr);

      tr.querySelector('.save-row-btn').addEventListener('click', () => saveRow(rowId));
      tr.querySelector('.remove-row-btn').addEventListener('click', () => {
        document.getElementById(rowId)?.remove();
        filesStore.delete(rowId);
      });
    }

    async function saveRow(rowId) {
      const row = document.getElementById(rowId);
      if (!row) return;
      const statusCell = row.querySelector('.status-cell');
      const saveBtn = row.querySelector('.save-row-btn');
      const inputs = row.querySelectorAll('input');

      let valid = true;
      inputs.forEach(inp => {
        if (inp.required && !inp.value) {
          inp.style.borderColor = '#ef4444';
          valid = false;
        } else {
          inp.style.borderColor = '';
        }
      });
      if (!valid) {
        statusCell.className = 'status-cell status-error';
        statusCell.textContent = 'Missing fields';
        return;
      }

      statusCell.className = 'status-cell status-saving';
      statusCell.textContent = 'Saving...';
      saveBtn.disabled = true;

      const fd = new FormData();
      fd.append('pdf_file', filesStore.get(rowId));
      const fields = [
        'ejs_id', 'reference', 'decision_date', 'decision_date_norm', 'act',
        'adjudicator', 'claimant', 'respondent', 'claimed_amount', 'adjudicated_amount',
        'payment_schedule_amount', 'fee_claimant_proportion', 'fee_respondent_proportion',
        'project_type', 'contract_type', 'outcome'
      ];
      fields.forEach(f => {
        if (f === 'act') { fd.append(f, 'BIF Act'); return; }
        const inp = row.querySelector(`[name="${f}"]`);
        fd.append(f, inp ? inp.value : '');
      });

      try {
        const res = await fetch('/admin/upload-decision', { method: 'POST', headers: authHeaders(), body: fd });
        const result = await res.json();
        if (!res.ok) throw new Error(result.detail || 'Upload failed');
        statusCell.className = 'status-cell status-success';
        statusCell.textContent = 'Success';
        inputs.forEach(inp => inp.disabled = true);
        row.querySelector('.remove-row-btn').style.display = 'none';
        saveBtn.style.display = 'none';
      } catch (err) {
        statusCell.className = 'status-cell status-error';
        statusCell.textContent = `Error: ${err.message}`;
        saveBtn.disabled = false;
      }
    }

    function handleSaveAll() {
      const pending = document.querySelectorAll('.status-pending');
      const fb = document.getElementById('saveAllFeedback');
      if (pending.length === 0) {
        fb.textContent = 'No pending uploads.';
        fb.className = 'inline-feedback err';
        return;
      }
      fb.textContent = '';
      pending.forEach(cell => {
        const row = cell.closest('tr');
        row?.querySelector('.save-row-btn')?.click();
      });
    }
  }

  // ─── Backups ─────────────────────────────────────────────
  function setupBackups() {
    document.getElementById('saveDbBtn').addEventListener('click', async () => {
      const btn = document.getElementById('saveDbBtn');
      const fb = document.getElementById('saveDbFeedback');
      if (!confirm('Save the current database to the cloud? This will overwrite the existing file.')) return;

      btn.disabled = true;
      btn.textContent = 'Saving...';
      fb.className = 'action-feedback show info';
      fb.textContent = 'Uploading database to Google Cloud Storage...';

      try {
        const res = await fetch('/admin/save-database', { method: 'POST', headers: authHeaders() });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || 'Failed');
        fb.className = 'action-feedback show ok';
        fb.textContent = data.message;
      } catch (err) {
        fb.className = 'action-feedback show err';
        fb.textContent = 'Error: ' + err.message;
      } finally {
        btn.disabled = false;
        btn.textContent = 'Save Database';
      }
    });

    document.getElementById('backupBtn').addEventListener('click', async () => {
      const btn = document.getElementById('backupBtn');
      const fb = document.getElementById('backupFeedback');
      if (!confirm('Create a new Meilisearch backup?')) return;

      btn.disabled = true;
      btn.textContent = 'Backup in Progress...';
      fb.className = 'action-feedback show info';
      fb.textContent = 'Starting snapshot... This may take several minutes.';

      try {
        const res = await fetch('/admin/create-meilisearch-backup', { method: 'POST', headers: authHeaders() });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || 'Failed');
        fb.className = 'action-feedback show ok';
        fb.textContent = data.message;
      } catch (err) {
        fb.className = 'action-feedback show err';
        fb.textContent = 'Error: ' + err.message;
      } finally {
        btn.disabled = false;
        btn.textContent = 'Create New Backup';
      }
    });
  }

  // ─── Boot ────────────────────────────────────────────────
  init();

});
</script>
<script src="/new-test/assets/js/main.js"></script>
</body>
</html>
